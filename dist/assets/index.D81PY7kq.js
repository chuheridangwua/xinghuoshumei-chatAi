import{g as W,h as U,j as w,k as P,l as V,c as f,m,a as z,n as _,w as O,u as R,U as b,t as u,P as q,p as N,F as J,q as G,B as F,o as x,s as B}from"./vendor.CamtBdHc.js";import{_ as H}from"./index.lMMP7HIl.js";let y=null;function K(){if(!y){const o=new URL("/assets/excelWorker.WIqPgALt.js",import.meta.url);y=new Worker(o,{type:"module"})}return y}const Q=(o,d={},r=null)=>new Promise((v,h)=>{if(!/\.(xlsx|xls)$/i.test(o.name)){h(new Error("只能上传Excel文件(.xlsx, .xls格式)"));return}const n=K(),s=e=>{const a=e.data;switch(a.type){case"start":r&&r({phase:"start",progress:0});break;case"sheetInfo":r&&r({phase:"sheetInfo",progress:10,sheetNames:a.sheetNames,totalSheets:a.totalSheets});break;case"progress":r&&r({phase:a.phase,progress:a.progress});break;case"sheetProcessed":r&&r({phase:"sheetProcessed",progress:a.progress,sheetName:a.sheetName,totalRows:a.totalRows,blockCount:a.blockCount});break;case"complete":n.removeEventListener("message",s),v(a.result);break;case"error":n.removeEventListener("message",s),h(new Error(a.message));break}};n.addEventListener("message",s),n.postMessage({action:"parse",file:o,options:{maxBlocks:d.maxBlocks||100,minBlockSize:d.minBlockSize||1e3,overlapRows:d.overlapRows||10}})}),X=(o,d=null)=>o.size<10*1024*1024?Y(o):Q(o,{},d),Y=o=>new Promise((d,r)=>{if(!/\.(xlsx|xls)$/i.test(o.name)){r(new Error("只能上传Excel文件(.xlsx, .xls格式)"));return}const h=new FileReader;h.onload=async g=>{var n,s;try{const e=new W.Workbook,a=g.target.result;await e.xlsx.load(a);const t={},p=e.worksheets.map($=>$.name);e.worksheets.forEach($=>{const S=$.name,E=Z($);t[S]=E});const k={fileName:o.name,sheets:t,totalSheets:p.length,sheetNames:p,data:t[p[0]]||[],totalRows:((n=t[p[0]])==null?void 0:n.length)||0,columns:((s=t[p[0]])==null?void 0:s.length)>0?Object.keys(t[p[0]][0]||{}):[]};d(k)}catch(e){r(new Error(`解析Excel文件失败: ${e.message}`))}},h.onerror=()=>{r(new Error("读取文件时发生错误"))},h.readAsArrayBuffer(o)});function Z(o){const d=o.getRow(1),r=[];d.eachCell({includeEmpty:!1},(h,g)=>{var n;r[g-1]=((n=h.value)==null?void 0:n.toString())||`Column${g}`});const v=[];return o.eachRow({includeEmpty:!1},(h,g)=>{if(g===1)return;const n={};h.eachCell({includeEmpty:!0},(s,e)=>{const a=r[e-1]||`Column${e}`;let t=null;s.value!==null&&s.value!==void 0&&(s.value.text?t=s.value.text:s.value.formula?t=s.value.result:s.type===W.ValueType.Date?t=s.value.toISOString():t=s.value),n[a]=t}),v.push(n)}),v}const A=(o,d={})=>{if(!o||!Array.isArray(o))return[];const r=o.length,v=d.maxBlocks||100,h=d.minBlockSize||1e3,g=d.overlapRows||10,n=Math.max(h,Math.ceil(r/v)),s=Math.min(v,Math.ceil(r/n)),e=Math.ceil(r/s),a=[];for(let t=0;t<s;t++){const p=t*e,k=Math.min(r-1,(t+1)*e-1),$=Math.max(0,p-(t>0?g:0)),S=Math.min(r-1,k+(t<s-1?g:0)),E=o.slice($,S+1);a.push({blockId:t,originalStartIndex:p,originalEndIndex:k,startIndex:$,endIndex:S,size:E.length,originalSize:k-p+1,hasOverlapTop:t>0,hasOverlapBottom:t<s-1,data:E})}return a},D=(o,d={})=>{const{showAllSheets:r=!1,verbose:v=!0,useBlocks:h=!0,blockOptions:g={maxBlocks:100,minBlockSize:1e3,overlapRows:10}}=d;console.group(`===== Excel文件 "${o.fileName}" 数据 =====`),console.log(`文件名: ${o.fileName}`),console.log(`工作表数量: ${o.totalSheets}`),console.log(`工作表列表: ${o.sheetNames.join(", ")}`),v&&(console.log(`默认工作表(${o.sheetNames[0]})列名:`,o.columns),console.log(`默认工作表(${o.sheetNames[0]})行数: ${o.totalRows}`));const n=o.data;if(o.blocks&&o.blocks.length>0)console.log(`数据已分为 ${o.blocks.length} 个数据块 (Worker处理)`),o.blocks.slice(0,5).forEach(s=>{console.group(`数据块 #${s.blockId+1} (${s.size}行, 原始${s.originalSize}行)`),console.log(`索引范围: ${s.startIndex} - ${s.endIndex} (原始: ${s.originalStartIndex} - ${s.originalEndIndex})`),s.hasOverlapTop&&console.log(`上方重叠区: ${s.startIndex} - ${s.originalStartIndex-1} (${s.originalStartIndex-s.startIndex}行)`),s.hasOverlapBottom&&console.log(`下方重叠区: ${s.originalEndIndex+1} - ${s.endIndex} (${s.endIndex-s.originalEndIndex}行)`),s.sampleData&&s.sampleData.length>0&&(console.log("数据块内容示例:"),console.table(s.sampleData)),console.groupEnd()}),o.blocks.length>5&&console.log(`... 还有 ${o.blocks.length-5} 个数据块 ...`);else if(h&&n&&n.length>0){const s=A(n,g);console.log(`数据已分为 ${s.length} 个数据块:`),s.slice(0,5).forEach(e=>{console.group(`数据块 #${e.blockId+1} (${e.size}行, 原始${e.originalSize}行)`),console.log(`索引范围: ${e.startIndex} - ${e.endIndex} (原始: ${e.originalStartIndex} - ${e.originalEndIndex})`),e.hasOverlapTop&&console.log(`上方重叠区: ${e.startIndex} - ${e.originalStartIndex-1} (${e.originalStartIndex-e.startIndex}行)`),e.hasOverlapBottom&&console.log(`下方重叠区: ${e.originalEndIndex+1} - ${e.endIndex} (${e.endIndex-e.originalEndIndex}行)`),console.log("数据块内容示例 (前5行):"),console.table(e.data.slice(0,5)),e.data.length>10?(console.log(`... 中间省略 ${e.data.length-10} 行 ...`),console.log("数据块内容示例 (后5行):"),console.table(e.data.slice(-5))):e.data.length>5&&(console.log(`数据块内容示例 (后${e.data.length-5}行):`),console.table(e.data.slice(5))),console.groupEnd()}),s.length>5&&console.log(`... 还有 ${s.length-5} 个数据块 ...`)}else n&&n.length>0?(console.log(`默认工作表(${o.sheetNames[0]})数据:`),console.table(n.slice(0,100))):console.log("默认工作表没有数据或数据未加载");return r&&o.totalSheets>1&&o.sheetNames.slice(1).forEach(s=>{if(console.group(`工作表: ${s}`),o.sheets&&o.sheets[s]){const e=o.sheets[s],a=Array.isArray(e)?e.length:e.totalRows||0;if(console.log(`行数: ${a}`),a>0){if(v){const t=Array.isArray(e)&&e.length>0?Object.keys(e[0]):[];console.log("列名:",t)}if(e.blocks&&e.blocks.length>0)console.log(`此工作表已分为 ${e.blocks.length} 个数据块`),e.blocks[0].sampleData&&(console.log("第一个数据块内容示例:"),console.table(e.blocks[0].sampleData));else if(Array.isArray(e)&&e.length>0)if(h&&e.length>g.minBlockSize){console.log("此工作表数据量较大，使用分块显示...");const t=A(e,g);console.log(`已分为 ${t.length} 个数据块`),console.log("第一个数据块内容示例:"),console.table(t[0].data.slice(0,5))}else console.table(e.slice(0,100))}else console.log("此工作表没有数据")}else console.log("此工作表数据未加载");console.groupEnd()}),console.groupEnd(),o},T=()=>{y&&(y.terminate(),y=null)},ee={class:"excel-container"},se={key:0,class:"processing-info"},oe={class:"progress-header"},te={class:"phase-text"},ne={class:"progress-percent"},le={key:0,class:"processing-message"},ae={key:1,class:"file-info"},re={class:"basic-info"},ie={key:0,class:"file-size"},ce={class:"excel-info"},ue={key:0,class:"sheet-list"},de={key:0,class:"blocks-info"},he={class:"blocks-summary"},ge={class:"block-list"},me={class:"block-header"},ve={class:"block-size"},pe={class:"block-range"},fe={key:0,class:"block-overlap"},xe={key:0},$e={key:1},we={key:0,class:"more-blocks"},_e={class:"memory-management"},ke=U({__name:"index",setup(o){const d=w(""),r=w(0),v=w(0),h=w(0),g=w([]),n=w([]),s=w(!1),e=w(0),a=w(""),t=w(""),p={maxBlocks:100,minBlockSize:1e3,overlapRows:10},k=P(()=>n.value.slice(0,5)),$=P(()=>{if(n.value.length===0)return{minBlockSize:0,maxBlockSize:0,avgBlockSize:0};const i=n.value.map(M=>M.size),c=Math.min(...i),l=Math.max(...i),I=Math.round(i.reduce((M,j)=>M+j,0)/i.length);return{minBlockSize:c,maxBlockSize:l,avgBlockSize:I}}),S=i=>{if(i===0)return"0 Bytes";const c=1024,l=["Bytes","KB","MB","GB"],I=Math.floor(Math.log(i)/Math.log(c));return parseFloat((i/Math.pow(c,I)).toFixed(2))+" "+l[I]},E=i=>{switch(e.value=i.progress||0,i.phase){case"start":a.value="开始处理...",t.value="正在准备读取文件";break;case"sheetInfo":a.value="读取文件结构",t.value=`发现 ${i.totalSheets} 个工作表`;break;case"loading":a.value="加载文件内容",t.value="正在读取Excel数据";break;case"parsing":a.value="解析Excel数据",t.value="正在转换为JSON格式";break;case"sheetProcessed":a.value="处理工作表",t.value=`工作表 "${i.sheetName}" 已处理，包含 ${i.totalRows} 行数据，分为 ${i.blockCount} 个数据块`;break;default:a.value="处理中...",t.value=""}},C=async i=>{if(!i||!i.length||!i[0])return;const c=i[0].raw||i[0];if(!c||!(c instanceof File)){B.error("无法获取有效的文件对象");return}if(r.value=c.size,!(c.size>100*1024*1024&&!window.confirm(`文件大小为 ${S(c.size)}，处理可能需要较长时间，确定继续吗？`))){s.value=!0,e.value=0,a.value="准备处理...",t.value="";try{const l=await X(c,E);d.value=l.fileName,v.value=l.totalRows,h.value=l.totalSheets,g.value=l.sheetNames,l.blocks?n.value=l.blocks:l.data&&l.data.length>0?n.value=A(l.data,p):n.value=[],D(l,{showAllSheets:!0,useBlocks:!0,blockOptions:p}),B.success(`文件 "${c.name}" 已成功解析，共 ${l.totalRows} 条数据，分为 ${n.value.length} 个数据块`),c.size>50*1024*1024&&setTimeout(()=>{B.info('提示：处理完成后，您可以点击"清理内存"按钮释放资源')},2e3)}catch(l){B.error(l.message||"解析Excel文件失败"),console.error("解析Excel文件出错:",l)}finally{s.value=!1}}},L=()=>{try{n.value=[],T(),window.gc&&window.gc(),B.success("内存已清理")}catch(i){B.error("内存清理失败"),console.error("内存清理错误:",i)}};return V(()=>{T()}),(i,c)=>(x(),f("div",ee,[c[4]||(c[4]=m("h1",null,"Excel文件上传与内容展示",-1)),z(R(b),{accept:".xlsx, .xls","auto-upload":!1,onChange:C,theme:"file",multiple:!1,draggable:"",disabled:s.value},{default:O(()=>[z(R(F),{theme:"primary",loading:s.value},{default:O(()=>[N(u(s.value?"正在处理...":"点击或拖拽上传Excel文件"),1)]),_:1},8,["loading"])]),_:1},8,["disabled"]),s.value?(x(),f("div",se,[m("div",oe,[m("span",te,u(a.value),1),m("span",ne,u(e.value)+"%",1)]),z(R(q),{percentage:e.value,color:{from:"#108ee9",to:"#87d068"}},null,8,["percentage"]),t.value?(x(),f("div",le,u(t.value),1)):_("",!0)])):_("",!0),d.value?(x(),f("div",ae,[m("div",re,[c[0]||(c[0]=m("strong",null,"文件名:",-1)),N(" "+u(d.value)+" ",1),r.value?(x(),f("span",ie,"("+u(S(r.value))+")",1)):_("",!0)]),m("div",ce,[m("div",null,"已解析 "+u(v.value)+" 条数据，共 "+u(h.value)+" 个工作表",1),g.value.length>0?(x(),f("div",ue,[c[1]||(c[1]=m("strong",null,"工作表:",-1)),N(" "+u(g.value.join(", ")),1)])):_("",!0)]),n.value.length>0?(x(),f("div",de,[m("h3",null,"数据分块信息 ("+u(n.value.length)+"块)",1),m("div",he," 每块大小: 约"+u($.value.avgBlockSize)+"行 (最小: "+u($.value.minBlockSize)+"行, 最大: "+u($.value.maxBlockSize)+"行) ",1),m("div",ge,[(x(!0),f(J,null,G(k.value,(l,I)=>(x(),f("div",{key:I,class:"block-item"},[m("div",me,[m("strong",null,"块 #"+u(l.blockId+1),1),m("span",ve,u(l.size)+"行",1)]),m("div",pe," 索引范围: "+u(l.startIndex)+" - "+u(l.endIndex),1),l.hasOverlapTop||l.hasOverlapBottom?(x(),f("div",fe,[l.hasOverlapTop?(x(),f("div",xe," 上方重叠: "+u(l.originalStartIndex-l.startIndex)+"行 ",1)):_("",!0),l.hasOverlapBottom?(x(),f("div",$e," 下方重叠: "+u(l.endIndex-l.originalEndIndex)+"行 ",1)):_("",!0)])):_("",!0)]))),128)),n.value.length>k.value.length?(x(),f("div",we," ... 还有 "+u(n.value.length-k.value.length)+" 个数据块 ... ",1)):_("",!0)])])):_("",!0),m("div",_e,[z(R(F),{theme:"default",size:"small",onClick:L,disabled:s.value},{default:O(()=>c[2]||(c[2]=[N(" 清理内存 ")])),_:1},8,["disabled"]),c[3]||(c[3]=m("span",{class:"tip"},"上传大文件后可点击此按钮释放内存",-1))])])):_("",!0)]))}}),Ie=H(ke,[["__scopeId","data-v-072d30f3"]]);export{Ie as default};
//# sourceMappingURL=index.D81PY7kq.js.map
