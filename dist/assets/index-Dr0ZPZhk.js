const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/workflow-KpFAiLq0.js","assets/index-wlcSVvoI.js","assets/index-wcChcfBI.css"])))=>i.map(i=>d[i]);
import{D as yt,d as oe,g as S,m as Q,u as K,q as C,F as te,A as ae,E as O,v as R,e as g,G as L,y as X,x as ge,B as Pe,H as At,P as wt,M as ee,C as A,c as ce,a as Ce,I as ie,J as Ct,_ as me,K as le,L as bt,N as St,O as kt,f as Oe,Q as _t,z as Je,R as Ge,S as Tt,h as xt,n as Rt}from"./index-wlcSVvoI.js";const z={baseURL:"/api/v1",workflowApiKey:"app-6aRhLAp4zAppCJus5ViMgOsh",datasetApiKey:"dataset-NU4Kg7Wtm1616AOnxnRAeFct",models:[{id:"DeepSeek-V3",name:"星火智学(DeepSeek-V3)",apiKey:"app-mJY5qTsLUXT3jLAKgfNrTbxP"},{id:"DeepSeek-R1",name:"星火深思(DeepSeek-R1)",apiKey:"app-2PAC8Jw4d0UxjZzFXL0nXRUa"}],defaultModel:"DeepSeek-V3",apiKey:"app-mJY5qTsLUXT3jLAKgfNrTbxP"},be=(e,n)=>{const a=`${z.baseURL}${e}`;return a.startsWith("http://")||a.startsWith("https://")?new URL(a):new URL(a,window.location.origin)},Qe=e=>{const n=z.models.find(t=>t.id===e);return n?(z.currentModel=e,z.apiKey=n.apiKey,console.log("已切换模型:",n.name),z):(console.error("未找到指定的模型:",e),null)},ue=()=>{const n=new URLSearchParams(window.location.search).get("userId");if(n)return localStorage.setItem("dify_user_id",n),n;let t=localStorage.getItem("dify_user_id");return t||(t="user_"+Math.random().toString(36).substring(2,15),localStorage.setItem("dify_user_id",t)),t},fe=async(e={})=>{try{const n=ue(),t=be("/conversations");t.searchParams.append("user",n),e.last_id&&t.searchParams.append("last_id",e.last_id),e.limit&&t.searchParams.append("limit",e.limit),e.sort_by&&t.searchParams.append("sort_by",e.sort_by);const a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z.apiKey}`}});if(!a.ok){const o=await a.text();throw new Error(`获取会话列表失败: ${a.status} ${o}`)}const s=await a.json();return s&&Array.isArray(s.data)&&s.data.sort((o,r)=>{const i=new Date(o.created_at||0);return new Date(r.created_at||0)-i}),s.data||[]}catch(n){return console.error("获取会话列表失败:",n),[]}},It=e=>{if(!e)return{content:"",reasoning:""};const n="<think>",t="</think>";let a="",s=e;if(e.includes(n)&&e.includes(t))try{const o=e.match(/<think>([\s\S]*?)<\/think>/);o&&o[1]&&(a=o[1].trim()),s=e.replace(/<think>[\s\S]*?<\/think>/,"").trim()}catch(o){console.error("提取思考内容时出错:",o),s=e}return{content:s,reasoning:a}},We=async(e,n={})=>{if(!e)return[];try{const t=ue(),{page:a=1,pageSize:s=20}=n,o=be("/messages");o.searchParams.append("conversation_id",e),o.searchParams.append("user",t),o.searchParams.append("page",a),o.searchParams.append("page_size",s);const r=await fetch(o,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z.apiKey}`},signal:n.signal});if(!r.ok){const l=await r.text();throw new Error(`获取会话历史失败: ${r.status} ${l}`)}const i=await r.json();return i&&i.data&&Array.isArray(i.data)?Mt(i.data,e):[]}catch(t){throw t.name!=="AbortError"&&console.error("获取服务器会话历史失败:",t),t}},Mt=(e,n)=>{const t=[];for(const a of e){if(a.query){const s={avatar:"https://tdesign.gtimg.com/site/avatar.jpg",name:"自己",datetime:new Date(a.created_at*1e3).toLocaleString(),content:a.query,role:"user",id:a.id+"_user"};a.files&&Array.isArray(a.files)&&a.files.length>0&&(s.files=a.files.map(o=>({id:o.id,filename:o.filename||o.name,type:o.type||"document",size:o.size||0,url:o.url||""}))),a.message_files&&Array.isArray(a.message_files)&&a.message_files.length>0&&(s.files||(s.files=[]),a.message_files.forEach(o=>{s.files.push({id:o.id,filename:o.filename||o.name,type:o.type||"document",size:o.size||0,url:o.url||""})})),t.push(s)}if(a.answer){const{content:s,reasoning:o}=It(a.answer),r={avatar:"/static/files/favicon.jpg",name:"星火数媒",datetime:new Date(a.created_at*1e3).toLocaleString(),content:s||"",role:"assistant",...o?{reasoning:o}:{},id:a.id+"_assistant"};t.push(r)}}return t.reverse(),t},Lt=(e,n,t,a=10)=>{let s=!1,o=[],r=n;if(!r&&e&&e.length>0){for(let l=0;l<e.length;l++)if(e[l].role==="user"&&e[l].content.trim()!==""){r=e[l].content;break}}let i=new Set;for(let l=e.length-1;l>=0;l--){const v=e[l];if((v.role==="user"||v.role==="assistant"||v.role==="system")&&v.content.trim()!==""){if(v.role==="user"&&v.content===r)continue;v.role==="system"&&(s=!0);const d=`${v.role}:${v.content}`;i.has(d)||(o.push({role:v.role,content:v.content}),i.add(d))}}if(r&&r.trim()!==""){const l=`user:${r}`;i.has(l)||o.push({role:"user",content:r})}return o.length>a&&(o=o.slice(-a)),!s&&t&&o.unshift({role:"system",content:t}),o},je=e=>{e&&e.scrollToBottom({behavior:"smooth"})},Ft=(e,n=[])=>{const t={avatar:"https://tdesign.gtimg.com/site/avatar.jpg",name:"自己",datetime:new Date().toLocaleString(),content:e||"",role:"user"};return n&&Array.isArray(n)&&n.length>0&&(t.files=n.map(a=>({id:a.upload_file_id||a.id,filename:a.filename||a.name||"未命名文件",type:a.type||"document",size:a.size||0,url:a.url||""}))),t},Dt=(e=!1)=>{const n={avatar:"/static/files/favicon.jpg",name:"星火数媒",datetime:new Date().toLocaleString(),content:"",role:"assistant"};return e?{...n,reasoning:"思考中..."}:n},Ut=async(e,n={})=>{try{if(!e)return console.log("会话ID为空，跳过自动重命名"),!1;let t=n.messages||[];t.length||(t=await We(e));const a=t.length,s=Math.floor(a/2),r=(await fe()).find(l=>l.id===e);if((s<=3||s>=5&&s%5===0)&&(!r||!r.name||r.name.startsWith("新对话")||r.name==="New conversation")){console.log("[自动重命名] 需要重命名对话:",e,"当前轮数:",s);try{let l="";const v=[...t].sort((f,x)=>{if(f.datetime&&x.datetime)return f.datetime-x.datetime;if(f.created_at&&x.created_at){const b=typeof f.created_at=="string"?new Date(f.created_at).getTime():f.created_at*1e3,m=typeof x.created_at=="string"?new Date(x.created_at).getTime():x.created_at*1e3;return b-m}return 0}),d=[];let y={user:null,assistant:null};for(const f of v)f.role==="user"?(y.user!==null&&(d.push({...y}),y={user:null,assistant:null}),y.user=f.content):f.role==="assistant"&&(y.assistant!==null&&(d.push({...y}),y={user:null,assistant:null}),y.assistant=f.content);(y.user!==null||y.assistant!==null)&&d.push(y);const w=d.slice(-5);for(let f=0;f<w.length;f++){const x=w[f];l+=`[第${f+1}轮]
`,x.user&&(l+=`用户: ${x.user}
`),x.assistant&&(l+=`助手: ${x.assistant}
`),l+=`
`}if(console.log("[自动重命名] 提取的对话内容:",l.length,"字节"),!l.trim()){console.log("[自动重命名] 消息内容为空，使用默认重命名方式");const f=await se(e,{auto_generate:!0});return f.success||console.warn("[自动重命名] 默认重命名失败:",f.message),f.success}const{generateArticleTitle:B}=await yt(async()=>{const{generateArticleTitle:f}=await import("./workflow-KpFAiLq0.js");return{generateArticleTitle:f}},__vite__mapDeps([0,1,2]));let M=!1,h="";const G=await B(l,{onOutput:async f=>{if(f&&f.text){const x=f.text.trim();if(console.log("[自动重命名] 生成的标题:",x),x){M=!0,h=x;const b=await se(e,{name:x});if(b.success)console.log("[自动重命名] 重命名成功:",x),typeof n.onComplete=="function"&&n.onComplete(x);else{console.error("[自动重命名] 重命名失败:",b.message),console.log("[自动重命名] 尝试使用默认方式重命名");const m=await se(e,{auto_generate:!0});m.success&&typeof n.onComplete=="function"&&n.onComplete(m.name||"")}}}},onError:async f=>{console.error("[自动重命名] 生成标题失败:",f);const x=await se(e,{auto_generate:!0});x.success&&typeof n.onComplete=="function"&&n.onComplete(x.name||"")},onComplete:async f=>{if(f&&!M){console.warn("[自动重命名] 工作流执行成功但未生成标题，使用默认重命名");const x=await se(e,{auto_generate:!0});x.success&&typeof n.onComplete=="function"&&n.onComplete(x.name||"")}}},{responseMode:"streaming",userId:"title-generator"});return M?(console.log("[自动重命名] 标题已生成并应用:",h),!0):G.success?!0:(console.warn("[自动重命名] 生成标题工作流执行失败，使用默认重命名"),(await se(e,{auto_generate:!0})).success)}catch(l){return console.error("[自动重命名] 使用工作流生成标题失败，回退到默认方式:",l),(await se(e,{auto_generate:!0})).success}}return!1}catch(t){return console.error("[自动重命名] 自动重命名失败:",t),!1}},se=async(e,n={})=>{const t=ue();try{const a={user:t};n.auto_generate?a.auto_generate=!0:n.name&&(a.name=n.name),console.log(`[重命名] 尝试重命名会话 ${e}`,{auto_generate:n.auto_generate,name:n.name,API地址:`${z.baseURL}/conversations/${e}/name`});const s=await fetch(`${z.baseURL}/conversations/${e}/name`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z.apiKey}`},body:JSON.stringify(a)}),o=await s.text();let r;try{r=JSON.parse(o)}catch{r=o}return s.ok?(console.log(`[重命名] 会话重命名成功: ${e}`,r),{success:!0,...r}):(console.error(`[重命名] 重命名会话失败: ${s.status}`,r),{success:!1,status:s.status,error:r,message:`重命名会话失败: ${s.status}`})}catch(a){return console.error("[重命名] 重命名会话错误:",a),{success:!1,error:a,message:a.message||"重命名会话失败"}}},Bt=async e=>{const n=ue();try{const t={user:n},a=await fetch(`${z.baseURL}/conversations/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z.apiKey}`},body:JSON.stringify(t)});if(!a.ok){const o=await a.text();throw new Error(`删除会话失败: ${a.status} ${o}`)}return await a.json()}catch(t){throw console.error("删除会话错误:",t),t}},$t=async()=>{try{const e=await fe({limit:1});return e&&e.length>0?e[0].id:""}catch(e){return console.error("获取当前会话失败:",e),""}},Et=async e=>{try{return!0}catch(n){return console.error("清空聊天记录失败:",n),!1}},Pt=async e=>{try{const n=ue(),t=be(`/messages/${e}/suggested`);t.searchParams.append("user",n);const a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z.apiKey}`}});if(!a.ok)throw new Error(`获取建议问题失败: ${a.status}`);const s=await a.json();return s&&s.data&&Array.isArray(s.data)?s.data:[]}catch(n){return console.error("获取建议问题失败:",n),[]}};z.baseURL,z.apiKey;const Qt=async(e,n={})=>{try{const t=ue(),a=be("/chat-messages"),o={query:e[e.length-1].content,user:t,response_mode:"streaming",inputs:{}};n.conversation_id&&(o.conversation_id=n.conversation_id),n.files&&Array.isArray(n.files)&&n.files.length>0&&(o.files=n.files),console.log("[Request] 发送请求:",o);const r=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${z.apiKey}`},body:JSON.stringify(o),signal:n.signal});if(!r.ok)throw new Error(`请求失败: ${r.status}`);return r}catch(t){throw console.error("发送聊天请求失败:",t),t}},jt=async(e,n={})=>{var y,w,B;const{onMessage:t,onError:a,onComplete:s,onReasoning:o,onWorkflowSteps:r,onConversationIdChange:i,onMessageIdChange:l,onTaskIdChange:v,onFileEvent:d}=n;try{if(e.signal&&e.signal.aborted){console.log("[Stream] 请求已中断"),s==null||s(!1,"请求已中断");return}const M=await e;if(!M.ok){const T=await M.text();throw console.error("[Stream] API请求失败:",M.status,T),new Error(`API请求失败: ${M.status} ${T}`)}console.log("[Stream] 开始处理流式响应");const h=M.body.getReader(),G=new TextDecoder;let f="",x=!1,b=null,m=[],k=null;try{for(;;){if(e.signal&&e.signal.aborted){console.log("[Stream] 检测到请求中断信号，停止处理流");break}const{done:T,value:F}=await h.read();if(T){console.log("[Stream] 流读取完成");break}f+=G.decode(F,{stream:!0});const $=f.split(`
`);f=$.pop()||"";for(const P of $)if(!(!P.trim()||!P.startsWith("data: ")))try{const _=JSON.parse(P.substring(6));if(_.conversation_id&&!b&&(b=_.conversation_id,console.log(`%c[Stream] 获取会话ID: ${b}`,"color: #9C27B0; font-weight: bold;"),i&&i(b)),_.event==="message"){const E=_.answer||"";if(E.includes("<think>")){x=!0;const D=E.replace("<think>","");console.log("%c[Stream] 进入思考模式","color: #FF9800; font-weight: bold;"),o==null||o(D)}else if(E.includes("</think>")){const D=E.split("</think>");console.log("%c[Stream] 结束思考模式","color: #FF9800; font-weight: bold;"),o==null||o(D[0]),x=!1,D.length>1&&(t==null||t(D[1]))}else x?o==null||o(E):t==null||t(E)}else if(_.event==="message_end")console.log("%c[Stream] 收到消息结束事件: message_end","color: #4CAF50; font-weight: bold;"),_.message_id&&l&&l(_.message_id),_.task_id&&v&&v(_.task_id);else if(_.event==="message_file"){if(console.log("%c[Stream] 收到文件事件: message_file","color: #4CAF50; font-weight: bold;"),d&&_.file){const E={id:_.file.id,filename:_.file.filename||_.file.name,type:_.file.type||"document",size:_.file.size||0,url:_.file.url||""};d(E)}}else if(_.event==="message_replace")console.log("%c[Stream] 收到消息替换事件: message_replace","color: #4CAF50; font-weight: bold;"),t==null||t(_.answer||"");else if(_.event==="tts_message")console.log("%c[Stream] 收到TTS事件: tts_message","color: #4CAF50; font-weight: bold;");else if(_.event==="tts_message_end")console.log("%c[Stream] 收到TTS结束事件: tts_message_end","color: #4CAF50; font-weight: bold;");else if(_.event==="workflow_started")console.log("%c[Stream] 收到工作流开始事件: workflow_started","color: #4CAF50; font-weight: bold;");else if(_.event==="node_started"){console.log("%c[Stream] 收到节点开始事件: node_started","color: #4CAF50; font-weight: bold;");const E=(y=_.data)==null?void 0:y.title,D=((w=_.data)==null?void 0:w.id)||`node-${m.length}`;if(E){const W=U=>{const I=U.toLowerCase();return I==="开始"?"start":I.includes("http")||I.includes("请求")?"http":I.includes("条件")||I.includes("分支")?"condition":I.includes("时间")?"time":I.includes("搜索")?"search":I.includes("提取")||I.includes("参数")?"extract":I.includes("web")||I.includes("bocha")?"web":I.includes("文件")?"file":I.includes("模型")||I.includes("总结")?"model":I.includes("回复")?"reply":I.includes("错误")?"error":"default"},N=((B=_.data)==null?void 0:B.type)||W(E);if(console.log("%c[Stream Node Started]","color: #2196F3; font-weight: bold;",{title:E,type:N,id:D}),k){const U=m.findIndex(I=>I.id===k);U!==-1&&(m[U].loading=!1,r&&r([...m]))}const V={title:E,node_type:N,id:D,loading:!0};m.push(V),k=D,r&&r([...m])}}else if(_.event==="node_finished"){if(console.log("%c[Stream] 收到节点完成事件: node_finished","color: #4CAF50; font-weight: bold;"),k){const E=m.findIndex(D=>D.id===k);E!==-1&&(m[E].loading=!1,r&&r([...m])),k=null}}else _.event==="workflow_finished"?(console.log("%c[Stream] 收到工作流完成事件: workflow_finished","color: #4CAF50; font-weight: bold;"),m=m.map(E=>({...E,loading:!1})),r&&r([...m]),m=[],k=null):_.event==="error"?(console.error("%c[Stream] 收到错误事件: error","color: #F44336; font-weight: bold;"),a==null||a(_.message||"流处理错误")):_.event==="ping"&&console.log("%c[Stream] 收到ping事件","color: #607D8B; font-style: italic;")}catch(_){console.error("%c[Stream] 解析流数据失败:","color: #F44336; font-weight: bold;",_)}}}catch(T){console.error("%c[Stream] 流处理过程中出错:","color: #F44336; font-weight: bold;",T);const F=T.message||"";if(T.name==="AbortError"||F.includes("aborted")||F.includes("abort")||F.includes("BodyStreamBuffer was aborted")||F.includes("message channel closed")||F.includes("listener indicated an asynchronous response")){console.log("%c[Stream] 请求被中断","color: #FF9800; font-weight: bold;"),s==null||s(!1,"请求处理过程已中断");return}throw T}finally{try{h.releaseLock(),console.log("[Stream] 读取器已释放")}catch(T){console.warn("[Stream] 释放读取锁时出错:",T)}}console.log("[Stream] 流处理完成"),s==null||s(!0)}catch(M){console.error("[Stream] 流式请求错误:",M),M.name==="AbortError"||M.message.includes("aborted")||M.message.includes("BodyStreamBuffer was aborted")?(console.log("[Stream] 请求中断错误"),s==null||s(!1,"请求已中断")):(console.error("[Stream] 请求失败错误"),a==null||a(M.message||"请求失败"),s==null||s(!1,M.message))}},qt=async(e,n={},t={})=>{var a,s,o,r,i,l,v,d,y,w,B,M,h,G;try{const f=t.conversation_id||"",x={...t,conversation_id:f};console.log("[Chat] 开始聊天请求",{conversationId:f,messageCount:e.length,hasSignal:!!t.signal});const b=Qt(e,x);try{return console.log("[Chat] 开始处理流式响应"),await jt(b,n),console.log("[Chat] 流式响应处理成功"),{success:!0}}catch(m){return console.error("[Chat] 流处理过程中出错:",m),m.name==="AbortError"||(a=m.message)!=null&&a.includes("aborted")||(s=m.message)!=null&&s.includes("message channel closed")||(o=m.message)!=null&&o.includes("BodyStreamBuffer was aborted")||(r=m.message)!=null&&r.includes("listener indicated an asynchronous response")?(console.log("[Chat] 流处理被中断"),(i=n.onComplete)==null||i.call(n,!1,"请求已中断"),{success:!1,aborted:!0,error:m}):(console.error("[Chat] 流处理失败:",m.message||"未知错误"),(l=n.onError)==null||l.call(n,m.message||"流处理失败"),(v=n.onComplete)==null||v.call(n,!1,m.message),{success:!1,error:m})}}catch(f){return console.error("[Chat] 聊天请求错误:",f),f.name==="AbortError"||(d=f.message)!=null&&d.includes("aborted")||(y=f.message)!=null&&y.includes("message channel closed")||(w=f.message)!=null&&w.includes("BodyStreamBuffer was aborted")||(B=f.message)!=null&&B.includes("listener indicated an asynchronous response")?(console.log("[Chat] 聊天请求被中断"),(M=n.onComplete)==null||M.call(n,!1,"请求已中断"),{success:!1,aborted:!0,error:f}):(console.error("[Chat] 聊天请求失败:",f.message||"未知错误"),(h=n.onError)==null||h.call(n,f.message||"请求失败"),(G=n.onComplete)==null||G.call(n,!1,f.message),{success:!1,error:f})}},zt=async()=>{try{const e=await fetch("/static/files/prompt-copy.json");if(e.ok){const n=await e.json();return JSON.stringify(n)}else return console.error(`加载系统提示词失败: ${e.status}`),{role:"您是一个助手",tools:{description:""},rules:[]}}catch(e){return console.error("加载系统提示词失败:",e),{role:"您是一个助手",tools:{description:""},rules:[]}}},pe=()=>{try{return!0}catch(e){return console.error("重置会话出错:",e),!1}},Ot={class:"chat-sender"},Jt={key:0,class:"uploaded-files"},Gt={class:"files-scroll-container"},Wt={class:"file-name"},Kt={class:"input-container"},Nt={class:"attach-button-wrapper"},Zt={key:1,class:"loading-container"},qe=2*1024*1024,he=3,Vt=oe({__name:"ChatSender",props:{loading:{type:Boolean,default:!1}},emits:["send","stop"],setup(e,{emit:n}){const t=n,a=S(""),s=S(null),o=S(!1),r=S(0),i=S([]),l=["txt","md","mdx","pdf","html","xlsx","xls","docx","csv","htm","markdown"],v={txt:"document",md:"document",mdx:"document",markdown:"document",pdf:"document",html:"document",htm:"document",xlsx:"document",xls:"document",docx:"document",csv:"document"},d={document:"file-excel",default:"file"},y=k=>{const T=v[k.toLowerCase()]||"default";return d[T]||"file"},w=k=>{if(!k.trim()&&i.value.length===0)return;let T=k;const F=i.value.map($=>({type:"document",transfer_method:"local_file",upload_file_id:$.id,filename:$.name,name:$.name,extension:$.extension,size:$.size}));t("send",{message:T,files:F}),i.value=[]},B=()=>{t("stop")},M=()=>{if(i.value.length>=he){ee.warning(`最多只能上传${he}个附件`);return}s.value&&s.value.click()},h=k=>{i.value=i.value.filter((T,F)=>F!==k)},G=k=>{const F=["Bytes","KB","MB","GB"],$=Math.floor(Math.log(k)/Math.log(1024));return parseFloat((k/Math.pow(1024,$)).toFixed(2))+" "+F[$]},f=k=>{if(k.length<=10)return k;const T=k.slice(k.lastIndexOf(".")),F=k.slice(0,k.lastIndexOf("."));return F.length<=7?k:F.slice(0,7)+"..."+T},x=k=>{const T=k.slice((k.lastIndexOf(".")-1>>>0)+2).toLowerCase();return l.includes(T)},b=k=>i.value.some(T=>T.name===k),m=async k=>{const F=k.target.files;if(!F||F.length===0)return;const $=F[0];if(i.value.length>=he){ee.warning(`最多只能上传${he}个附件`),s.value&&(s.value.value="");return}if(b($.name)){ee.warning(`文件"${$.name}"已存在`),s.value&&(s.value.value="");return}if(!x($.name)){ee.warning("暂不支持此类型的文件"),s.value&&(s.value.value="");return}if($.size>qe){ee.warning(`文件大小不能超过${G(qe)}`),s.value&&(s.value.value="");return}o.value=!0,r.value=0;try{const P=new FormData;P.append("file",$);const E=new URLSearchParams(window.location.search).get("userId");P.append("user",E||localStorage.getItem("dify_user_id")||"anonymous");const D=setInterval(()=>{r.value<90&&(r.value+=5)},100),W=await fetch(`${z.baseURL}/files/upload`,{method:"POST",headers:{Authorization:`Bearer ${z.apiKey}`},body:P});if(clearInterval(D),r.value=100,!W.ok)throw new Error(`上传失败: ${W.status} ${W.statusText}`);const N=await W.json();i.value.push({id:N.id,name:N.name,size:N.size,extension:N.extension,mime_type:N.mime_type}),ee.success("上传成功")}catch(P){console.error("上传文件出错:",P),ee.error(P.message||"上传文件失败")}finally{o.value=!1,s.value&&(s.value.value="")}};return(k,T)=>{const F=L("t-icon"),$=L("t-chat-input");return A(),Q("div",Ot,[i.value.length>0?(A(),Q("div",Jt,[C("div",Gt,[(A(!0),Q(te,null,ae(i.value,(P,_)=>(A(),O(ge(At),{key:_,theme:"default",variant:"light",shape:"round",size:"medium",class:"file-tag"},{default:R(()=>[g(F,{name:y(P.extension),class:"file-icon"},null,8,["name"]),C("span",Wt,X(f(P.name)),1),g(ge(Pe),{theme:"default",variant:"text",size:"small",class:"close-btn",onClick:E=>h(_)},{default:R(()=>[g(F,{name:"close"})]),_:2},1032,["onClick"])]),_:2},1024))),128))])])):K("",!0),C("div",Kt,[C("div",Nt,[C("input",{type:"file",ref_key:"fileInput",ref:s,onChange:m,class:"file-input",accept:".txt,.md,.mdx,.pdf,.html,.xlsx,.xls,.docx,.csv,.htm,.markdown"},null,544),o.value?(A(),Q("div",Zt,[g(ge(wt),{theme:"circle",size:"40",percentage:r.value,color:{from:"#108ee9",to:"#87d068"}},null,8,["percentage"])])):(A(),O(ge(Pe),{key:0,theme:"default",variant:"text",class:"attachment-btn",onClick:M},{icon:R(()=>[g(F,{name:"attach",size:"22px"})]),_:1}))]),g($,{modelValue:a.value,"onUpdate:modelValue":T[0]||(T[0]=P=>a.value=P),"stop-disabled":e.loading,"textarea-props":{placeholder:"请输入消息...",class:"custom-textarea"},onSend:w,onStop:B,autosize:""},null,8,["modelValue","stop-disabled"])])])}}}),Ht={class:"model-selector"},Xt={key:0,class:"model-name"},Yt=oe({__name:"HeaderNav",props:{title:{type:String,default:"新对话"},sidebarVisible:{type:Boolean,default:!1}},emits:["open-drawer","new-conversation","model-changed"],setup(e,{emit:n}){const t=n,a=S(z.defaultModel),s=ce(()=>z.models.find(i=>i.id===a.value)),o=ce(()=>z.models.map(i=>({content:i.name,value:i.id,prefixIcon:i.icon}))),r=i=>{const l=i.value;l!==a.value&&(a.value=l,Qe(l)&&t("model-changed",{modelId:l,model:s.value}))};return Ce(()=>{z.currentModel?a.value=z.currentModel:Qe(a.value)}),(i,l)=>{const v=L("t-icon"),d=L("t-button"),y=L("t-dropdown");return A(),Q("div",{class:ie(["fixed-header",{"sidebar-open":e.sidebarVisible,"sidebar-closed":!e.sidebarVisible}])},[g(d,{variant:"text",class:ie(["menu-btn",{"menu-icon-visible":!e.sidebarVisible,"menu-icon-hidden":e.sidebarVisible}]),onClick:l[0]||(l[0]=w=>i.$emit("open-drawer"))},{default:R(()=>[g(v,{name:"menu"})]),_:1},8,["class"]),g(d,{variant:"text",class:ie(["menu-btn",{"menu-icon-visible":!e.sidebarVisible,"menu-icon-hidden":e.sidebarVisible}]),onClick:l[1]||(l[1]=w=>i.$emit("new-conversation"))},{default:R(()=>[g(v,{name:"chat-add"})]),_:1},8,["class"]),C("div",Ht,[g(y,{options:o.value,onClick:r,trigger:"click",maxColumnWidth:"300px"},{default:R(()=>[g(d,{variant:"text",class:"model-select-btn"},{default:R(()=>[s.value?(A(),Q("span",Xt,X(s.value.name),1)):K("",!0),g(v,{name:"chevron-down"})]),_:1})]),_:1},8,["options"])])],2)}}}),en={class:"conversation-group"},tn={class:"group-title"},nn={class:"conversation-text"},sn={class:"menu-item-content"},an={class:"menu-item-content"},on={class:"menu-item-content"},rn=oe({__name:"ConversationGroup",props:{title:{type:String,required:!0},conversations:{type:Array,required:!0},currentConversationId:{type:String,default:""}},emits:["select","pin-conversation","rename-conversation","delete-conversation"],setup(e,{emit:n}){const t=n,a=(o,r)=>{const i=o==null?void 0:o.value;if(i){if(i.startsWith("pin-")){t("pin-conversation",r);return}if(i.startsWith("rename-")){t("rename-conversation",r);return}if(i.startsWith("delete-")){t("delete-conversation",r);return}}},s=(o,r=20)=>o?o.name?o.name.length>r?o.name.substring(0,r)+"...":o.name:o.last_message&&o.last_message.trim()?o.last_message.length>r?o.last_message.substring(0,r)+"...":o.last_message:`对话 ${o.id.substring(0,8)}...`:"新对话";return(o,r)=>{const i=L("t-icon"),l=L("t-button"),v=L("t-dropdown-item"),d=L("t-dropdown-menu"),y=L("t-dropdown"),w=L("t-list-item");return A(),Q("div",en,[C("div",tn,X(e.title),1),(A(!0),Q(te,null,ae(e.conversations,B=>(A(),O(w,{key:B.id,onClick:M=>o.$emit("select",B.id),class:ie(["conversation-item",{active:B.id===e.currentConversationId}])},{default:R(()=>[g(i,{name:"chat",class:"conversation-icon"}),C("span",nn,X(s(B)),1),g(y,{onClick:M=>a(M,B.id),trigger:"hover","hide-after-click":!1},{dropdown:R(()=>[g(d,null,{default:R(()=>[g(v,{value:`pin-${B.id}`},{default:R(()=>[C("div",sn,[g(i,{name:"pin",class:"menu-icon"}),r[1]||(r[1]=C("span",null,"置顶对话",-1))])]),_:2},1032,["value"]),g(v,{value:`rename-${B.id}`},{default:R(()=>[C("div",an,[g(i,{name:"edit",class:"menu-icon"}),r[2]||(r[2]=C("span",null,"重命名",-1))])]),_:2},1032,["value"]),g(v,{value:`delete-${B.id}`,theme:"error"},{default:R(()=>[C("div",on,[g(i,{name:"delete",class:"menu-icon"}),r[3]||(r[3]=C("span",null,"删除",-1))])]),_:2},1032,["value"])]),_:2},1024)]),default:R(()=>[g(l,{variant:"text",shape:"circle",size:"small",class:"more-btn",onClick:r[0]||(r[0]=Ct(()=>{},["stop"]))},{default:R(()=>[g(i,{name:"more"})]),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["onClick","class"]))),128))])}}}),ye=me(rn,[["__scopeId","data-v-edb6edd3"]]),ln={class:"sidebar-skeleton-container"},cn=oe({__name:"SidebarSkeleton",setup(e){return(n,t)=>(A(),Q("div",ln,[t[2]||(t[2]=C("div",{class:"sidebar-header-skeleton"},[C("div",{class:"icon-skeleton"}),C("div",{class:"new-chat-skeleton"})],-1)),(A(),Q(te,null,ae(2,(a,s)=>C("div",{key:s,class:"conversation-skeleton",style:{"--anim-delay":"calc(0.1s * (index + 2))"}},t[0]||(t[0]=[C("div",{class:"icon-skeleton small"},null,-1),C("div",{class:"content-skeleton"},[C("div",{class:"title-skeleton"}),C("div",{class:"subtitle-skeleton"})],-1)]))),64)),t[3]||(t[3]=C("div",{class:"group-title-skeleton",style:{"--anim-delay":"0.7s"}},[C("div",{class:"title-line"})],-1)),(A(),Q(te,null,ae(1,(a,s)=>C("div",{key:`second-${s}`,class:"conversation-skeleton",style:{"--anim-delay":"calc(0.7s + 0.1s * (index + 1))"}},t[1]||(t[1]=[C("div",{class:"icon-skeleton small"},null,-1),C("div",{class:"content-skeleton"},[C("div",{class:"title-skeleton"}),C("div",{class:"subtitle-skeleton"})],-1)]))),64))]))}}),un=me(cn,[["__scopeId","data-v-4ce04eb0"]]),Y={LIGHT:"light",DARK:"dark"};function Ie(e){e!==Y.LIGHT&&e!==Y.DARK&&(console.warn(`Invalid theme mode: ${e}, using default: ${Y.LIGHT}`),e=Y.LIGHT),document.documentElement.setAttribute("theme-mode",e),localStorage.setItem("theme-mode",e)}function we(){return document.documentElement.getAttribute("theme-mode")||Y.LIGHT}function dn(){const n=we()===Y.DARK?Y.LIGHT:Y.DARK;return Ie(n),n}function vn(){const e=localStorage.getItem("theme-mode");if(e)Ie(e);else{const n=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;Ie(n?Y.DARK:Y.LIGHT)}}const fn={class:"sidebar-container"},mn={class:"sidebar-header"},gn={class:"drawer-container"},pn={key:4,class:"loading-indicator"},hn={class:"theme-toggle-container"},yn={class:"theme-text"},An=100,wn=oe({__name:"ConversationSidebar",props:{visible:{type:Boolean,default:!1},currentConversationId:{type:String,default:""},groupedConversations:{type:Object,default:()=>({today:[],yesterday:[],lastWeek:[],older:[]})},hasMoreConversations:{type:Boolean,default:!1},loadingMoreConversations:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1}},emits:["update:visible","select","new-conversation","load-more","rename-conversation","pin-conversation"],setup(e,{emit:n}){kt();const t=e,a=S(null),s=S(!1);ce(()=>{const v=t.groupedConversations.today.length>0,d=t.groupedConversations.yesterday.length>0,y=t.groupedConversations.lastWeek.length>0,w=t.groupedConversations.older.length>0;return v||d||y||w||!t.hasMoreConversations});const o=()=>{if(!a.value||!t.hasMoreConversations||s.value||t.loadingMoreConversations)return;const v=a.value;v.scrollHeight-v.scrollTop-v.clientHeight<An&&(s.value=!0,l("load-more"),setTimeout(()=>{s.value=!1},1e3))},r=S(we()),i=()=>{dn(),r.value=we()};Ce(()=>{r.value=we()});const l=n;return(v,d)=>{const y=L("t-icon"),w=L("t-button"),B=L("t-loading"),M=L("t-list");return A(),Q(te,null,[g(le,{name:"sidebar-slide"},{default:R(()=>[bt(C("div",fn,[C("div",mn,[g(w,{variant:"text",class:"close-icon",onClick:d[0]||(d[0]=h=>v.$emit("update:visible",!1))},{default:R(()=>[g(y,{name:"menu"})]),_:1}),C("div",{onClick:d[1]||(d[1]=h=>v.$emit("new-conversation")),class:ie(["conversation-item",{active:e.currentConversationId===""}])},[d[19]||(d[19]=C("span",{class:"conversation-text"},"新对话",-1)),g(y,{name:"chat-add",class:"conversation-icon"})],2)]),C("div",gn,[d[20]||(d[20]=C("div",{class:"new-conversation-container"},null,-1)),C("div",{class:"conversations-list",ref_key:"conversationsListRef",ref:a,onScroll:o},[e.isLoading?(A(),O(un,{key:0})):(A(),O(M,{key:1},{default:R(()=>[e.groupedConversations.today.length>0?(A(),O(ye,{key:0,title:"今日",conversations:e.groupedConversations.today,"current-conversation-id":e.currentConversationId,onSelect:d[2]||(d[2]=h=>v.$emit("select",{value:h})),onPinConversation:d[3]||(d[3]=h=>v.$emit("pin-conversation",{conversationId:h})),onRenameConversation:d[4]||(d[4]=h=>v.$emit("rename-conversation",{conversationId:h})),onDeleteConversation:d[5]||(d[5]=h=>v.$emit("select",{value:`delete-${h}`}))},null,8,["conversations","current-conversation-id"])):K("",!0),e.groupedConversations.yesterday.length>0?(A(),O(ye,{key:1,title:"昨日",conversations:e.groupedConversations.yesterday,"current-conversation-id":e.currentConversationId,onSelect:d[6]||(d[6]=h=>v.$emit("select",{value:h})),onPinConversation:d[7]||(d[7]=h=>v.$emit("pin-conversation",{conversationId:h})),onRenameConversation:d[8]||(d[8]=h=>v.$emit("rename-conversation",{conversationId:h})),onDeleteConversation:d[9]||(d[9]=h=>v.$emit("select",{value:`delete-${h}`}))},null,8,["conversations","current-conversation-id"])):K("",!0),e.groupedConversations.lastWeek.length>0?(A(),O(ye,{key:2,title:"过去7天",conversations:e.groupedConversations.lastWeek,"current-conversation-id":e.currentConversationId,onSelect:d[10]||(d[10]=h=>v.$emit("select",{value:h})),onPinConversation:d[11]||(d[11]=h=>v.$emit("pin-conversation",{conversationId:h})),onRenameConversation:d[12]||(d[12]=h=>v.$emit("rename-conversation",{conversationId:h})),onDeleteConversation:d[13]||(d[13]=h=>v.$emit("select",{value:`delete-${h}`}))},null,8,["conversations","current-conversation-id"])):K("",!0),e.groupedConversations.older.length>0?(A(),O(ye,{key:3,title:"更早",conversations:e.groupedConversations.older,"current-conversation-id":e.currentConversationId,onSelect:d[14]||(d[14]=h=>v.$emit("select",{value:h})),onPinConversation:d[15]||(d[15]=h=>v.$emit("pin-conversation",{conversationId:h})),onRenameConversation:d[16]||(d[16]=h=>v.$emit("rename-conversation",{conversationId:h})),onDeleteConversation:d[17]||(d[17]=h=>v.$emit("select",{value:`delete-${h}`}))},null,8,["conversations","current-conversation-id"])):K("",!0),e.loadingMoreConversations?(A(),Q("div",pn,[g(B,{size:"small"})])):K("",!0)]),_:1}))],544),C("div",hn,[g(w,{variant:"text",size:"small",class:"theme-toggle-btn",onClick:i},{default:R(()=>[g(y,{name:r.value==="dark"?"sunny":"moon"},null,8,["name"]),C("span",yn,X(r.value==="dark"?"切换到亮色模式":"切换到暗色模式"),1)]),_:1})])])],512),[[St,e.visible]])]),_:1}),g(le,{name:"fade"},{default:R(()=>[e.visible?(A(),Q("div",{key:0,class:"sidebar-overlay",onClick:d[18]||(d[18]=h=>v.$emit("update:visible",!1))})):K("",!0)]),_:1})],64)}}}),Cn=me(wn,[["__scopeId","data-v-94ec2c56"]]),bn={__name:"ChatAction",props:{isGood:{type:Boolean,default:!1},isBad:{type:Boolean,default:!1},content:{type:String,default:""}},emits:["operation"],setup(e,{emit:n}){const t=e,a=n,s=S(t.isGood),o=S(t.isBad),r=(i,l)=>{i==="good"?(s.value=!s.value,o.value=!1,console.log("good")):i==="bad"?(o.value=!o.value,s.value=!1,console.log("bad")):i==="replay"?(console.log("replay"),a("operation",i,l)):i==="copy"&&console.log("copy")};return(i,l)=>{const v=L("t-chat-action");return A(),O(v,{class:"chat-action","is-good":s.value,"is-bad":o.value,content:e.content,"operation-btn":["good","bad","replay","copy"],onOperation:r},null,8,["is-good","is-bad","content"])}}},Sn={key:0,class:"step-loading"},kn={class:"loading-dots"},_n={key:1},Tn={key:1,class:"reasoning-header"},xn={key:3,class:"message-files"},Rn={class:"files-scroll-container"},In={class:"file-name"},Mn={class:"loading-space"},Ln={__name:"ChatItem",props:{avatar:{type:String,default:""},name:{type:String,default:""},role:{type:String,default:"user"},datetime:{type:String,default:""},content:{type:String,default:""},reasoning:{type:String,default:""},isFirstMessage:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},firstTokenReceived:{type:Boolean,default:!1},isStreamLoad:{type:Boolean,default:!1},isGood:{type:Boolean,default:!1},isBad:{type:Boolean,default:!1},files:{type:Array,default:()=>[]},workflowSteps:{type:Array,default:()=>[]}},emits:["reasoning-expand-change","operation"],setup(e,{emit:n}){const t=e,a=n,s=(b,m)=>{a("operation",b,m)},o=S("default"),r=S(1);let i=null;Ce(()=>{i=setInterval(()=>{r.value=r.value%6+1},100)}),Oe(()=>{i&&clearInterval(i)});const l=ce(()=>t.workflowSteps&&t.workflowSteps.length>0&&!t.workflowSteps.some(b=>b.loading)),v={document:"file-excel",image:"photo",audio:"play-circle",video:"play-circle-stroke",custom:"file"},d=b=>v[b]||"file",y={default:"check-circle-filled",start:"play-circle-filled",http:"link",condition:"swap",time:"time",search:"search",extract:"filter",web:"internet",file:"file",model:"root-list",reply:"chat",error:"error-circle"},w={default:"primary",start:"primary",error:"error",condition:"warning",model:"success",reply:"success"},B=b=>y[b]||y.default,M=b=>w[b]||"primary",h=(b,m)=>{const k=`var(--td-${M(b)}-color)`,T=B(b);return()=>g(L("t-icon"),{name:T,size:"medium",color:k},null)},G=()=>"......".substring(0,r.value),f=b=>{if(!b)return"";if(b.length<=10)return b;const m=b.lastIndexOf(".");if(m===-1)return b.slice(0,7)+"...";const k=b.slice(m),T=b.slice(0,m);return T.length<=7?b:T.slice(0,7)+"..."+k},x=b=>{const m=b[b.length-1];return b.some(T=>T.loading)?g("div",{class:"workflow-header"},[g(L("t-icon"),{name:B(m.node_type),color:`var(--td-${M(m.node_type)}-color)`},null),g("span",null,[m.title+G()])]):g("div",{class:"workflow-header"},[g(L("t-icon"),{name:B(m.node_type),color:`var(--td-${M(m.node_type)}-color)`},null),g("span",null,[Je("执行过程")])])};return(b,m)=>{const k=L("t-timeline-item"),T=L("t-timeline"),F=L("t-collapse-panel"),$=L("t-collapse"),P=L("t-chat-loading"),_=L("t-icon"),E=L("t-chat-content"),D=L("t-chat-reasoning"),W=L("t-tag"),N=L("t-space"),V=L("t-chat-item");return A(),O(V,{avatar:e.avatar,name:e.name,role:e.role,datetime:e.datetime,content:e.content},_t({content:R(()=>[e.role==="assistant"&&e.workflowSteps&&e.workflowSteps.length>0?(A(),O($,{key:0,"expand-icon":null,borderless:!0,"default-expand-all":l.value,class:"transparent-collapse"},{default:R(()=>[g(F,{value:"0",header:x(e.workflowSteps)},{default:R(()=>[g(T,{mode:"same",theme:o.value,class:"workflow-timeline"},{default:R(()=>[(A(!0),Q(te,null,ae(e.workflowSteps,(U,I)=>(A(),O(k,{key:I,content:U.title,dot:h(U.node_type,U.loading),"dot-color":M(U.node_type)},{default:R(()=>[U.loading?(A(),Q("div",Sn,[C("span",null,X(U.title),1),C("span",kn,X(G()),1)])):U.content?(A(),Q("div",_n,X(U.content),1)):K("",!0)]),_:2},1032,["content","dot","dot-color"]))),128))]),_:1},8,["theme"])]),_:1},8,["header"])]),_:1},8,["default-expand-all"])):K("",!0),e.reasoning&&e.reasoning.trim()&&e.role==="assistant"&&e.reasoning!=="思考中..."?(A(),O(D,{key:1,"expand-icon-placement":"right",onExpandChange:m[0]||(m[0]=U=>b.$emit("reasoning-expand-change",U))},{header:R(()=>[e.isFirstMessage&&e.loading?(A(),O(P,{key:0,text:"思考中...",indicator:""})):(A(),Q("div",Tn,[g(_,{name:"dart-board"}),m[1]||(m[1]=C("span",null,"思考过程",-1))]))]),default:R(()=>[g(E,{content:e.reasoning||""},null,8,["content"])]),_:1})):K("",!0),e.content&&e.content.trim().length>0?(A(),O(E,{key:2,content:e.content,class:"zero-margins"},null,8,["content"])):K("",!0),e.files&&e.files.length>0?(A(),Q("div",xn,[C("div",Rn,[(A(!0),Q(te,null,ae(e.files,(U,I)=>(A(),O(W,{key:I,theme:"default",variant:"light",shape:"round",size:"medium",class:"file-tag"},{default:R(()=>[g(_,{name:d(U.type),class:"file-icon",size:"240"},null,8,["name"]),C("span",In,X(f(U.filename)),1)]),_:2},1024))),128))])])):K("",!0)]),actions:R(()=>[!e.isStreamLoad&&e.role==="assistant"?(A(),O(bn,{key:0,class:"chat-actions-container","is-good":e.isGood,"is-bad":e.isBad,content:e.content||"",onOperation:s},null,8,["is-good","is-bad","content"])):K("",!0)]),_:2},[e.isFirstMessage&&e.loading&&!e.firstTokenReceived?{name:"content",fn:R(()=>[C("div",Mn,[g(N,null,{default:R(()=>[g(P,{animation:"moving",text:"思考中..."})]),_:1})])]),key:"0"}:void 0]),1032,["avatar","name","role","datetime","content"])}}},Fn="data:image/jpeg;base64,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",Dn={class:"welcome-panel animate-fade-in"},Un=oe({__name:"WelcomePanel",props:{suggestedQuestions:{type:Array,default:()=>["解释一下量子计算的基本原理","帮我生成一个简单的Vue组件","总结一下最新的AI技术发展","如何优化前端性能？","推荐几本机器学习的入门书籍"]},logoSrc:{type:String,default:"/static/files/favicon.jpg"}},emits:["question-click"],setup(e,{emit:n}){return(t,a)=>(A(),Q("div",Dn,a[0]||(a[0]=[Ge('<div class="welcome-header" data-v-8809d302><div class="logo-container" data-v-8809d302><img src="'+Fn+'" alt="Logo" class="welcome-logo" data-v-8809d302></div><h1 class="welcome-title" data-v-8809d302>DeepSeek-R1-671B（星火数媒）</h1><p class="welcome-subtitle" data-v-8809d302>有什么我能帮您的吗？</p></div>',1)])))}}),Bn=me(Un,[["__scopeId","data-v-8809d302"]]),$n={class:"chat-skeleton-container"},En=oe({__name:"ChatSkeleton",setup(e){return(n,t)=>(A(),Q("div",$n,t[0]||(t[0]=[Ge('<div class="message-skeleton user-message" style="--anim-delay:0.1s;" data-v-9ee0cab7><div class="avatar-skeleton" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line" data-v-9ee0cab7></div><div class="line short" data-v-9ee0cab7></div></div></div></div><div class="message-skeleton assistant-message" style="--anim-delay:0.2s;" data-v-9ee0cab7><div class="avatar-skeleton assistant" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line" data-v-9ee0cab7></div><div class="line" data-v-9ee0cab7></div><div class="line medium" data-v-9ee0cab7></div><div class="line long" data-v-9ee0cab7></div><div class="line medium" data-v-9ee0cab7></div></div></div></div><div class="message-skeleton user-message" style="--anim-delay:0.3s;" data-v-9ee0cab7><div class="avatar-skeleton" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line medium" data-v-9ee0cab7></div><div class="line short" data-v-9ee0cab7></div></div></div></div><div class="message-skeleton assistant-message" style="--anim-delay:0.4s;" data-v-9ee0cab7><div class="avatar-skeleton assistant" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line" data-v-9ee0cab7></div><div class="line long" data-v-9ee0cab7></div><div class="line" data-v-9ee0cab7></div><div class="line short" data-v-9ee0cab7></div></div></div></div>',4)])))}}),Pn=me(En,[["__scopeId","data-v-9ee0cab7"]]),Qn=()=>{const e=new AbortController,n=e.signal;return{controller:e,signal:n,abortRequest:()=>{if(e.signal.aborted)console.log("请求已经被中断，不再重复执行");else try{console.log("执行请求中断操作"),e.abort(),console.log("请求中断完成")}catch(a){console.error("中断请求时出错:",a)}}}},jn=(e,n)=>{const{loading:t,isStreamLoad:a}=n;t&&typeof t.value<"u"&&(t.value=!1),a&&typeof a.value<"u"&&(a.value=!1),e&&e.role==="assistant"&&(!e.content||e.content===""?e.content="回复已中断":e.content.includes("[已中断]")||(e.content+=" [已中断]"),e.reasoning==="思考中..."?e.reasoning="思考过程已中断":e.reasoning&&!e.reasoning.includes("已中断")&&(e.reasoning+=" [已中断]"))},qn=async(e,n)=>{if(!e||!n)return console.error("[Stream Stop] 停止响应失败: taskId或userId不能为空",{taskId:e,userId:n}),!1;console.log("[Stream Stop] 尝试停止流式响应",{taskId:e,userId:n});try{const t=z.baseURL,a=z.apiKey;console.log("[Stream Stop] 发送停止请求到:",`${t}/chat-messages/${e}/stop`);const s=await fetch(`${t}/chat-messages/${e}/stop`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({user:n})}),o=await s.json();return s.ok?(console.log("[Stream Stop] 流式响应已成功停止",{status:s.status,result:o}),!0):(console.error("[Stream Stop] 停止响应请求失败:",{status:s.status,result:o}),!1)}catch(t){return console.error("[Stream Stop] 停止响应请求错误:",t),!1}};function zn(){return{handleReasoningUpdate:(s,o,r)=>{r.value||(r.value=!0);try{!s.reasoning||s.reasoning==="思考中..."?s.reasoning=o||"":s.reasoning+=o||""}catch(i){console.error("处理思考内容出错:",i)}},handleMessageUpdate:(s,o,r,i,l,v)=>{r.value||(r.value=!0);try{s.content?s.content+=o||"":s.content=o||"",o&&!i.value&&setTimeout(()=>{v.value&&l(v.value,!0)},10)}catch(d){console.error("处理消息内容出错:",d)}},handleFileEvent:(s,o)=>{try{s.files||(s.files=[]),s.files.push(o)}catch(r){console.error("处理文件事件出错:",r)}},handleWorkflowSteps:(s,o,r,i)=>{if(i.value=!0,o.value.length>0){const l=o.value[0];l.role==="assistant"&&r.value&&(l.workflowSteps=s,console.log("收到工作流步骤:",s.map(v=>`${v.title}(${v.node_type})${v.loading?"[加载中]":""}`)))}}}}const ze=(e,n=20)=>e?e.name?e.name.length>n?e.name.substring(0,n)+"...":e.name:e.last_message&&e.last_message.trim()?e.last_message.length>n?e.last_message.substring(0,n)+"...":e.last_message:`对话 ${e.id.substring(0,8)}...`:"新对话",On=e=>{const n=new Date;n.setHours(0,0,0,0);const t=new Date(n);t.setDate(t.getDate()-1);const a=new Date(n);a.setDate(a.getDate()-7);const s={today:[],yesterday:[],lastWeek:[],older:[]};return e.forEach(o=>{let r;o.updated_at?r=new Date(o.updated_at*1e3):r=new Date;const i=new Date(r);i.setHours(0,0,0,0),i.getTime()===n.getTime()?s.today.push(o):i.getTime()===t.getTime()?s.yesterday.push(o):i.getTime()>=a.getTime()?s.lastWeek.push(o):s.older.push(o)}),s},Re=(e,n)=>{let t=null;return function(...a){t&&clearTimeout(t),t=setTimeout(()=>{e.apply(null,a),t=null},n)}},Ae=({currentConversationId:e,chatList:n,suggestedQuestions:t,suggestedQuestionsConversationId:a,isNewConversation:s,resetConversationFunc:o})=>{o(),e.value="",n.value=[],t.value=[],a.value="",s&&(s.value=!0)},Jn={class:"app-container"},Gn={class:"chat-wrapper"},Wn={key:0,class:"suggested-questions-container"},Kn={class:"suggested-questions"},Nn=50,Zn=oe({__name:"index",setup(e){const n=S(null),t=S(!1),a=S(!1),s=S(!1),o=S(!1),r=S(null),i=S(!1),l=S([]),v=S(""),d=S(!1),y=S([]),w=S(""),B=S(1),M=S(20),h=S(!0),G=S(!1),f=S(!1),x=S(!0),b=S(!1),m=S(!0),k=S(!1),T=S(""),F=S(""),$=S(!1),P=S(""),_=S(null),E=S(""),D=S([]),W=S(""),N=S(null),V=S(null),U=S(!1),I=S(!0),Ke=S(["介绍一下金钟集团","金钟集团有哪些产品","金钟集团的优势"]),Me=new URLSearchParams(window.location.search),Le=Me.get("userId"),Ne=Me.get("userName");console.log("从URL获取的参数:",{userId:Le,userName:Ne}),Ce(()=>{vn(),Fe()});const Ze=ce(()=>{const u=y.value.find(c=>c.id===w.value);return ze(u,15)}),Ve=ce(()=>On(y.value)),Fe=async()=>{try{v.value=await zt()}catch(u){console.error("系统提示词加载失败:",u)}f.value=!0;try{const u=await fe({limit:20,sort_by:"-updated_at"});if(u&&Array.isArray(u)){y.value=u,x.value=u.length>=20;const c=await $t();c?(w.value=c,I.value=!1,await Se(c)):(w.value="",l.value=[],I.value=!0,U.value=!1),u.length===0&&(w.value="",l.value=[],I.value=!0,U.value=!1)}else console.error("服务器返回的会话列表数据格式不正确:",u),w.value="",l.value=[],I.value=!0,U.value=!1}catch(u){console.error("获取服务器会话列表失败:",u),w.value="",l.value=[],I.value=!0,U.value=!1}finally{f.value=!1}},Se=async(u,c=!0,p=null)=>{if(!u)return console.error("会话ID为空，无法加载历史消息"),!1;try{G.value=!c,c&&(U.value=!0),c&&(D.value=[]),c&&(B.value=1,h.value=!0,l.value=[]);const J={page:B.value,pageSize:M.value,signal:p},Z=await We(u,J);if(p!=null&&p.aborted||u!==w.value)return console.log("加载请求已中断或会话已切换，不更新UI"),!1;if(Z.length>0){if(c?l.value=Z:l.value=[...Z,...l.value],h.value=Z.length>=M.value,c&&Z.length>0){const ne=Z.filter(j=>j.role==="assistant"&&j.id);if(ne.length>0){const H=ne[ne.length-1].id.replace("_assistant","");$e(H)}}}else c&&(l.value=[]),h.value=!1;return l.value&&Array.isArray(l.value)&&l.value.length>0,!0}catch(J){return console.error("加载对话历史消息失败:",J),h.value=!1,c&&(l.value=[]),!1}finally{G.value=!1,U.value=!1}},He=Re(async(u,c)=>{try{u===w.value&&await Se(u,!0,c.signal)}catch(p){p.name!=="AbortError"&&console.error("加载对话内容失败:",p),U.value=!1}finally{V.value===c&&(V.value=null)}},300),Xe=async u=>{const c=u.value;if(typeof c=="string"&&c.startsWith("delete-")){const p=c.substring(7);P.value=p,$.value=!0;return}if(c==="new"){Ae({currentConversationId:w,chatList:l,suggestedQuestions:D,suggestedQuestionsConversationId:W,isNewConversation:I,resetConversationFunc:pe});return}if(c!==w.value){if(D.value=[],W.value="",w.value=c,U.value=!0,l.value=[],I.value=!1,N.value&&clearTimeout(N.value),V.value)try{V.value.abort(),console.log("已取消之前的对话加载请求")}catch(J){console.error("取消之前的请求失败:",J)}const p=new AbortController;V.value=p,He(c,p)}},Ye=async()=>{if(!(!h.value||!w.value||G.value))try{G.value=!0,B.value+=1,await Se(w.value,!1)}finally{G.value=!1}},et=u=>{var p;(((p=u.detail)==null?void 0:p.scrollTop)||0)<=Nn&&h.value&&w.value&&!G.value&&Ye()},tt=(u,{index:c})=>{},nt=async function(){await Et(),Ae({currentConversationId:w,chatList:l,suggestedQuestions:D,suggestedQuestionsConversationId:W,isNewConversation:I,resetConversationFunc:pe})},st=async function(){try{if(!t.value&&!a.value){console.log("请求已经停止，不再执行中断操作");return}t.value=!1,a.value=!1,i.value=!0;const u=l.value[0];jn(u,{loading:t,isStreamLoad:a});const c=n.value;n.value=null;const p=_.value;if(_.value=null,p)try{await qn(p,Le)}catch(J){console.error("API停止请求失败:",J)}if(c)try{c()}catch(J){console.error("中断请求时出错:",J)}}catch(u){console.error("停止请求时发生错误:",u),t.value=!1,a.value=!1,n.value=null,_.value=null}},at=function(u,c){const p=c.index;if(u==="good")s.value=!s.value,o.value=!1;else if(u==="bad")o.value=!o.value,s.value=!1;else if(u==="replay"){const J=l.value[p+1].content;ke(J)}},ke=function(u){if(a.value)return;let c="",p=[];if(typeof u=="string"?c=u:typeof u=="object"&&(c=u.message||"",p=u.files||[]),!c&&p.length===0)return;I.value=!1;const J=Ft(c,p);l.value.unshift(J);const Z=Dt(!0);l.value.unshift(Z),ot(c,p)},ot=async(u,c=[])=>{var Ee;t.value=!0,a.value=!0,i.value=!1,_.value=null,E.value=null;const p=l.value[0],{handleReasoningUpdate:J,handleMessageUpdate:Z,handleFileEvent:ne,handleWorkflowSteps:j}=zn(),H=((Ee=l.value[1])==null?void 0:Ee.role)==="user"?l.value[1].content:u,re=Lt(l.value,H,v.value),{signal:_e,abortRequest:ht}=Qn();n.value=ht;try{const de={signal:_e,conversation_id:w.value||"",files:c.length>0?c:void 0};await qt(re,{onReasoning:q=>{!t.value||!a.value||J(p,q,i)},onMessage:q=>{!t.value||!a.value||Z(p,q,i,d,je,r)},onFileEvent:q=>{!t.value||!a.value||ne(p,q)},onError:q=>{console.error("API请求出错:",q),ee.error(q||"请求出错"),t.value=!1,a.value=!1,p.loading=!1,p.isStreamLoad=!1,p.content=`请求失败: ${q}`},onComplete:(q,Te)=>{console.log("请求完成, 成功:",q,Te),t.value=!1,a.value=!1,p&&(p.loading=!1,p.isStreamLoad=!1),q?w.value&&Ut(w.value,{messages:l.value,onComplete:ve=>{if(!ve){console.log("自动重命名完成，但未返回标题");return}console.log("自动重命名完成，新标题:",ve),y.value=y.value.map(xe=>xe.id===w.value?{...xe,name:ve}:xe)}}).catch(ve=>{console.error("自动重命名过程出错:",ve)}):(console.warn("请求未成功完成:",Te),p&&(p.content||(p.content=`请求未完成: ${Te||"未知原因"}`))),Rt(()=>{r.value&&je(r.value,!0)})},onConversationIdChange:q=>{console.log("会话ID更新:",q),q&&q!==w.value&&(w.value=q,mt())},onMessageIdChange:q=>{E.value=q,q&&p&&p.role==="assistant"&&ft(q)},onTaskIdChange:q=>{_.value=q},onWorkflowSteps:q=>{j(q,l,t,i)}},de)}catch(de){console.error("聊天请求失败:",de),t.value=!1,a.value=!1,p&&(p.loading=!1,p.isStreamLoad=!1,p.content=`聊天请求失败: ${de.message||"未知错误"}`),ee.error("聊天请求失败: "+(de.message||"未知错误"))}},rt=async()=>{if(!(!x.value||b.value))try{b.value=!0;const u=y.value.length>0?y.value[y.value.length-1].id:null;if(!u){x.value=!1;return}const c=await fe({last_id:u,limit:20,sort_by:"-updated_at"});c&&Array.isArray(c)&&c.length>0?(y.value=[...y.value,...c],x.value=c.length>=20):x.value=!1}catch(u){console.error("加载更多会话失败:",u)}finally{b.value=!1}},De=()=>{Ae({currentConversationId:w,chatList:l,suggestedQuestions:D,suggestedQuestionsConversationId:W,isNewConversation:I,resetConversationFunc:pe})},lt=async({conversationId:u,name:c})=>{try{const p=await se(u,{name:c});y.value=y.value.map(J=>J.id===u?{...J,name:p.name||c}:J)}catch(p){console.error("重命名对话失败:",p)}},it=({conversationId:u})=>{const c=y.value.find(p=>p.id===u);c&&(y.value=y.value.filter(p=>p.id!==u),y.value.unshift(c))},ct=({conversationId:u})=>{F.value=u;const c=y.value.find(p=>p.id===u);c&&(T.value=c.name||ze(c,100)),k.value=!0},Ue=()=>{F.value&&T.value.trim()&&lt({conversationId:F.value,name:T.value.trim()}),k.value=!1,T.value="",F.value=""},ut=()=>{k.value=!1,T.value="",F.value=""},dt=async()=>{if(!P.value){$.value=!1;return}try{const u=await Bt(P.value);y.value=y.value.filter(c=>c.id!==P.value),w.value===P.value&&Ae({currentConversationId:w,chatList:l,suggestedQuestions:D,suggestedQuestionsConversationId:W,isNewConversation:I,resetConversationFunc:pe})}catch(u){console.error("删除对话失败:",u)}finally{$.value=!1,P.value=""}},vt=()=>{$.value=!1,P.value=""},Be=u=>{ke(u),D.value=[],W.value=""},$e=async u=>{if(u)try{const c=await Pt(u);c&&Array.isArray(c)&&c.length>0?(D.value=c,W.value=w.value):D.value=[]}catch(c){console.error("获取建议问题失败:",c),D.value=[]}},ft=Re(u=>{$e(u)},300),mt=Re(async()=>{try{const u=await fe({limit:20,sort_by:"-updated_at"});u&&Array.isArray(u)&&(y.value=u,x.value=u.length>=20)}catch(u){console.error("刷新会话列表失败:",u)}},500),gt=()=>{m.value=!m.value};Oe(()=>{N.value&&clearTimeout(N.value),V.value&&V.value.abort()});const pt=u=>{console.log("模型已切换，立即显示加载状态并准备加载新数据:",u),U.value=!0,f.value=!0,l.value=[],D.value=[],W.value="",Fe()};return(u,c)=>{const p=L("t-tag"),J=L("t-chat"),Z=L("t-input"),ne=L("t-dialog");return A(),Q("div",Jn,[g(Cn,{visible:m.value,"onUpdate:visible":c[0]||(c[0]=j=>m.value=j),"current-conversation-id":w.value,"grouped-conversations":Ve.value,"has-more-conversations":x.value,"loading-more-conversations":b.value,"is-loading":f.value,onSelect:Xe,onNewConversation:De,onLoadMore:rt,onRenameConversation:ct,onPinConversation:it},null,8,["visible","current-conversation-id","grouped-conversations","has-more-conversations","loading-more-conversations","is-loading"]),C("div",{class:ie(["main-content",{"sidebar-open":m.value,"sidebar-closed":!m.value}])},[g(Yt,{title:Ze.value,"sidebar-visible":m.value,onOpenDrawer:gt,onNewConversation:De,onModelChanged:pt},null,8,["title","sidebar-visible"]),C("div",Gn,[g(le,{name:"fade"},{default:R(()=>[g(J,{class:"chat-container",ref_key:"chatRef",ref:r,layout:"both","clear-history":!1,onClear:nt,onScroll:et},{footer:R(()=>[g(le,{name:"suggestions-slide"},{default:R(()=>[D.value.length>0?(A(),Q("div",Wn,[C("div",Kn,[(A(!0),Q(te,null,ae(D.value,(j,H)=>(A(),O(p,{key:H,theme:"primary",variant:"light",class:"question-tag",size:"medium",onClick:re=>Be(j)},{default:R(()=>[Je(X(j),1)]),_:2},1032,["onClick"]))),128))])])):K("",!0)]),_:1}),g(Vt,{loading:t.value,onSend:ke,onStop:st},null,8,["loading"])]),default:R(()=>[U.value?(A(),O(le,{key:0,name:"skeleton-fade",appear:""},{default:R(()=>[g(Pn)]),_:1})):l.value.length>0?(A(),O(xt,{key:1,name:"chat-items",appear:""},{default:R(()=>[(A(!0),Q(te,null,ae(l.value,(j,H)=>(A(),O(Ln,{key:H,avatar:j.avatar,name:j.name,role:j.role,datetime:j.datetime,content:j.content,reasoning:j.reasoning,"is-first-message":H===0,loading:t.value,"first-token-received":i.value,"is-stream-load":a.value,"is-good":s.value,"is-bad":o.value,files:j.files,"workflow-steps":j.workflowSteps,style:Tt({"--item-index":l.value.length-H}),onReasoningExpandChange:re=>tt(re,{index:H}),onOperation:(re,_e)=>at(re,{index:H,e:_e})},null,8,["avatar","name","role","datetime","content","reasoning","is-first-message","loading","first-token-received","is-stream-load","is-good","is-bad","files","workflow-steps","style","onReasoningExpandChange","onOperation"]))),128))]),_:1})):I.value?(A(),O(le,{key:2,name:"welcome-fade",appear:""},{default:R(()=>[g(Bn,{"suggested-questions":Ke.value,logoSrc:"/static/images/logo.png",onQuestionClick:Be},null,8,["suggested-questions"])]),_:1})):K("",!0)]),_:1},512)]),_:1})])],2),g(ne,{width:"35%",visible:k.value,"onUpdate:visible":c[2]||(c[2]=j=>k.value=j),header:"重命名对话","confirm-btn":{content:"确定",theme:"primary"},"cancel-btn":{content:"取消",theme:"default"},onConfirm:Ue,onClose:ut},{default:R(()=>[g(Z,{modelValue:T.value,"onUpdate:modelValue":c[1]||(c[1]=j=>T.value=j),type:"text",maxlength:100,placeholder:"请输入新名称",clearable:"",autofocus:"",onEnter:Ue},null,8,["modelValue"])]),_:1},8,["visible"]),g(ne,{width:"35%",visible:$.value,"onUpdate:visible":c[3]||(c[3]=j=>$.value=j),header:"删除对话","confirm-btn":{content:"确定",theme:"danger"},"cancel-btn":{content:"取消",theme:"default"},onConfirm:dt,onClose:vt},{default:R(()=>c[4]||(c[4]=[C("p",{class:"dialog-content"},"确定要删除该对话吗？此操作不可恢复。",-1)])),_:1},8,["visible"])])}}}),Hn=Object.freeze(Object.defineProperty({__proto__:null,default:Zn},Symbol.toStringTag,{value:"Module"}));export{be as c,Hn as i};
