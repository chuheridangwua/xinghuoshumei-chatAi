const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/workflow.CFoIiyDn.js","assets/vendor.CamtBdHc.js","assets/vendor.Y0ZZv602.css","assets/index.aq3X53NA.js","assets/index.DXkv32yV.css"])))=>i.map(i=>d[i]);
import{h as ae,j as b,c as U,n as H,m as S,F as ee,q as se,v as K,w as A,a as p,r as x,t as Z,u as ge,B as Ee,T as yt,P as wt,M as Y,o as y,k as ce,x as be,y as ie,z as bt,A as le,C as _t,D as Ct,E as St,l as qe,G as kt,p as We,H as Ne,I as $t,J as Tt,K as At}from"./vendor.CamtBdHc.js";import{a as It,_ as me}from"./index.aq3X53NA.js";const j={baseURL:"https://api.dify.ai/v1",workflowApiKey:"app-6aRhLAp4zAppCJus5ViMgOsh",datasetApiKey:"dataset-NU4Kg7Wtm1616AOnxnRAeFct",models:[{id:"DeepSeek-V3",name:"作文评分 AI 智能体",apiKey:"app-mJY5qTsLUXT3jLAKgfNrTbxP"},{id:"DeepSeek-R1",name:"星火深思(DeepSeek-R1)",apiKey:"app-2PAC8Jw4d0UxjZzFXL0nXRUa"}],defaultModel:"DeepSeek-V3",apiKey:"app-mJY5qTsLUXT3jLAKgfNrTbxP",staticResourceBase:"../static"},_e=(e,n)=>{const a=`${j.baseURL}${e}`;return a.startsWith("http://")||a.startsWith("https://")?new URL(a):new URL(a,window.location.origin)},ze=e=>{const n=j.models.find(t=>t.id===e);return n?(j.currentModel=e,j.apiKey=n.apiKey,console.log("已切换模型:",n.name),j):(console.error("未找到指定的模型:",e),null)},ue=()=>{const n=new URLSearchParams(window.location.search).get("userId");if(n)return localStorage.setItem("dify_user_id",n),n;let t=localStorage.getItem("dify_user_id");return t||(t="user_"+Math.random().toString(36).substring(2,15),localStorage.setItem("dify_user_id",t)),t},fe=async(e={})=>{try{const n=ue(),t=_e("/conversations");t.searchParams.append("user",n),e.last_id&&t.searchParams.append("last_id",e.last_id),e.limit&&t.searchParams.append("limit",e.limit),e.sort_by&&t.searchParams.append("sort_by",e.sort_by);const a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j.apiKey}`}});if(!a.ok){const o=await a.text();throw new Error(`获取会话列表失败: ${a.status} ${o}`)}const s=await a.json();return s&&Array.isArray(s.data)&&s.data.sort((o,l)=>{const c=new Date(o.created_at||0);return new Date(l.created_at||0)-c}),s.data||[]}catch(n){return console.error("获取会话列表失败:",n),[]}},xt=e=>{if(!e)return{content:"",reasoning:""};const n="<think>",t="</think>";let a="",s=e;if(e.includes(n)&&e.includes(t))try{const o=e.match(/<think>([\s\S]*?)<\/think>/);o&&o[1]&&(a=o[1].trim()),s=e.replace(/<think>[\s\S]*?<\/think>/,"").trim()}catch(o){console.error("提取思考内容时出错:",o),s=e}return{content:s,reasoning:a}},Ge=async(e,n={})=>{if(!e)return[];try{const t=ue(),{page:a=1,pageSize:s=20}=n,o=_e("/messages");o.searchParams.append("conversation_id",e),o.searchParams.append("user",t),o.searchParams.append("page",a),o.searchParams.append("page_size",s);const l=await fetch(o,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j.apiKey}`},signal:n.signal});if(!l.ok){const r=await l.text();throw new Error(`获取会话历史失败: ${l.status} ${r}`)}const c=await l.json();return c&&c.data&&Array.isArray(c.data)?Mt(c.data,e):[]}catch(t){throw t.name!=="AbortError"&&console.error("获取服务器会话历史失败:",t),t}},Mt=(e,n)=>{const t=[];for(const a of e){if(a.query){const s={avatar:"https://tdesign.gtimg.com/site/avatar.jpg",name:"自己",datetime:new Date(a.created_at*1e3).toLocaleString(),content:a.query,role:"user",id:a.id+"_user"};a.files&&Array.isArray(a.files)&&a.files.length>0&&(s.files=a.files.map(o=>({id:o.id,filename:o.filename||o.name,type:o.type||"document",size:o.size||0,url:o.url||""}))),a.message_files&&Array.isArray(a.message_files)&&a.message_files.length>0&&(s.files||(s.files=[]),a.message_files.forEach(o=>{s.files.push({id:o.id,filename:o.filename||o.name,type:o.type||"document",size:o.size||0,url:o.url||""})})),t.push(s)}if(a.answer){const{content:s,reasoning:o}=xt(a.answer),l={avatar:"https://xinghuoshumei-chat-9d1az3cdd1955-1325585334.tcloudbaseapp.com/static/files/favicon.jpg",name:"星火数媒",datetime:new Date(a.created_at*1e3).toLocaleString(),content:s||"",role:"assistant",...o?{reasoning:o}:{},id:a.id+"_assistant"};t.push(l)}}return t.reverse(),t},Dt=(e,n,t,a=10)=>{let s=!1,o=[],l=n;if(!l&&e&&e.length>0){for(let r=0;r<e.length;r++)if(e[r].role==="user"&&e[r].content.trim()!==""){l=e[r].content;break}}let c=new Set;for(let r=e.length-1;r>=0;r--){const i=e[r];if((i.role==="user"||i.role==="assistant"||i.role==="system")&&i.content.trim()!==""){if(i.role==="user"&&i.content===l)continue;i.role==="system"&&(s=!0);const M=`${i.role}:${i.content}`;c.has(M)||(o.push({role:i.role,content:i.content}),c.add(M))}}if(l&&l.trim()!==""){const r=`user:${l}`;c.has(r)||o.push({role:"user",content:l})}return o.length>a&&(o=o.slice(-a)),!s&&t&&o.unshift({role:"system",content:t}),o},Ue=e=>{e&&e.scrollToBottom({behavior:"smooth"})},Rt=(e,n=[])=>{const t={avatar:"https://tdesign.gtimg.com/site/avatar.jpg",name:"自己",datetime:new Date().toLocaleString(),content:e||"",role:"user"};return n&&Array.isArray(n)&&n.length>0&&(t.files=n.map(a=>({id:a.upload_file_id||a.id,filename:a.filename||a.name||"未命名文件",type:a.type||"document",size:a.size||0,url:a.url||""}))),t},Bt=(e=!1)=>{const n={avatar:"https://xinghuoshumei-chat-9d1az3cdd1955-1325585334.tcloudbaseapp.com/static/files/favicon.jpg",name:"星火数媒",datetime:new Date().toLocaleString(),content:"",role:"assistant"};return e?{...n,reasoning:"思考中..."}:n},Ft=async(e,n={})=>{try{if(!e)return console.log("会话ID为空，跳过自动重命名"),!1;let t=n.messages||[];t.length||(t=await Ge(e));const a=t.length,s=Math.floor(a/2),l=(await fe()).find(r=>r.id===e);if((s<=3||s>=5&&s%5===0)&&(!l||!l.name||l.name.startsWith("新对话")||l.name==="New conversation")){console.log("[自动重命名] 需要重命名对话:",e,"当前轮数:",s);try{let r="";const i=[...t].sort((m,T)=>{if(m.datetime&&T.datetime)return m.datetime-T.datetime;if(m.created_at&&T.created_at){const w=typeof m.created_at=="string"?new Date(m.created_at).getTime():m.created_at*1e3,f=typeof T.created_at=="string"?new Date(T.created_at).getTime():T.created_at*1e3;return w-f}return 0}),M=[];let h={user:null,assistant:null};for(const m of i)m.role==="user"?(h.user!==null&&(M.push({...h}),h={user:null,assistant:null}),h.user=m.content):m.role==="assistant"&&(h.assistant!==null&&(M.push({...h}),h={user:null,assistant:null}),h.assistant=m.content);(h.user!==null||h.assistant!==null)&&M.push(h);const k=M.slice(-5);for(let m=0;m<k.length;m++){const T=k[m];r+=`[第${m+1}轮]
`,T.user&&(r+=`用户: ${T.user}
`),T.assistant&&(r+=`助手: ${T.assistant}
`),r+=`
`}if(console.log("[自动重命名] 提取的对话内容:",r.length,"字节"),!r.trim()){console.log("[自动重命名] 消息内容为空，使用默认重命名方式");const m=await ne(e,{auto_generate:!0});return m.success||console.warn("[自动重命名] 默认重命名失败:",m.message),m.success}const{generateArticleTitle:F}=await It(()=>import("./workflow.CFoIiyDn.js"),__vite__mapDeps([0,1,2,3,4]));let v=!1,W="";const N=await F(r,{onOutput:async m=>{if(m&&m.text){const T=m.text.trim();if(console.log("[自动重命名] 生成的标题:",T),T){v=!0,W=T;const w=await ne(e,{name:T});if(w.success)console.log("[自动重命名] 重命名成功:",T),typeof n.onComplete=="function"&&n.onComplete(T);else{console.error("[自动重命名] 重命名失败:",w.message),console.log("[自动重命名] 尝试使用默认方式重命名");const f=await ne(e,{auto_generate:!0});f.success&&typeof n.onComplete=="function"&&n.onComplete(f.name||"")}}}},onError:async m=>{console.error("[自动重命名] 生成标题失败:",m);const T=await ne(e,{auto_generate:!0});T.success&&typeof n.onComplete=="function"&&n.onComplete(T.name||"")},onComplete:async m=>{if(m&&!v){console.warn("[自动重命名] 工作流执行成功但未生成标题，使用默认重命名");const T=await ne(e,{auto_generate:!0});T.success&&typeof n.onComplete=="function"&&n.onComplete(T.name||"")}}},{responseMode:"streaming",userId:"title-generator"});return v?(console.log("[自动重命名] 标题已生成并应用:",W),!0):N.success?!0:(console.warn("[自动重命名] 生成标题工作流执行失败，使用默认重命名"),(await ne(e,{auto_generate:!0})).success)}catch(r){return console.error("[自动重命名] 使用工作流生成标题失败，回退到默认方式:",r),(await ne(e,{auto_generate:!0})).success}}return!1}catch(t){return console.error("[自动重命名] 自动重命名失败:",t),!1}},ne=async(e,n={})=>{const t=ue();try{const a={user:t};n.auto_generate?a.auto_generate=!0:n.name&&(a.name=n.name),console.log(`[重命名] 尝试重命名会话 ${e}`,{auto_generate:n.auto_generate,name:n.name,API地址:`${j.baseURL}/conversations/${e}/name`});const s=await fetch(`${j.baseURL}/conversations/${e}/name`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j.apiKey}`},body:JSON.stringify(a)}),o=await s.text();let l;try{l=JSON.parse(o)}catch{l=o}return s.ok?(console.log(`[重命名] 会话重命名成功: ${e}`,l),{success:!0,...l}):(console.error(`[重命名] 重命名会话失败: ${s.status}`,l),{success:!1,status:s.status,error:l,message:`重命名会话失败: ${s.status}`})}catch(a){return console.error("[重命名] 重命名会话错误:",a),{success:!1,error:a,message:a.message||"重命名会话失败"}}},Lt=async e=>{const n=ue();try{const t={user:n},a=await fetch(`${j.baseURL}/conversations/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j.apiKey}`},body:JSON.stringify(t)});if(!a.ok){const o=await a.text();throw new Error(`删除会话失败: ${a.status} ${o}`)}return await a.json()}catch(t){throw console.error("删除会话错误:",t),t}},Et=async()=>{try{const e=await fe({limit:1});return e&&e.length>0?e[0].id:""}catch(e){return console.error("获取当前会话失败:",e),""}},zt=async e=>{try{return!0}catch(n){return console.error("清空聊天记录失败:",n),!1}},Ut=async e=>{try{const n=ue(),t=_e(`/messages/${e}/suggested`);t.searchParams.append("user",n);const a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j.apiKey}`}});if(!a.ok)throw new Error(`获取建议问题失败: ${a.status}`);const s=await a.json();return s&&s.data&&Array.isArray(s.data)?s.data:[]}catch(n){return console.error("获取建议问题失败:",n),[]}};j.baseURL,j.apiKey;const Pt=async(e,n={})=>{try{const t=ue(),a=_e("/chat-messages"),o={query:e[e.length-1].content,user:t,response_mode:"streaming",inputs:{}};n.conversation_id&&(o.conversation_id=n.conversation_id),n.files&&Array.isArray(n.files)&&n.files.length>0&&(o.files=n.files),console.log("[Request] 发送请求:",o);const l=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${j.apiKey}`},body:JSON.stringify(o),signal:n.signal});if(!l.ok)throw new Error(`请求失败: ${l.status}`);return l}catch(t){throw console.error("发送聊天请求失败:",t),t}},Ot=async(e,n={})=>{var h,k,F;const{onMessage:t,onError:a,onComplete:s,onReasoning:o,onWorkflowSteps:l,onConversationIdChange:c,onMessageIdChange:r,onTaskIdChange:i,onFileEvent:M}=n;try{if(e.signal&&e.signal.aborted){console.log("[Stream] 请求已中断"),s==null||s(!1,"请求已中断");return}const v=await e;if(!v.ok){const $=await v.text();throw console.error("[Stream] API请求失败:",v.status,$),new Error(`API请求失败: ${v.status} ${$}`)}console.log("[Stream] 开始处理流式响应");const W=v.body.getReader(),N=new TextDecoder;let m="",T=!1,w=null,f=[],_=null;try{for(;;){if(e.signal&&e.signal.aborted){console.log("[Stream] 检测到请求中断信号，停止处理流");break}const{done:$,value:D}=await W.read();if($){console.log("[Stream] 流读取完成");break}m+=N.decode(D,{stream:!0});const L=m.split(`
`);m=L.pop()||"";for(const z of L)if(!(!z.trim()||!z.startsWith("data: ")))try{const C=JSON.parse(z.substring(6));if(C.conversation_id&&!w&&(w=C.conversation_id,console.log(`%c[Stream] 获取会话ID: ${w}`,"color: #9C27B0; font-weight: bold;"),c&&c(w)),C.event==="message"){const E=C.answer||"";if(E.includes("<think>")){T=!0;const R=E.replace("<think>","");console.log("%c[Stream] 进入思考模式","color: #FF9800; font-weight: bold;"),o==null||o(R)}else if(E.includes("</think>")){const R=E.split("</think>");console.log("%c[Stream] 结束思考模式","color: #FF9800; font-weight: bold;"),o==null||o(R[0]),T=!1,R.length>1&&(t==null||t(R[1]))}else T?o==null||o(E):t==null||t(E)}else if(C.event==="message_end")console.log("%c[Stream] 收到消息结束事件: message_end","color: #4CAF50; font-weight: bold;"),C.message_id&&r&&r(C.message_id),C.task_id&&i&&i(C.task_id);else if(C.event==="message_file"){if(console.log("%c[Stream] 收到文件事件: message_file","color: #4CAF50; font-weight: bold;"),M&&C.file){const E={id:C.file.id,filename:C.file.filename||C.file.name,type:C.file.type||"document",size:C.file.size||0,url:C.file.url||""};M(E)}}else if(C.event==="message_replace")console.log("%c[Stream] 收到消息替换事件: message_replace","color: #4CAF50; font-weight: bold;"),t==null||t(C.answer||"");else if(C.event==="tts_message")console.log("%c[Stream] 收到TTS事件: tts_message","color: #4CAF50; font-weight: bold;");else if(C.event==="tts_message_end")console.log("%c[Stream] 收到TTS结束事件: tts_message_end","color: #4CAF50; font-weight: bold;");else if(C.event==="workflow_started")console.log("%c[Stream] 收到工作流开始事件: workflow_started","color: #4CAF50; font-weight: bold;");else if(C.event==="node_started"){console.log("%c[Stream] 收到节点开始事件: node_started","color: #4CAF50; font-weight: bold;");const E=(h=C.data)==null?void 0:h.title,R=((k=C.data)==null?void 0:k.id)||`node-${f.length}`;if(E){const G=B=>{const I=B.toLowerCase();return I==="开始"?"start":I.includes("http")||I.includes("请求")?"http":I.includes("条件")||I.includes("分支")?"condition":I.includes("时间")?"time":I.includes("搜索")?"search":I.includes("提取")||I.includes("参数")?"extract":I.includes("web")||I.includes("bocha")?"web":I.includes("文件")?"file":I.includes("模型")||I.includes("总结")?"model":I.includes("回复")?"reply":I.includes("错误")?"error":"default"},V=((F=C.data)==null?void 0:F.type)||G(E);if(console.log("%c[Stream Node Started]","color: #2196F3; font-weight: bold;",{title:E,type:V,id:R}),_){const B=f.findIndex(I=>I.id===_);B!==-1&&(f[B].loading=!1,l&&l([...f]))}const Q={title:E,node_type:V,id:R,loading:!0};f.push(Q),_=R,l&&l([...f])}}else if(C.event==="node_finished"){if(console.log("%c[Stream] 收到节点完成事件: node_finished","color: #4CAF50; font-weight: bold;"),_){const E=f.findIndex(R=>R.id===_);E!==-1&&(f[E].loading=!1,l&&l([...f])),_=null}}else C.event==="workflow_finished"?(console.log("%c[Stream] 收到工作流完成事件: workflow_finished","color: #4CAF50; font-weight: bold;"),f=f.map(E=>({...E,loading:!1})),l&&l([...f]),f=[],_=null):C.event==="error"?(console.error("%c[Stream] 收到错误事件: error","color: #F44336; font-weight: bold;"),a==null||a(C.message||"流处理错误")):C.event==="ping"&&console.log("%c[Stream] 收到ping事件","color: #607D8B; font-style: italic;")}catch(C){console.error("%c[Stream] 解析流数据失败:","color: #F44336; font-weight: bold;",C)}}}catch($){console.error("%c[Stream] 流处理过程中出错:","color: #F44336; font-weight: bold;",$);const D=$.message||"";if($.name==="AbortError"||D.includes("aborted")||D.includes("abort")||D.includes("BodyStreamBuffer was aborted")||D.includes("message channel closed")||D.includes("listener indicated an asynchronous response")){console.log("%c[Stream] 请求被中断","color: #FF9800; font-weight: bold;"),s==null||s(!1,"请求处理过程已中断");return}throw $}finally{try{W.releaseLock(),console.log("[Stream] 读取器已释放")}catch($){console.warn("[Stream] 释放读取锁时出错:",$)}}console.log("[Stream] 流处理完成"),s==null||s(!0)}catch(v){console.error("[Stream] 流式请求错误:",v),v.name==="AbortError"||v.message.includes("aborted")||v.message.includes("BodyStreamBuffer was aborted")?(console.log("[Stream] 请求中断错误"),s==null||s(!1,"请求已中断")):(console.error("[Stream] 请求失败错误"),a==null||a(v.message||"请求失败"),s==null||s(!1,v.message))}},jt=async(e,n={},t={})=>{var a,s,o,l,c,r,i,M,h,k,F,v,W,N;try{const m=t.conversation_id||"",T={...t,conversation_id:m};console.log("[Chat] 开始聊天请求",{conversationId:m,messageCount:e.length,hasSignal:!!t.signal});const w=Pt(e,T);try{return console.log("[Chat] 开始处理流式响应"),await Ot(w,n),console.log("[Chat] 流式响应处理成功"),{success:!0}}catch(f){return console.error("[Chat] 流处理过程中出错:",f),f.name==="AbortError"||(a=f.message)!=null&&a.includes("aborted")||(s=f.message)!=null&&s.includes("message channel closed")||(o=f.message)!=null&&o.includes("BodyStreamBuffer was aborted")||(l=f.message)!=null&&l.includes("listener indicated an asynchronous response")?(console.log("[Chat] 流处理被中断"),(c=n.onComplete)==null||c.call(n,!1,"请求已中断"),{success:!1,aborted:!0,error:f}):(console.error("[Chat] 流处理失败:",f.message||"未知错误"),(r=n.onError)==null||r.call(n,f.message||"流处理失败"),(i=n.onComplete)==null||i.call(n,!1,f.message),{success:!1,error:f})}}catch(m){return console.error("[Chat] 聊天请求错误:",m),m.name==="AbortError"||(M=m.message)!=null&&M.includes("aborted")||(h=m.message)!=null&&h.includes("message channel closed")||(k=m.message)!=null&&k.includes("BodyStreamBuffer was aborted")||(F=m.message)!=null&&F.includes("listener indicated an asynchronous response")?(console.log("[Chat] 聊天请求被中断"),(v=n.onComplete)==null||v.call(n,!1,"请求已中断"),{success:!1,aborted:!0,error:m}):(console.error("[Chat] 聊天请求失败:",m.message||"未知错误"),(W=n.onError)==null||W.call(n,m.message||"请求失败"),(N=n.onComplete)==null||N.call(n,!1,m.message),{success:!1,error:m})}},Kt=async()=>{try{const e=await fetch("/static/files/prompt-copy.json");if(e.ok){const n=await e.json();return JSON.stringify(n)}else return console.error(`加载系统提示词失败: ${e.status}`),{role:"您是一个助手",tools:{description:""},rules:[]}}catch(e){return console.error("加载系统提示词失败:",e),{role:"您是一个助手",tools:{description:""},rules:[]}}},pe=()=>{try{return!0}catch(e){return console.error("重置会话出错:",e),!1}},qt={class:"chat-sender"},Wt={key:0,class:"uploaded-files"},Nt={class:"files-scroll-container"},Gt={class:"file-name"},Ht={class:"input-container"},Vt={class:"attach-button-wrapper"},Jt={key:1,class:"loading-container"},Pe=2*1024*1024,he=3,Qt=ae({__name:"ChatSender",props:{loading:{type:Boolean,default:!1}},emits:["send","stop"],setup(e,{emit:n}){const t=n,a=b(""),s=b(null),o=b(!1),l=b(0),c=b([]),r=["txt","md","mdx","pdf","html","xlsx","xls","docx","csv","htm","markdown"],i={txt:"document",md:"document",mdx:"document",markdown:"document",pdf:"document",html:"document",htm:"document",xlsx:"document",xls:"document",docx:"document",csv:"document"},M={document:"file-excel",default:"file"},h=_=>{const $=i[_.toLowerCase()]||"default";return M[$]||"file"},k=_=>{if(!_.trim()&&c.value.length===0)return;let $=_;const D=c.value.map(L=>({type:"document",transfer_method:"local_file",upload_file_id:L.id,filename:L.name,name:L.name,extension:L.extension,size:L.size}));t("send",{message:$,files:D}),c.value=[]},F=()=>{t("stop")},v=()=>{if(c.value.length>=he){Y.warning(`最多只能上传${he}个附件`);return}s.value&&s.value.click()},W=_=>{c.value=c.value.filter(($,D)=>D!==_)},N=_=>{const D=["Bytes","KB","MB","GB"],L=Math.floor(Math.log(_)/Math.log(1024));return parseFloat((_/Math.pow(1024,L)).toFixed(2))+" "+D[L]},m=_=>{if(_.length<=10)return _;const $=_.slice(_.lastIndexOf(".")),D=_.slice(0,_.lastIndexOf("."));return D.length<=7?_:D.slice(0,7)+"..."+$},T=_=>{const $=_.slice((_.lastIndexOf(".")-1>>>0)+2).toLowerCase();return r.includes($)},w=_=>c.value.some($=>$.name===_),f=async _=>{const D=_.target.files;if(!D||D.length===0)return;const L=D[0];if(c.value.length>=he){Y.warning(`最多只能上传${he}个附件`),s.value&&(s.value.value="");return}if(w(L.name)){Y.warning(`文件"${L.name}"已存在`),s.value&&(s.value.value="");return}if(!T(L.name)){Y.warning("暂不支持此类型的文件"),s.value&&(s.value.value="");return}if(L.size>Pe){Y.warning(`文件大小不能超过${N(Pe)}`),s.value&&(s.value.value="");return}o.value=!0,l.value=0;try{const z=new FormData;z.append("file",L);const E=new URLSearchParams(window.location.search).get("userId");z.append("user",E||localStorage.getItem("dify_user_id")||"anonymous");const R=setInterval(()=>{l.value<90&&(l.value+=5)},100),G=await fetch(`${j.baseURL}/files/upload`,{method:"POST",headers:{Authorization:`Bearer ${j.apiKey}`},body:z});if(clearInterval(R),l.value=100,!G.ok)throw new Error(`上传失败: ${G.status} ${G.statusText}`);const V=await G.json();c.value.push({id:V.id,name:V.name,size:V.size,extension:V.extension,mime_type:V.mime_type}),Y.success("上传成功")}catch(z){console.error("上传文件出错:",z),Y.error(z.message||"上传文件失败")}finally{o.value=!1,s.value&&(s.value.value="")}};return(_,$)=>{const D=x("t-icon"),L=x("t-chat-input");return y(),U("div",qt,[c.value.length>0?(y(),U("div",Wt,[S("div",Nt,[(y(!0),U(ee,null,se(c.value,(z,C)=>(y(),K(ge(yt),{key:C,theme:"default",variant:"light",shape:"round",size:"medium",class:"file-tag"},{default:A(()=>[p(D,{name:h(z.extension),class:"file-icon"},null,8,["name"]),S("span",Gt,Z(m(z.name)),1),p(ge(Ee),{theme:"default",variant:"text",size:"small",class:"close-btn",onClick:E=>W(C)},{default:A(()=>[p(D,{name:"close"})]),_:2},1032,["onClick"])]),_:2},1024))),128))])])):H("",!0),S("div",Ht,[S("div",Vt,[S("input",{type:"file",ref_key:"fileInput",ref:s,onChange:f,class:"file-input",accept:".txt,.md,.mdx,.pdf,.html,.xlsx,.xls,.docx,.csv,.htm,.markdown"},null,544),o.value?(y(),U("div",Jt,[p(ge(wt),{theme:"circle",size:"40",percentage:l.value,color:{from:"#108ee9",to:"#87d068"}},null,8,["percentage"])])):(y(),K(ge(Ee),{key:0,theme:"default",variant:"text",class:"attachment-btn",onClick:v},{icon:A(()=>[p(D,{name:"attach",size:"22px"})]),_:1}))]),p(L,{modelValue:a.value,"onUpdate:modelValue":$[0]||($[0]=z=>a.value=z),"stop-disabled":e.loading,"textarea-props":{placeholder:"请输入消息...",class:"custom-textarea"},onSend:k,onStop:F,autosize:""},null,8,["modelValue","stop-disabled"])])])}}}),Xt={class:"model-selector"},Yt={key:0,class:"model-name"},Zt=ae({__name:"HeaderNav",props:{title:{type:String,default:"新对话"},sidebarVisible:{type:Boolean,default:!1}},emits:["open-drawer","new-conversation","model-changed"],setup(e,{emit:n}){const t=n,a=b(j.defaultModel),s=ce(()=>j.models.find(c=>c.id===a.value)),o=ce(()=>j.models.map(c=>({content:c.name,value:c.id,prefixIcon:c.icon}))),l=c=>{const r=c.value;r!==a.value&&(a.value=r,ze(r)&&t("model-changed",{modelId:r,model:s.value}))};return be(()=>{j.currentModel?a.value=j.currentModel:ze(a.value)}),(c,r)=>{const i=x("t-icon"),M=x("t-button"),h=x("t-dropdown");return y(),U("div",{class:ie(["fixed-header",{"sidebar-open":e.sidebarVisible,"sidebar-closed":!e.sidebarVisible}])},[p(M,{variant:"text",class:ie(["menu-btn",{"menu-icon-visible":!e.sidebarVisible,"menu-icon-hidden":e.sidebarVisible}]),onClick:r[0]||(r[0]=k=>c.$emit("open-drawer"))},{default:A(()=>[p(i,{name:"menu"})]),_:1},8,["class"]),p(M,{variant:"text",class:ie(["menu-btn",{"menu-icon-visible":!e.sidebarVisible,"menu-icon-hidden":e.sidebarVisible}]),onClick:r[1]||(r[1]=k=>c.$emit("new-conversation"))},{default:A(()=>[p(i,{name:"chat-add"})]),_:1},8,["class"]),S("div",Xt,[p(h,{options:o.value,onClick:l,trigger:"click",maxColumnWidth:"300px"},{default:A(()=>[p(M,{variant:"text",class:"model-select-btn"},{default:A(()=>[s.value?(y(),U("span",Yt,Z(s.value.name),1)):H("",!0),p(i,{name:"chevron-down"})]),_:1})]),_:1},8,["options"])])],2)}}}),en={class:"conversation-group"},tn={class:"group-title"},nn={class:"conversation-text"},sn={class:"menu-item-content"},an={class:"menu-item-content"},on={class:"menu-item-content"},rn=ae({__name:"ConversationGroup",props:{title:{type:String,required:!0},conversations:{type:Array,required:!0},currentConversationId:{type:String,default:""}},emits:["select","pin-conversation","rename-conversation","delete-conversation"],setup(e,{emit:n}){const t=n,a=(o,l)=>{const c=o==null?void 0:o.value;if(c){if(c.startsWith("pin-")){t("pin-conversation",l);return}if(c.startsWith("rename-")){t("rename-conversation",l);return}if(c.startsWith("delete-")){t("delete-conversation",l);return}}},s=(o,l=20)=>o?o.name?o.name.length>l?o.name.substring(0,l)+"...":o.name:o.last_message&&o.last_message.trim()?o.last_message.length>l?o.last_message.substring(0,l)+"...":o.last_message:`对话 ${o.id.substring(0,8)}...`:"新对话";return(o,l)=>{const c=x("t-icon"),r=x("t-button"),i=x("t-dropdown-item"),M=x("t-dropdown-menu"),h=x("t-dropdown"),k=x("t-list-item");return y(),U("div",en,[S("div",tn,Z(e.title),1),(y(!0),U(ee,null,se(e.conversations,F=>(y(),K(k,{key:F.id,onClick:v=>o.$emit("select",F.id),class:ie(["conversation-item",{active:F.id===e.currentConversationId}])},{default:A(()=>[p(c,{name:"chat",class:"conversation-icon"}),S("span",nn,Z(s(F)),1),p(h,{onClick:v=>a(v,F.id),trigger:"hover","hide-after-click":!1},{dropdown:A(()=>[p(M,null,{default:A(()=>[p(i,{value:`pin-${F.id}`},{default:A(()=>[S("div",sn,[p(c,{name:"pin",class:"menu-icon"}),l[1]||(l[1]=S("span",null,"置顶对话",-1))])]),_:2},1032,["value"]),p(i,{value:`rename-${F.id}`},{default:A(()=>[S("div",an,[p(c,{name:"edit",class:"menu-icon"}),l[2]||(l[2]=S("span",null,"重命名",-1))])]),_:2},1032,["value"]),p(i,{value:`delete-${F.id}`,theme:"error"},{default:A(()=>[S("div",on,[p(c,{name:"delete",class:"menu-icon"}),l[3]||(l[3]=S("span",null,"删除",-1))])]),_:2},1032,["value"])]),_:2},1024)]),default:A(()=>[p(r,{variant:"text",shape:"circle",size:"small",class:"more-btn",onClick:l[0]||(l[0]=bt(()=>{},["stop"]))},{default:A(()=>[p(c,{name:"more"})]),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["onClick","class"]))),128))])}}}),ye=me(rn,[["__scopeId","data-v-edb6edd3"]]),ln={class:"sidebar-skeleton-container"},cn=ae({__name:"SidebarSkeleton",setup(e){return(n,t)=>(y(),U("div",ln,[t[2]||(t[2]=S("div",{class:"sidebar-header-skeleton"},[S("div",{class:"icon-skeleton"}),S("div",{class:"new-chat-skeleton"})],-1)),(y(),U(ee,null,se(2,(a,s)=>S("div",{key:s,class:"conversation-skeleton",style:{"--anim-delay":"calc(0.1s * (index + 2))"}},t[0]||(t[0]=[S("div",{class:"icon-skeleton small"},null,-1),S("div",{class:"content-skeleton"},[S("div",{class:"title-skeleton"}),S("div",{class:"subtitle-skeleton"})],-1)]))),64)),t[3]||(t[3]=S("div",{class:"group-title-skeleton",style:{"--anim-delay":"0.7s"}},[S("div",{class:"title-line"})],-1)),(y(),U(ee,null,se(1,(a,s)=>S("div",{key:`second-${s}`,class:"conversation-skeleton",style:{"--anim-delay":"calc(0.7s + 0.1s * (index + 1))"}},t[1]||(t[1]=[S("div",{class:"icon-skeleton small"},null,-1),S("div",{class:"content-skeleton"},[S("div",{class:"title-skeleton"}),S("div",{class:"subtitle-skeleton"})],-1)]))),64))]))}}),un=me(cn,[["__scopeId","data-v-4ce04eb0"]]),oe={LIGHT:"light",DARK:"dark"};function Oe(e){e!==oe.LIGHT&&e!==oe.DARK&&(console.warn(`Invalid theme mode: ${e}, using default: ${oe.LIGHT}`),e=oe.LIGHT),document.documentElement.setAttribute("theme-mode",e),localStorage.setItem("theme-mode",e)}function je(){return document.documentElement.getAttribute("theme-mode")||oe.LIGHT}function dn(){const e=localStorage.getItem("theme-mode");if(e)Oe(e);else{const n=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;Oe(n?oe.DARK:oe.LIGHT)}}const vn={class:"sidebar-container"},fn={class:"sidebar-header"},mn={class:"drawer-container"},gn={key:4,class:"loading-indicator"},pn=100,hn=ae({__name:"ConversationSidebar",props:{visible:{type:Boolean,default:!1},currentConversationId:{type:String,default:""},groupedConversations:{type:Object,default:()=>({today:[],yesterday:[],lastWeek:[],older:[]})},hasMoreConversations:{type:Boolean,default:!1},loadingMoreConversations:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1}},emits:["update:visible","select","new-conversation","load-more","rename-conversation","pin-conversation"],setup(e,{emit:n}){St();const t=e,a=b(null),s=b(!1);ce(()=>{const r=t.groupedConversations.today.length>0,i=t.groupedConversations.yesterday.length>0,M=t.groupedConversations.lastWeek.length>0,h=t.groupedConversations.older.length>0;return r||i||M||h||!t.hasMoreConversations});const o=()=>{if(!a.value||!t.hasMoreConversations||s.value||t.loadingMoreConversations)return;const r=a.value;r.scrollHeight-r.scrollTop-r.clientHeight<pn&&(s.value=!0,c("load-more"),setTimeout(()=>{s.value=!1},1e3))},l=b(je());be(()=>{l.value=je()});const c=n;return(r,i)=>{const M=x("t-icon"),h=x("t-button"),k=x("t-loading"),F=x("t-list");return y(),U(ee,null,[p(le,{name:"sidebar-slide"},{default:A(()=>[_t(S("div",vn,[S("div",fn,[p(h,{variant:"text",class:"close-icon",onClick:i[0]||(i[0]=v=>r.$emit("update:visible",!1))},{default:A(()=>[p(M,{name:"menu"})]),_:1}),S("div",{onClick:i[1]||(i[1]=v=>r.$emit("new-conversation")),class:ie(["conversation-item",{active:e.currentConversationId===""}])},[i[19]||(i[19]=S("span",{class:"conversation-text"},"新对话",-1)),p(M,{name:"chat-add",class:"conversation-icon"})],2)]),S("div",mn,[i[20]||(i[20]=S("div",{class:"new-conversation-container"},null,-1)),S("div",{class:"conversations-list",ref_key:"conversationsListRef",ref:a,onScroll:o},[e.isLoading?(y(),K(un,{key:0})):(y(),K(F,{key:1},{default:A(()=>[e.groupedConversations.today.length>0?(y(),K(ye,{key:0,title:"今日",conversations:e.groupedConversations.today,"current-conversation-id":e.currentConversationId,onSelect:i[2]||(i[2]=v=>r.$emit("select",{value:v})),onPinConversation:i[3]||(i[3]=v=>r.$emit("pin-conversation",{conversationId:v})),onRenameConversation:i[4]||(i[4]=v=>r.$emit("rename-conversation",{conversationId:v})),onDeleteConversation:i[5]||(i[5]=v=>r.$emit("select",{value:`delete-${v}`}))},null,8,["conversations","current-conversation-id"])):H("",!0),e.groupedConversations.yesterday.length>0?(y(),K(ye,{key:1,title:"昨日",conversations:e.groupedConversations.yesterday,"current-conversation-id":e.currentConversationId,onSelect:i[6]||(i[6]=v=>r.$emit("select",{value:v})),onPinConversation:i[7]||(i[7]=v=>r.$emit("pin-conversation",{conversationId:v})),onRenameConversation:i[8]||(i[8]=v=>r.$emit("rename-conversation",{conversationId:v})),onDeleteConversation:i[9]||(i[9]=v=>r.$emit("select",{value:`delete-${v}`}))},null,8,["conversations","current-conversation-id"])):H("",!0),e.groupedConversations.lastWeek.length>0?(y(),K(ye,{key:2,title:"过去7天",conversations:e.groupedConversations.lastWeek,"current-conversation-id":e.currentConversationId,onSelect:i[10]||(i[10]=v=>r.$emit("select",{value:v})),onPinConversation:i[11]||(i[11]=v=>r.$emit("pin-conversation",{conversationId:v})),onRenameConversation:i[12]||(i[12]=v=>r.$emit("rename-conversation",{conversationId:v})),onDeleteConversation:i[13]||(i[13]=v=>r.$emit("select",{value:`delete-${v}`}))},null,8,["conversations","current-conversation-id"])):H("",!0),e.groupedConversations.older.length>0?(y(),K(ye,{key:3,title:"更早",conversations:e.groupedConversations.older,"current-conversation-id":e.currentConversationId,onSelect:i[14]||(i[14]=v=>r.$emit("select",{value:v})),onPinConversation:i[15]||(i[15]=v=>r.$emit("pin-conversation",{conversationId:v})),onRenameConversation:i[16]||(i[16]=v=>r.$emit("rename-conversation",{conversationId:v})),onDeleteConversation:i[17]||(i[17]=v=>r.$emit("select",{value:`delete-${v}`}))},null,8,["conversations","current-conversation-id"])):H("",!0),e.loadingMoreConversations?(y(),U("div",gn,[p(k,{size:"small"})])):H("",!0)]),_:1}))],544)])],512),[[Ct,e.visible]])]),_:1}),p(le,{name:"fade"},{default:A(()=>[e.visible?(y(),U("div",{key:0,class:"sidebar-overlay",onClick:i[18]||(i[18]=v=>r.$emit("update:visible",!1))})):H("",!0)]),_:1})],64)}}}),yn=me(hn,[["__scopeId","data-v-6d1633d6"]]),wn={__name:"ChatAction",props:{isGood:{type:Boolean,default:!1},isBad:{type:Boolean,default:!1},content:{type:String,default:""}},emits:["operation"],setup(e,{emit:n}){const t=e,a=n,s=b(t.isGood),o=b(t.isBad),l=(c,r)=>{c==="good"?(s.value=!s.value,o.value=!1,console.log("good")):c==="bad"?(o.value=!o.value,s.value=!1,console.log("bad")):c==="replay"?(console.log("replay"),a("operation",c,r)):c==="copy"&&console.log("copy")};return(c,r)=>{const i=x("t-chat-action");return y(),K(i,{class:"chat-action","is-good":s.value,"is-bad":o.value,content:e.content,"operation-btn":["good","bad","replay","copy"],onOperation:l},null,8,["is-good","is-bad","content"])}}},bn={key:0,class:"step-loading"},_n={class:"loading-dots"},Cn={key:1},Sn={key:1,class:"reasoning-header"},kn={key:3,class:"message-files"},$n={class:"files-scroll-container"},Tn={class:"file-name"},An={class:"loading-space"},In={__name:"ChatItem",props:{avatar:{type:String,default:""},name:{type:String,default:""},role:{type:String,default:"user"},datetime:{type:String,default:""},content:{type:String,default:""},reasoning:{type:String,default:""},isFirstMessage:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},firstTokenReceived:{type:Boolean,default:!1},isStreamLoad:{type:Boolean,default:!1},isGood:{type:Boolean,default:!1},isBad:{type:Boolean,default:!1},files:{type:Array,default:()=>[]},workflowSteps:{type:Array,default:()=>[]}},emits:["reasoning-expand-change","operation"],setup(e,{emit:n}){const t=e,a=n,s=(w,f)=>{a("operation",w,f)},o=b("default"),l=b(1);let c=null;be(()=>{c=setInterval(()=>{l.value=l.value%6+1},100)}),qe(()=>{c&&clearInterval(c)});const r=ce(()=>t.workflowSteps&&t.workflowSteps.length>0&&!t.workflowSteps.some(w=>w.loading)),i={document:"file-excel",image:"photo",audio:"play-circle",video:"play-circle-stroke",custom:"file"},M=w=>i[w]||"file",h={default:"check-circle-filled",start:"play-circle-filled",http:"link",condition:"swap",time:"time",search:"search",extract:"filter",web:"internet",file:"file",model:"root-list",reply:"chat",error:"error-circle"},k={default:"primary",start:"primary",error:"error",condition:"warning",model:"success",reply:"success"},F=w=>h[w]||h.default,v=w=>k[w]||"primary",W=(w,f)=>{const _=`var(--td-${v(w)}-color)`,$=F(w);return()=>p(x("t-icon"),{name:$,size:"medium",color:_},null)},N=()=>"......".substring(0,l.value),m=w=>{if(!w)return"";if(w.length<=10)return w;const f=w.lastIndexOf(".");if(f===-1)return w.slice(0,7)+"...";const _=w.slice(f),$=w.slice(0,f);return $.length<=7?w:$.slice(0,7)+"..."+_},T=w=>{const f=w[w.length-1];return w.some($=>$.loading)?p("div",{class:"workflow-header"},[p(x("t-icon"),{name:F(f.node_type),color:`var(--td-${v(f.node_type)}-color)`},null),p("span",null,[f.title+N()])]):p("div",{class:"workflow-header"},[p(x("t-icon"),{name:F(f.node_type),color:`var(--td-${v(f.node_type)}-color)`},null),p("span",null,[We("执行过程")])])};return(w,f)=>{const _=x("t-timeline-item"),$=x("t-timeline"),D=x("t-collapse-panel"),L=x("t-collapse"),z=x("t-chat-loading"),C=x("t-icon"),E=x("t-chat-content"),R=x("t-chat-reasoning"),G=x("t-tag"),V=x("t-space"),Q=x("t-chat-item");return y(),K(Q,{avatar:e.avatar,name:e.name,role:e.role,datetime:e.datetime,content:e.content},kt({content:A(()=>[e.role==="assistant"&&e.workflowSteps&&e.workflowSteps.length>0?(y(),K(L,{key:0,"expand-icon":null,borderless:!0,"default-expand-all":r.value,class:"transparent-collapse"},{default:A(()=>[p(D,{value:"0",header:T(e.workflowSteps)},{default:A(()=>[p($,{mode:"same",theme:o.value,class:"workflow-timeline"},{default:A(()=>[(y(!0),U(ee,null,se(e.workflowSteps,(B,I)=>(y(),K(_,{key:I,content:B.title,dot:W(B.node_type,B.loading),"dot-color":v(B.node_type)},{default:A(()=>[B.loading?(y(),U("div",bn,[S("span",null,Z(B.title),1),S("span",_n,Z(N()),1)])):B.content?(y(),U("div",Cn,Z(B.content),1)):H("",!0)]),_:2},1032,["content","dot","dot-color"]))),128))]),_:1},8,["theme"])]),_:1},8,["header"])]),_:1},8,["default-expand-all"])):H("",!0),e.reasoning&&e.reasoning.trim()&&e.role==="assistant"&&e.reasoning!=="思考中..."?(y(),K(R,{key:1,"expand-icon-placement":"right",onExpandChange:f[0]||(f[0]=B=>w.$emit("reasoning-expand-change",B))},{header:A(()=>[e.isFirstMessage&&e.loading?(y(),K(z,{key:0,text:"思考中...",indicator:""})):(y(),U("div",Sn,[p(C,{name:"dart-board"}),f[1]||(f[1]=S("span",null,"思考过程",-1))]))]),default:A(()=>[p(E,{content:e.reasoning||""},null,8,["content"])]),_:1})):H("",!0),e.content&&e.content.trim().length>0?(y(),K(E,{key:2,content:e.content,class:"zero-margins"},null,8,["content"])):H("",!0),e.files&&e.files.length>0?(y(),U("div",kn,[S("div",$n,[(y(!0),U(ee,null,se(e.files,(B,I)=>(y(),K(G,{key:I,theme:"default",variant:"light",shape:"round",size:"medium",class:"file-tag"},{default:A(()=>[p(C,{name:M(B.type),class:"file-icon",size:"240"},null,8,["name"]),S("span",Tn,Z(m(B.filename)),1)]),_:2},1024))),128))])])):H("",!0)]),actions:A(()=>[!e.isStreamLoad&&e.role==="assistant"?(y(),K(wn,{key:0,class:"chat-actions-container","is-good":e.isGood,"is-bad":e.isBad,content:e.content||"",onOperation:s},null,8,["is-good","is-bad","content"])):H("",!0)]),_:2},[e.isFirstMessage&&e.loading&&!e.firstTokenReceived?{name:"content",fn:A(()=>[S("div",An,[p(V,null,{default:A(()=>[p(z,{animation:"moving",text:"思考中..."})]),_:1})])]),key:"0"}:void 0]),1032,["avatar","name","role","datetime","content"])}}},xn={class:"welcome-panel animate-fade-in"},Mn=ae({__name:"WelcomePanel",props:{suggestedQuestions:{type:Array,default:()=>["解释一下量子计算的基本原理","帮我生成一个简单的Vue组件","总结一下最新的AI技术发展","如何优化前端性能？","推荐几本机器学习的入门书籍"]},logoSrc:{type:String,default:"https://xinghuoshumei-chat-9d1az3cdd1955-1325585334.tcloudbaseapp.com/static/files/favicon.jpg"}},emits:["question-click"],setup(e,{emit:n}){return(t,a)=>(y(),U("div",xn,a[0]||(a[0]=[Ne('<div class="welcome-header" data-v-ccc8b6c1><div class="logo-container" data-v-ccc8b6c1><img src="https://xinghuoshumei-chat-9d1az3cdd1955-1325585334.tcloudbaseapp.com/static/files/favicon.jpg" alt="Logo" class="welcome-logo" data-v-ccc8b6c1></div><h1 class="welcome-title" data-v-ccc8b6c1>作文评分 AI 智能体</h1><p class="welcome-subtitle" data-v-ccc8b6c1>输入作文题目和内容，我会为你打分、指出亮点和不足，还会给出实用建议，帮你写得更好！</p></div>',1)])))}}),Dn=me(Mn,[["__scopeId","data-v-ccc8b6c1"]]),Rn={class:"chat-skeleton-container"},Bn=ae({__name:"ChatSkeleton",setup(e){return(n,t)=>(y(),U("div",Rn,t[0]||(t[0]=[Ne('<div class="message-skeleton user-message" style="--anim-delay:0.1s;" data-v-9ee0cab7><div class="avatar-skeleton" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line" data-v-9ee0cab7></div><div class="line short" data-v-9ee0cab7></div></div></div></div><div class="message-skeleton assistant-message" style="--anim-delay:0.2s;" data-v-9ee0cab7><div class="avatar-skeleton assistant" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line" data-v-9ee0cab7></div><div class="line" data-v-9ee0cab7></div><div class="line medium" data-v-9ee0cab7></div><div class="line long" data-v-9ee0cab7></div><div class="line medium" data-v-9ee0cab7></div></div></div></div><div class="message-skeleton user-message" style="--anim-delay:0.3s;" data-v-9ee0cab7><div class="avatar-skeleton" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line medium" data-v-9ee0cab7></div><div class="line short" data-v-9ee0cab7></div></div></div></div><div class="message-skeleton assistant-message" style="--anim-delay:0.4s;" data-v-9ee0cab7><div class="avatar-skeleton assistant" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line" data-v-9ee0cab7></div><div class="line long" data-v-9ee0cab7></div><div class="line" data-v-9ee0cab7></div><div class="line short" data-v-9ee0cab7></div></div></div></div>',4)])))}}),Fn=me(Bn,[["__scopeId","data-v-9ee0cab7"]]),Ln=()=>{const e=new AbortController,n=e.signal;return{controller:e,signal:n,abortRequest:()=>{if(e.signal.aborted)console.log("请求已经被中断，不再重复执行");else try{console.log("执行请求中断操作"),e.abort(),console.log("请求中断完成")}catch(a){console.error("中断请求时出错:",a)}}}},En=(e,n)=>{const{loading:t,isStreamLoad:a}=n;t&&typeof t.value<"u"&&(t.value=!1),a&&typeof a.value<"u"&&(a.value=!1),e&&e.role==="assistant"&&(!e.content||e.content===""?e.content="回复已中断":e.content.includes("[已中断]")||(e.content+=" [已中断]"),e.reasoning==="思考中..."?e.reasoning="思考过程已中断":e.reasoning&&!e.reasoning.includes("已中断")&&(e.reasoning+=" [已中断]"))},zn=async(e,n)=>{if(!e||!n)return console.error("[Stream Stop] 停止响应失败: taskId或userId不能为空",{taskId:e,userId:n}),!1;console.log("[Stream Stop] 尝试停止流式响应",{taskId:e,userId:n});try{const t=j.baseURL,a=j.apiKey;console.log("[Stream Stop] 发送停止请求到:",`${t}/chat-messages/${e}/stop`);const s=await fetch(`${t}/chat-messages/${e}/stop`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({user:n})}),o=await s.json();return s.ok?(console.log("[Stream Stop] 流式响应已成功停止",{status:s.status,result:o}),!0):(console.error("[Stream Stop] 停止响应请求失败:",{status:s.status,result:o}),!1)}catch(t){return console.error("[Stream Stop] 停止响应请求错误:",t),!1}};function Un(){return{handleReasoningUpdate:(s,o,l)=>{l.value||(l.value=!0);try{!s.reasoning||s.reasoning==="思考中..."?s.reasoning=o||"":s.reasoning+=o||""}catch(c){console.error("处理思考内容出错:",c)}},handleMessageUpdate:(s,o,l,c,r,i)=>{l.value||(l.value=!0);try{s.content?s.content+=o||"":s.content=o||"",o&&!c.value&&setTimeout(()=>{i.value&&r(i.value,!0)},10)}catch(M){console.error("处理消息内容出错:",M)}},handleFileEvent:(s,o)=>{try{s.files||(s.files=[]),s.files.push(o)}catch(l){console.error("处理文件事件出错:",l)}},handleWorkflowSteps:(s,o,l,c)=>{if(c.value=!0,o.value.length>0){const r=o.value[0];r.role==="assistant"&&l.value&&(r.workflowSteps=s,console.log("收到工作流步骤:",s.map(i=>`${i.title}(${i.node_type})${i.loading?"[加载中]":""}`)))}}}}const Ke=(e,n=20)=>e?e.name?e.name.length>n?e.name.substring(0,n)+"...":e.name:e.last_message&&e.last_message.trim()?e.last_message.length>n?e.last_message.substring(0,n)+"...":e.last_message:`对话 ${e.id.substring(0,8)}...`:"新对话",Pn=e=>{const n=new Date;n.setHours(0,0,0,0);const t=new Date(n);t.setDate(t.getDate()-1);const a=new Date(n);a.setDate(a.getDate()-7);const s={today:[],yesterday:[],lastWeek:[],older:[]};return e.forEach(o=>{let l;o.updated_at?l=new Date(o.updated_at*1e3):l=new Date;const c=new Date(l);c.setHours(0,0,0,0),c.getTime()===n.getTime()?s.today.push(o):c.getTime()===t.getTime()?s.yesterday.push(o):c.getTime()>=a.getTime()?s.lastWeek.push(o):s.older.push(o)}),s},Ae=(e,n)=>{let t=null;return function(...a){t&&clearTimeout(t),t=setTimeout(()=>{e.apply(null,a),t=null},n)}},we=({currentConversationId:e,chatList:n,suggestedQuestions:t,suggestedQuestionsConversationId:a,isNewConversation:s,resetConversationFunc:o})=>{o(),e.value="",n.value=[],t.value=[],a.value="",s&&(s.value=!0)},On={class:"app-container"},jn={class:"chat-wrapper"},Kn={key:0,class:"suggested-questions-container"},qn={class:"suggested-questions"},Wn=50,Nn=ae({__name:"index",setup(e){const n=b(null),t=b(!1),a=b(!1),s=b(!1),o=b(!1),l=b(null),c=b(!1),r=b([]),i=b(""),M=b(!1),h=b([]),k=b(""),F=b(1),v=b(20),W=b(!0),N=b(!1),m=b(!1),T=b(!0),w=b(!1),f=b(!0),_=b(!1),$=b(""),D=b(""),L=b(!1),z=b(""),C=b(null),E=b(""),R=b([]),G=b(""),V=b(null),Q=b(null),B=b(!1),I=b(!0),He=b(["介绍一下金钟集团","金钟集团有哪些产品","金钟集团的优势"]),Ie=new URLSearchParams(window.location.search),xe=Ie.get("userId"),Ve=Ie.get("userName");console.log("从URL获取的参数:",{userId:xe,userName:Ve}),be(()=>{dn(),document.documentElement.setAttribute("theme-mode","light"),Me()});const Je=ce(()=>{const d=h.value.find(u=>u.id===k.value);return Ke(d,15)}),Qe=ce(()=>Pn(h.value)),Me=async()=>{try{i.value=await Kt()}catch(d){console.error("系统提示词加载失败:",d)}m.value=!0;try{const d=await fe({limit:20,sort_by:"-updated_at"});if(d&&Array.isArray(d)){h.value=d,T.value=d.length>=20;const u=await Et();u?(k.value=u,I.value=!1,await Ce(u)):(k.value="",r.value=[],I.value=!0,B.value=!1),d.length===0&&(k.value="",r.value=[],I.value=!0,B.value=!1)}else console.error("服务器返回的会话列表数据格式不正确:",d),k.value="",r.value=[],I.value=!0,B.value=!1}catch(d){console.error("获取服务器会话列表失败:",d),k.value="",r.value=[],I.value=!0,B.value=!1}finally{m.value=!1}},Ce=async(d,u=!0,g=null)=>{if(!d)return console.error("会话ID为空，无法加载历史消息"),!1;try{N.value=!u,u&&(B.value=!0),u&&(R.value=[]),u&&(F.value=1,W.value=!0,r.value=[]);const q={page:F.value,pageSize:v.value,signal:g},J=await Ge(d,q);if(g!=null&&g.aborted||d!==k.value)return console.log("加载请求已中断或会话已切换，不更新UI"),!1;if(J.length>0){if(u?r.value=J:r.value=[...J,...r.value],W.value=J.length>=v.value,u&&J.length>0){const te=J.filter(P=>P.role==="assistant"&&P.id);if(te.length>0){const X=te[te.length-1].id.replace("_assistant","");Fe(X)}}}else u&&(r.value=[]),W.value=!1;return r.value&&Array.isArray(r.value)&&r.value.length>0,!0}catch(q){return console.error("加载对话历史消息失败:",q),W.value=!1,u&&(r.value=[]),!1}finally{N.value=!1,B.value=!1}},Xe=Ae(async(d,u)=>{try{d===k.value&&await Ce(d,!0,u.signal)}catch(g){g.name!=="AbortError"&&console.error("加载对话内容失败:",g),B.value=!1}finally{Q.value===u&&(Q.value=null)}},300),Ye=async d=>{const u=d.value;if(typeof u=="string"&&u.startsWith("delete-")){const g=u.substring(7);z.value=g,L.value=!0;return}if(u==="new"){we({currentConversationId:k,chatList:r,suggestedQuestions:R,suggestedQuestionsConversationId:G,isNewConversation:I,resetConversationFunc:pe});return}if(u!==k.value){if(R.value=[],G.value="",k.value=u,B.value=!0,r.value=[],I.value=!1,V.value&&clearTimeout(V.value),Q.value)try{Q.value.abort(),console.log("已取消之前的对话加载请求")}catch(q){console.error("取消之前的请求失败:",q)}const g=new AbortController;Q.value=g,Xe(u,g)}},Ze=async()=>{if(!(!W.value||!k.value||N.value))try{N.value=!0,F.value+=1,await Ce(k.value,!1)}finally{N.value=!1}},et=d=>{var g;(((g=d.detail)==null?void 0:g.scrollTop)||0)<=Wn&&W.value&&k.value&&!N.value&&Ze()},tt=(d,{index:u})=>{},nt=async function(){await zt(),we({currentConversationId:k,chatList:r,suggestedQuestions:R,suggestedQuestionsConversationId:G,isNewConversation:I,resetConversationFunc:pe})},st=async function(){try{if(!t.value&&!a.value){console.log("请求已经停止，不再执行中断操作");return}t.value=!1,a.value=!1,c.value=!0;const d=r.value[0];En(d,{loading:t,isStreamLoad:a});const u=n.value;n.value=null;const g=C.value;if(C.value=null,g)try{await zn(g,xe)}catch(q){console.error("API停止请求失败:",q)}if(u)try{u()}catch(q){console.error("中断请求时出错:",q)}}catch(d){console.error("停止请求时发生错误:",d),t.value=!1,a.value=!1,n.value=null,C.value=null}},at=function(d,u){const g=u.index;if(d==="good")s.value=!s.value,o.value=!1;else if(d==="bad")o.value=!o.value,s.value=!1;else if(d==="replay"){const q=r.value[g+1].content;Se(q)}},Se=function(d){if(a.value)return;let u="",g=[];if(typeof d=="string"?u=d:typeof d=="object"&&(u=d.message||"",g=d.files||[]),!u&&g.length===0)return;I.value=!1;const q=Rt(u,g);r.value.unshift(q);const J=Bt(!0);r.value.unshift(J),ot(u,g)},ot=async(d,u=[])=>{var Le;t.value=!0,a.value=!0,c.value=!1,C.value=null,E.value=null;const g=r.value[0],{handleReasoningUpdate:q,handleMessageUpdate:J,handleFileEvent:te,handleWorkflowSteps:P}=Un(),X=((Le=r.value[1])==null?void 0:Le.role)==="user"?r.value[1].content:d,re=Dt(r.value,X,i.value),{signal:ke,abortRequest:ht}=Ln();n.value=ht;try{const de={signal:ke,conversation_id:k.value||"",files:u.length>0?u:void 0};await jt(re,{onReasoning:O=>{!t.value||!a.value||q(g,O,c)},onMessage:O=>{!t.value||!a.value||J(g,O,c,M,Ue,l)},onFileEvent:O=>{!t.value||!a.value||te(g,O)},onError:O=>{console.error("API请求出错:",O),Y.error(O||"请求出错"),t.value=!1,a.value=!1,g.loading=!1,g.isStreamLoad=!1,g.content=`请求失败: ${O}`},onComplete:(O,$e)=>{console.log("请求完成, 成功:",O,$e),t.value=!1,a.value=!1,g&&(g.loading=!1,g.isStreamLoad=!1),O?k.value&&Ft(k.value,{messages:r.value,onComplete:ve=>{if(!ve){console.log("自动重命名完成，但未返回标题");return}console.log("自动重命名完成，新标题:",ve),h.value=h.value.map(Te=>Te.id===k.value?{...Te,name:ve}:Te)}}).catch(ve=>{console.error("自动重命名过程出错:",ve)}):(console.warn("请求未成功完成:",$e),g&&(g.content||(g.content=`请求未完成: ${$e||"未知原因"}`))),At(()=>{l.value&&Ue(l.value,!0)})},onConversationIdChange:O=>{console.log("会话ID更新:",O),O&&O!==k.value&&(k.value=O,mt())},onMessageIdChange:O=>{E.value=O,O&&g&&g.role==="assistant"&&ft(O)},onTaskIdChange:O=>{C.value=O},onWorkflowSteps:O=>{P(O,r,t,c)}},de)}catch(de){console.error("聊天请求失败:",de),t.value=!1,a.value=!1,g&&(g.loading=!1,g.isStreamLoad=!1,g.content=`聊天请求失败: ${de.message||"未知错误"}`),Y.error("聊天请求失败: "+(de.message||"未知错误"))}},rt=async()=>{if(!(!T.value||w.value))try{w.value=!0;const d=h.value.length>0?h.value[h.value.length-1].id:null;if(!d){T.value=!1;return}const u=await fe({last_id:d,limit:20,sort_by:"-updated_at"});u&&Array.isArray(u)&&u.length>0?(h.value=[...h.value,...u],T.value=u.length>=20):T.value=!1}catch(d){console.error("加载更多会话失败:",d)}finally{w.value=!1}},De=()=>{we({currentConversationId:k,chatList:r,suggestedQuestions:R,suggestedQuestionsConversationId:G,isNewConversation:I,resetConversationFunc:pe})},lt=async({conversationId:d,name:u})=>{try{const g=await ne(d,{name:u});h.value=h.value.map(q=>q.id===d?{...q,name:g.name||u}:q)}catch(g){console.error("重命名对话失败:",g)}},it=({conversationId:d})=>{const u=h.value.find(g=>g.id===d);u&&(h.value=h.value.filter(g=>g.id!==d),h.value.unshift(u))},ct=({conversationId:d})=>{D.value=d;const u=h.value.find(g=>g.id===d);u&&($.value=u.name||Ke(u,100)),_.value=!0},Re=()=>{D.value&&$.value.trim()&&lt({conversationId:D.value,name:$.value.trim()}),_.value=!1,$.value="",D.value=""},ut=()=>{_.value=!1,$.value="",D.value=""},dt=async()=>{if(!z.value){L.value=!1;return}try{const d=await Lt(z.value);h.value=h.value.filter(u=>u.id!==z.value),k.value===z.value&&we({currentConversationId:k,chatList:r,suggestedQuestions:R,suggestedQuestionsConversationId:G,isNewConversation:I,resetConversationFunc:pe})}catch(d){console.error("删除对话失败:",d)}finally{L.value=!1,z.value=""}},vt=()=>{L.value=!1,z.value=""},Be=d=>{Se(d),R.value=[],G.value=""},Fe=async d=>{if(d)try{const u=await Ut(d);u&&Array.isArray(u)&&u.length>0?(R.value=u,G.value=k.value):R.value=[]}catch(u){console.error("获取建议问题失败:",u),R.value=[]}},ft=Ae(d=>{Fe(d)},300),mt=Ae(async()=>{try{const d=await fe({limit:20,sort_by:"-updated_at"});d&&Array.isArray(d)&&(h.value=d,T.value=d.length>=20)}catch(d){console.error("刷新会话列表失败:",d)}},500),gt=()=>{f.value=!f.value};qe(()=>{V.value&&clearTimeout(V.value),Q.value&&Q.value.abort()});const pt=d=>{console.log("模型已切换，立即显示加载状态并准备加载新数据:",d),B.value=!0,m.value=!0,r.value=[],R.value=[],G.value="",Me()};return(d,u)=>{const g=x("t-tag"),q=x("t-chat"),J=x("t-input"),te=x("t-dialog");return y(),U("div",On,[p(yn,{visible:f.value,"onUpdate:visible":u[0]||(u[0]=P=>f.value=P),"current-conversation-id":k.value,"grouped-conversations":Qe.value,"has-more-conversations":T.value,"loading-more-conversations":w.value,"is-loading":m.value,onSelect:Ye,onNewConversation:De,onLoadMore:rt,onRenameConversation:ct,onPinConversation:it},null,8,["visible","current-conversation-id","grouped-conversations","has-more-conversations","loading-more-conversations","is-loading"]),S("div",{class:ie(["main-content",{"sidebar-open":f.value,"sidebar-closed":!f.value}])},[p(Zt,{title:Je.value,"sidebar-visible":f.value,onOpenDrawer:gt,onNewConversation:De,onModelChanged:pt},null,8,["title","sidebar-visible"]),S("div",jn,[p(le,{name:"fade"},{default:A(()=>[p(q,{class:"chat-container",ref_key:"chatRef",ref:l,layout:"both","clear-history":!1,onClear:nt,onScroll:et},{footer:A(()=>[p(le,{name:"suggestions-slide"},{default:A(()=>[R.value.length>0?(y(),U("div",Kn,[S("div",qn,[(y(!0),U(ee,null,se(R.value,(P,X)=>(y(),K(g,{key:X,theme:"primary",variant:"light",class:"question-tag",size:"medium",onClick:re=>Be(P)},{default:A(()=>[We(Z(P),1)]),_:2},1032,["onClick"]))),128))])])):H("",!0)]),_:1}),p(Qt,{loading:t.value,onSend:Se,onStop:st},null,8,["loading"])]),default:A(()=>[B.value?(y(),K(le,{key:0,name:"skeleton-fade",appear:""},{default:A(()=>[p(Fn)]),_:1})):r.value.length>0?(y(),K(Tt,{key:1,name:"chat-items",appear:""},{default:A(()=>[(y(!0),U(ee,null,se(r.value,(P,X)=>(y(),K(In,{key:X,avatar:P.avatar,name:P.name,role:P.role,datetime:P.datetime,content:P.content,reasoning:P.reasoning,"is-first-message":X===0,loading:t.value,"first-token-received":c.value,"is-stream-load":a.value,"is-good":s.value,"is-bad":o.value,files:P.files,"workflow-steps":P.workflowSteps,style:$t({"--item-index":r.value.length-X}),onReasoningExpandChange:re=>tt(re,{index:X}),onOperation:(re,ke)=>at(re,{index:X,e:ke})},null,8,["avatar","name","role","datetime","content","reasoning","is-first-message","loading","first-token-received","is-stream-load","is-good","is-bad","files","workflow-steps","style","onReasoningExpandChange","onOperation"]))),128))]),_:1})):I.value?(y(),K(le,{key:2,name:"welcome-fade",appear:""},{default:A(()=>[p(Dn,{"suggested-questions":He.value,logoSrc:"/static/images/logo.png",onQuestionClick:Be},null,8,["suggested-questions"])]),_:1})):H("",!0)]),_:1},512)]),_:1})])],2),p(te,{width:"35%",visible:_.value,"onUpdate:visible":u[2]||(u[2]=P=>_.value=P),header:"重命名对话","confirm-btn":{content:"确定",theme:"primary"},"cancel-btn":{content:"取消",theme:"default"},onConfirm:Re,onClose:ut},{default:A(()=>[p(J,{modelValue:$.value,"onUpdate:modelValue":u[1]||(u[1]=P=>$.value=P),type:"text",maxlength:100,placeholder:"请输入新名称",clearable:"",autofocus:"",onEnter:Re},null,8,["modelValue"])]),_:1},8,["visible"]),p(te,{width:"35%",visible:L.value,"onUpdate:visible":u[3]||(u[3]=P=>L.value=P),header:"删除对话","confirm-btn":{content:"确定",theme:"danger"},"cancel-btn":{content:"取消",theme:"default"},onConfirm:dt,onClose:vt},{default:A(()=>u[4]||(u[4]=[S("p",{class:"dialog-content"},"确定要删除该对话吗？此操作不可恢复。",-1)])),_:1},8,["visible"])])}}}),Vn=Object.freeze(Object.defineProperty({__proto__:null,default:Nn},Symbol.toStringTag,{value:"Module"}));export{j as A,_e as c,Vn as i};
//# sourceMappingURL=index.D657WQOy.js.map
