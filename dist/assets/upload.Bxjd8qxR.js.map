{"version":3,"file":"upload.Bxjd8qxR.js","sources":["../../src/app/dataset/upload.vue"],"sourcesContent":["<template>\n    <div class=\"dataset-upload-container\">\n      <t-breadcrumb class=\"breadcrumb\">\n        <t-breadcrumb-item @click=\"backToDetail\">知识库文档</t-breadcrumb-item>\n        <t-breadcrumb-item>上传文档</t-breadcrumb-item>\n      </t-breadcrumb>\n      \n      <t-card title=\"上传文档\">\n        <t-loading :loading=\"loading\">\n          <t-form class=\"upload-form\" label-width=\"120px\">\n            <t-form-item label=\"文档文件\" name=\"file\">\n              <t-input v-if=\"selectedFileName\" :value=\"selectedFileName\" readonly placeholder=\"已选择文件\" :style=\"{ marginBottom: '8px' }\">\n                <template #suffix>\n                  <t-icon name=\"close-circle-filled\" @click=\"clearSelectedFile\" style=\"cursor: pointer;\" />\n                </template>\n              </t-input>\n              <t-button v-if=\"!selectedFileName\" @click=\"openFileSelector\">\n                选择文件\n              </t-button>\n              <input type=\"file\" ref=\"fileInput\" style=\"display: none;\" accept=\".txt,.md,.mdx,.pdf,.html,.htm,.xlsx,.xls,.docx,.csv\" @change=\"onFileSelected\" />\n            </t-form-item>\n            \n            <t-form-item>\n              <div class=\"file-limits\">\n                支持的文件类型：TXT、MD、MDX、PDF、HTML、XLSX、XLS、DOCX、CSV、HTM，单个文件不超过15MB\n              </div>\n            </t-form-item>\n            \n            <t-form-item v-if=\"isUploading\">\n              <t-progress :percentage=\"uploadProgress\" :color=\"{ from: '#0052D9', to: '#00A870' }\" />\n              <div class=\"upload-status\">\n                <span>状态: {{ uploadStatusText }}</span>\n                <span v-if=\"indexingStatus\">已处理: {{ indexingStatus.completed_segments || 0 }}/{{ indexingStatus.total_segments || 0 }} 段</span>\n              </div>\n            </t-form-item>\n            \n            <t-form-item>\n              <t-space>\n                <t-button theme=\"primary\" @click=\"uploadSelectedFile\" :loading=\"loading\" :disabled=\"!selectedFile || isUploading\">上传</t-button>\n                <t-button theme=\"default\" @click=\"backToDetail\">取消</t-button>\n              </t-space>\n            </t-form-item>\n          </t-form>\n        </t-loading>\n      </t-card>\n\n      <div class=\"form-actions\">\n        <t-button theme=\"default\" @click=\"backToDetail\">返回文档列表</t-button>\n      </div>\n    </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, onMounted, onUnmounted } from 'vue';\nimport { useRoute, useRouter } from 'vue-router';\nimport { MessagePlugin } from 'tdesign-vue-next';\nimport { createDocumentByFile, getDocumentIndexingStatus } from '/static/app/api/dataset.js';\n\nconst route = useRoute();\nconst router = useRouter();\nconst datasetId = ref(route.params.id);\nconst loading = ref(false);\n\n// 文件选择相关\nconst fileInput = ref(null);\nconst selectedFile = ref(null);\nconst selectedFileName = ref('');\n\n// 上传状态相关\nconst isUploading = ref(false);\nconst uploadProgress = ref(0);\nconst uploadStatusText = ref('准备中');\nconst indexingStatus = ref(null);\nconst batchId = ref('');\nconst statusCheckInterval = ref(null);\n\n// 文件表单默认配置\nconst fileForm = ref({\n  indexing_technique: 'high_quality',\n  doc_form: 'hierarchical_model',\n  doc_language: 'Chinese',\n  embedding_model: 'bge-m3:latest',\n  embedding_model_provider: 'langgenius/ollama/ollama',\n  retrieval_model: {\n    search_method: 'hybrid_search',\n    reranking_enable: true,\n    reranking_model: {\n      reranking_provider_name: 'langgenius/xinference/xinference',\n      reranking_model_name: 'bge-reranker-v2-m3'\n    },\n    top_k: 8,\n    score_threshold_enabled: true,\n    score_threshold: 0.15,\n    reranking_mode: 'reranking_model',\n    weights: {\n      weight_type: 'customized',\n      vector_setting: {\n        vector_weight: 0.7,\n        embedding_provider_name: '',\n        embedding_model_name: ''\n      },\n      keyword_setting: {\n        keyword_weight: 0.3\n      }\n    }\n  },\n  process_rule: {\n    mode: 'hierarchical',\n    rules: {\n      pre_processing_rules: [\n        { id: 'remove_extra_spaces', enabled: true },\n        { id: 'remove_urls_emails', enabled: false }\n      ],\n      segmentation: {\n        separator: '\\n\\n',\n        max_tokens: 500\n      },\n      parent_mode: 'paragraph',\n      subchunk_segmentation: {\n        separator: '\\n',\n        max_tokens: 200\n      }\n    }\n  }\n});\n\n// 打开文件选择器\nconst openFileSelector = () => {\n  fileInput.value.click();\n};\n\n// 处理文件选择\nconst onFileSelected = (event) => {\n  const files = event.target.files;\n  if (files && files.length > 0) {\n    selectedFile.value = files[0];\n    selectedFileName.value = files[0].name;\n  }\n};\n\n// 清除已选择文件\nconst clearSelectedFile = () => {\n  selectedFile.value = null;\n  selectedFileName.value = '';\n  if (fileInput.value) {\n    fileInput.value.value = '';\n  }\n};\n\n// 检查上传状态\nconst checkUploadStatus = async () => {\n  if (!batchId.value) return;\n  \n  try {\n    const response = await getDocumentIndexingStatus(datasetId.value, batchId.value);\n    if (response && response.data && response.data.length > 0) {\n      indexingStatus.value = response.data[0];\n      \n      // 更新进度信息\n      const status = indexingStatus.value.indexing_status;\n      uploadStatusText.value = getStatusText(status);\n      \n      // 计算进度百分比\n      if (indexingStatus.value.total_segments > 0) {\n        uploadProgress.value = Math.floor((indexingStatus.value.completed_segments / indexingStatus.value.total_segments) * 100);\n      }\n      \n      // 如果已完成或出错，停止检查\n      if (status === 'completed' || status === 'error') {\n        clearInterval(statusCheckInterval.value);\n        isUploading.value = false;\n        \n        if (status === 'completed') {\n          MessagePlugin.success('文档处理完成');\n          setTimeout(() => {\n            router.push(`/app/dataset/detail/${datasetId.value}`);\n          }, 1500);\n        } else if (status === 'error') {\n          MessagePlugin.error(`处理失败: ${indexingStatus.value.error || '未知错误'}`);\n        }\n      }\n    }\n  } catch (error) {\n    console.error('获取上传状态失败:', error);\n  }\n};\n\n// 获取状态文本\nconst getStatusText = (status) => {\n  const statusMap = {\n    'waiting': '等待中',\n    'queuing': '排队中',\n    'indexing': '处理中',\n    'completed': '已完成',\n    'error': '错误'\n  };\n  return statusMap[status] || status;\n};\n\n// 上传选中的文件\nconst uploadSelectedFile = async () => {\n  if (!selectedFile.value) {\n    MessagePlugin.warning('请先选择一个文件');\n    return;\n  }\n  \n  // 检查文件大小，限制为15MB\n  if (selectedFile.value.size > 15 * 1024 * 1024) {\n    MessagePlugin.error('文件大小不能超过15MB');\n    return;\n  }\n  \n  try {\n    loading.value = true;\n    isUploading.value = true;\n    uploadProgress.value = 0;\n    uploadStatusText.value = '上传中';\n    \n    const formData = new FormData();\n    \n    // 添加文件\n    formData.append('file', selectedFile.value);\n    \n    // 准备数据对象\n    const dataObj = {...fileForm.value};\n    \n    console.log('准备上传文件:', selectedFile.value.name, '配置:', dataObj);\n    formData.append('data', JSON.stringify(dataObj));\n    \n    // 上传文件\n    const result = await createDocumentByFile(datasetId.value, formData);\n    console.log('文件上传成功:', result);\n    \n    // 提示成功并返回列表页\n    MessagePlugin.success('文件已上传，正在处理中');\n    router.push(`/app/dataset/detail/${datasetId.value}`);\n  } catch (error) {\n    console.error('文件上传失败:', error);\n    MessagePlugin.error('文件上传失败');\n    isUploading.value = false;\n  } finally {\n    loading.value = false;\n  }\n};\n\n// 返回详情页\nconst backToDetail = () => {\n  // 如果正在上传，确认是否取消\n  if (isUploading.value) {\n    if (confirm('文件正在处理中，确定要离开吗？')) {\n      clearInterval(statusCheckInterval.value);\n      router.push(`/app/dataset/detail/${datasetId.value}`);\n    }\n  } else {\n    router.push(`/app/dataset/detail/${datasetId.value}`);\n  }\n};\n\n// 组件卸载时清理\nonUnmounted(() => {\n  if (statusCheckInterval.value) {\n    clearInterval(statusCheckInterval.value);\n  }\n});\n</script>\n\n<style lang=\"scss\">\n@import '/static/app/styles/variables.scss';\n\n.dataset-upload-container {\n  padding: $comp-paddingTB-l $comp-paddingLR-l;\n}\n\n.breadcrumb {\n  margin-bottom: $comp-margin-m;\n}\n\n.upload-form {\n  max-width: 800px;\n  margin: 0 auto;\n}\n\n.file-limits {\n  font-size: 12px;\n  color: rgba(0, 0, 0, 0.4);\n  line-height: 1.5;\n}\n\n.form-actions {\n  margin-top: 20px;\n  display: flex;\n  justify-content: center;\n}\n\n.upload-status {\n  margin-top: 8px;\n  display: flex;\n  justify-content: space-between;\n  color: rgba(0, 0, 0, 0.6);\n  font-size: 14px;\n}\n</style> "],"names":["route","useRoute","router","useRouter","datasetId","ref","loading","fileInput","selectedFile","selectedFileName","isUploading","uploadProgress","uploadStatusText","indexingStatus","statusCheckInterval","fileForm","openFileSelector","onFileSelected","event","files","clearSelectedFile","uploadSelectedFile","MessagePlugin","formData","dataObj","result","createDocumentByFile","error","backToDetail","onUnmounted"],"mappings":"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"}