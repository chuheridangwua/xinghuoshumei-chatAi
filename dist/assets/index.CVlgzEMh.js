const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/workflow.qDz-DR1Z.js","assets/vendor.CamtBdHc.js","assets/vendor.Y0ZZv602.css","assets/index.Dv8gzUbl.js","assets/index.DXkv32yV.css"])))=>i.map(i=>d[i]);
import{h as ae,j as w,c as j,n as K,m as S,F as ee,q as se,v as z,w as x,a as p,r as I,t as Y,u as ge,B as $e,T as yt,P as At,M as X,o as y,k as ce,x as we,y as ie,z as wt,A as le,C as bt,D as Ct,E as St,l as Je,G as kt,p as Oe,H as Ge,I as _t,J as Tt,K as xt}from"./vendor.CamtBdHc.js";import{a as Rt,_ as me}from"./index.Dv8gzUbl.js";const E={baseURL:"https://api.dify.ai/v1",workflowApiKey:"app-6aRhLAp4zAppCJus5ViMgOsh",datasetApiKey:"dataset-NU4Kg7Wtm1616AOnxnRAeFct",models:[{id:"DeepSeek-V3",name:"作文评分 AI 智能体",apiKey:"app-mJY5qTsLUXT3jLAKgfNrTbxP"},{id:"DeepSeek-R1",name:"星火深思(DeepSeek-R1)",apiKey:"app-2PAC8Jw4d0UxjZzFXL0nXRUa"}],defaultModel:"DeepSeek-V3",apiKey:"app-mJY5qTsLUXT3jLAKgfNrTbxP",staticResourceBase:"../static"},be=(e,n)=>{const a=`${E.baseURL}${e}`;return a.startsWith("http://")||a.startsWith("https://")?new URL(a):new URL(a,window.location.origin)},Ee=e=>{const n=E.models.find(t=>t.id===e);return n?(E.currentModel=e,E.apiKey=n.apiKey,console.log("已切换模型:",n.name),E):(console.error("未找到指定的模型:",e),null)},ue=()=>{const n=new URLSearchParams(window.location.search).get("userId");if(n)return localStorage.setItem("dify_user_id",n),n;let t=localStorage.getItem("dify_user_id");return t||(t="user_"+Math.random().toString(36).substring(2,15),localStorage.setItem("dify_user_id",t)),t},fe=async(e={})=>{try{const n=ue(),t=be("/conversations");t.searchParams.append("user",n),e.last_id&&t.searchParams.append("last_id",e.last_id),e.limit&&t.searchParams.append("limit",e.limit),e.sort_by&&t.searchParams.append("sort_by",e.sort_by);const a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E.apiKey}`}});if(!a.ok){const o=await a.text();throw new Error(`获取会话列表失败: ${a.status} ${o}`)}const s=await a.json();return s&&Array.isArray(s.data)&&s.data.sort((o,l)=>{const c=new Date(o.created_at||0);return new Date(l.created_at||0)-c}),s.data||[]}catch(n){return console.error("获取会话列表失败:",n),[]}},It=e=>{if(!e)return{content:"",reasoning:""};const n="<think>",t="</think>";let a="",s=e;if(e.includes(n)&&e.includes(t))try{const o=e.match(/<think>([\s\S]*?)<\/think>/);o&&o[1]&&(a=o[1].trim()),s=e.replace(/<think>[\s\S]*?<\/think>/,"").trim()}catch(o){console.error("提取思考内容时出错:",o),s=e}return{content:s,reasoning:a}},We=async(e,n={})=>{if(!e)return[];try{const t=ue(),{page:a=1,pageSize:s=20}=n,o=be("/messages");o.searchParams.append("conversation_id",e),o.searchParams.append("user",t),o.searchParams.append("page",a),o.searchParams.append("page_size",s);const l=await fetch(o,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E.apiKey}`},signal:n.signal});if(!l.ok){const r=await l.text();throw new Error(`获取会话历史失败: ${l.status} ${r}`)}const c=await l.json();return c&&c.data&&Array.isArray(c.data)?Mt(c.data,e):[]}catch(t){throw t.name!=="AbortError"&&console.error("获取服务器会话历史失败:",t),t}},Mt=(e,n)=>{const t=[];for(const a of e){if(a.query){const s={avatar:"https://tdesign.gtimg.com/site/avatar.jpg",name:"自己",datetime:new Date(a.created_at*1e3).toLocaleString(),content:a.query,role:"user",id:a.id+"_user"};a.files&&Array.isArray(a.files)&&a.files.length>0&&(s.files=a.files.map(o=>({id:o.id,filename:o.filename||o.name,type:o.type||"document",size:o.size||0,url:o.url||""}))),a.message_files&&Array.isArray(a.message_files)&&a.message_files.length>0&&(s.files||(s.files=[]),a.message_files.forEach(o=>{s.files.push({id:o.id,filename:o.filename||o.name,type:o.type||"document",size:o.size||0,url:o.url||""})})),t.push(s)}if(a.answer){const{content:s,reasoning:o}=It(a.answer),l={avatar:`${E.staticResourceBase}/files/favicon.jpg`,name:"星火数媒",datetime:new Date(a.created_at*1e3).toLocaleString(),content:s||"",role:"assistant",...o?{reasoning:o}:{},id:a.id+"_assistant"};t.push(l)}}return t.reverse(),t},Ft=(e,n,t,a=10)=>{let s=!1,o=[],l=n;if(!l&&e&&e.length>0){for(let r=0;r<e.length;r++)if(e[r].role==="user"&&e[r].content.trim()!==""){l=e[r].content;break}}let c=new Set;for(let r=e.length-1;r>=0;r--){const i=e[r];if((i.role==="user"||i.role==="assistant"||i.role==="system")&&i.content.trim()!==""){if(i.role==="user"&&i.content===l)continue;i.role==="system"&&(s=!0);const M=`${i.role}:${i.content}`;c.has(M)||(o.push({role:i.role,content:i.content}),c.add(M))}}if(l&&l.trim()!==""){const r=`user:${l}`;c.has(r)||o.push({role:"user",content:l})}return o.length>a&&(o=o.slice(-a)),!s&&t&&o.unshift({role:"system",content:t}),o},Pe=e=>{e&&e.scrollToBottom({behavior:"smooth"})},Lt=(e,n=[])=>{const t={avatar:"https://tdesign.gtimg.com/site/avatar.jpg",name:"自己",datetime:new Date().toLocaleString(),content:e||"",role:"user"};return n&&Array.isArray(n)&&n.length>0&&(t.files=n.map(a=>({id:a.upload_file_id||a.id,filename:a.filename||a.name||"未命名文件",type:a.type||"document",size:a.size||0,url:a.url||""}))),t},Bt=(e=!1)=>{const n={avatar:`${E.staticResourceBase}/files/favicon.jpg`,name:"星火数媒",datetime:new Date().toLocaleString(),content:"",role:"assistant"};return e?{...n,reasoning:"思考中..."}:n},Ut=async(e,n={})=>{try{if(!e)return console.log("会话ID为空，跳过自动重命名"),!1;let t=n.messages||[];t.length||(t=await We(e));const a=t.length,s=Math.floor(a/2),l=(await fe()).find(r=>r.id===e);if((s<=3||s>=5&&s%5===0)&&(!l||!l.name||l.name.startsWith("新对话")||l.name==="New conversation")){console.log("[自动重命名] 需要重命名对话:",e,"当前轮数:",s);try{let r="";const i=[...t].sort((m,T)=>{if(m.datetime&&T.datetime)return m.datetime-T.datetime;if(m.created_at&&T.created_at){const A=typeof m.created_at=="string"?new Date(m.created_at).getTime():m.created_at*1e3,f=typeof T.created_at=="string"?new Date(T.created_at).getTime():T.created_at*1e3;return A-f}return 0}),M=[];let h={user:null,assistant:null};for(const m of i)m.role==="user"?(h.user!==null&&(M.push({...h}),h={user:null,assistant:null}),h.user=m.content):m.role==="assistant"&&(h.assistant!==null&&(M.push({...h}),h={user:null,assistant:null}),h.assistant=m.content);(h.user!==null||h.assistant!==null)&&M.push(h);const k=M.slice(-5);for(let m=0;m<k.length;m++){const T=k[m];r+=`[第${m+1}轮]
`,T.user&&(r+=`用户: ${T.user}
`),T.assistant&&(r+=`助手: ${T.assistant}
`),r+=`
`}if(console.log("[自动重命名] 提取的对话内容:",r.length,"字节"),!r.trim()){console.log("[自动重命名] 消息内容为空，使用默认重命名方式");const m=await ne(e,{auto_generate:!0});return m.success||console.warn("[自动重命名] 默认重命名失败:",m.message),m.success}const{generateArticleTitle:U}=await Rt(()=>import("./workflow.qDz-DR1Z.js"),__vite__mapDeps([0,1,2,3,4]));let v=!1,O="";const G=await U(r,{onOutput:async m=>{if(m&&m.text){const T=m.text.trim();if(console.log("[自动重命名] 生成的标题:",T),T){v=!0,O=T;const A=await ne(e,{name:T});if(A.success)console.log("[自动重命名] 重命名成功:",T),typeof n.onComplete=="function"&&n.onComplete(T);else{console.error("[自动重命名] 重命名失败:",A.message),console.log("[自动重命名] 尝试使用默认方式重命名");const f=await ne(e,{auto_generate:!0});f.success&&typeof n.onComplete=="function"&&n.onComplete(f.name||"")}}}},onError:async m=>{console.error("[自动重命名] 生成标题失败:",m);const T=await ne(e,{auto_generate:!0});T.success&&typeof n.onComplete=="function"&&n.onComplete(T.name||"")},onComplete:async m=>{if(m&&!v){console.warn("[自动重命名] 工作流执行成功但未生成标题，使用默认重命名");const T=await ne(e,{auto_generate:!0});T.success&&typeof n.onComplete=="function"&&n.onComplete(T.name||"")}}},{responseMode:"streaming",userId:"title-generator"});return v?(console.log("[自动重命名] 标题已生成并应用:",O),!0):G.success?!0:(console.warn("[自动重命名] 生成标题工作流执行失败，使用默认重命名"),(await ne(e,{auto_generate:!0})).success)}catch(r){return console.error("[自动重命名] 使用工作流生成标题失败，回退到默认方式:",r),(await ne(e,{auto_generate:!0})).success}}return!1}catch(t){return console.error("[自动重命名] 自动重命名失败:",t),!1}},ne=async(e,n={})=>{const t=ue();try{const a={user:t};n.auto_generate?a.auto_generate=!0:n.name&&(a.name=n.name),console.log(`[重命名] 尝试重命名会话 ${e}`,{auto_generate:n.auto_generate,name:n.name,API地址:`${E.baseURL}/conversations/${e}/name`});const s=await fetch(`${E.baseURL}/conversations/${e}/name`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E.apiKey}`},body:JSON.stringify(a)}),o=await s.text();let l;try{l=JSON.parse(o)}catch{l=o}return s.ok?(console.log(`[重命名] 会话重命名成功: ${e}`,l),{success:!0,...l}):(console.error(`[重命名] 重命名会话失败: ${s.status}`,l),{success:!1,status:s.status,error:l,message:`重命名会话失败: ${s.status}`})}catch(a){return console.error("[重命名] 重命名会话错误:",a),{success:!1,error:a,message:a.message||"重命名会话失败"}}},Dt=async e=>{const n=ue();try{const t={user:n},a=await fetch(`${E.baseURL}/conversations/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E.apiKey}`},body:JSON.stringify(t)});if(!a.ok){const o=await a.text();throw new Error(`删除会话失败: ${a.status} ${o}`)}return await a.json()}catch(t){throw console.error("删除会话错误:",t),t}},$t=async()=>{try{const e=await fe({limit:1});return e&&e.length>0?e[0].id:""}catch(e){return console.error("获取当前会话失败:",e),""}},Et=async e=>{try{return!0}catch(n){return console.error("清空聊天记录失败:",n),!1}},Pt=async e=>{try{const n=ue(),t=be(`/messages/${e}/suggested`);t.searchParams.append("user",n);const a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E.apiKey}`}});if(!a.ok)throw new Error(`获取建议问题失败: ${a.status}`);const s=await a.json();return s&&s.data&&Array.isArray(s.data)?s.data:[]}catch(n){return console.error("获取建议问题失败:",n),[]}};E.baseURL,E.apiKey;const jt=async(e,n={})=>{try{const t=ue(),a=be("/chat-messages"),o={query:e[e.length-1].content,user:t,response_mode:"streaming",inputs:{}};n.conversation_id&&(o.conversation_id=n.conversation_id),n.files&&Array.isArray(n.files)&&n.files.length>0&&(o.files=n.files),console.log("[Request] 发送请求:",o);const l=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${E.apiKey}`},body:JSON.stringify(o),signal:n.signal});if(!l.ok)throw new Error(`请求失败: ${l.status}`);return l}catch(t){throw console.error("发送聊天请求失败:",t),t}},Qt=async(e,n={})=>{var h,k,U;const{onMessage:t,onError:a,onComplete:s,onReasoning:o,onWorkflowSteps:l,onConversationIdChange:c,onMessageIdChange:r,onTaskIdChange:i,onFileEvent:M}=n;try{if(e.signal&&e.signal.aborted){console.log("[Stream] 请求已中断"),s==null||s(!1,"请求已中断");return}const v=await e;if(!v.ok){const _=await v.text();throw console.error("[Stream] API请求失败:",v.status,_),new Error(`API请求失败: ${v.status} ${_}`)}console.log("[Stream] 开始处理流式响应");const O=v.body.getReader(),G=new TextDecoder;let m="",T=!1,A=null,f=[],b=null;try{for(;;){if(e.signal&&e.signal.aborted){console.log("[Stream] 检测到请求中断信号，停止处理流");break}const{done:_,value:F}=await O.read();if(_){console.log("[Stream] 流读取完成");break}m+=G.decode(F,{stream:!0});const D=m.split(`
`);m=D.pop()||"";for(const P of D)if(!(!P.trim()||!P.startsWith("data: ")))try{const C=JSON.parse(P.substring(6));if(C.conversation_id&&!A&&(A=C.conversation_id,console.log(`%c[Stream] 获取会话ID: ${A}`,"color: #9C27B0; font-weight: bold;"),c&&c(A)),C.event==="message"){const $=C.answer||"";if($.includes("<think>")){T=!0;const L=$.replace("<think>","");console.log("%c[Stream] 进入思考模式","color: #FF9800; font-weight: bold;"),o==null||o(L)}else if($.includes("</think>")){const L=$.split("</think>");console.log("%c[Stream] 结束思考模式","color: #FF9800; font-weight: bold;"),o==null||o(L[0]),T=!1,L.length>1&&(t==null||t(L[1]))}else T?o==null||o($):t==null||t($)}else if(C.event==="message_end")console.log("%c[Stream] 收到消息结束事件: message_end","color: #4CAF50; font-weight: bold;"),C.message_id&&r&&r(C.message_id),C.task_id&&i&&i(C.task_id);else if(C.event==="message_file"){if(console.log("%c[Stream] 收到文件事件: message_file","color: #4CAF50; font-weight: bold;"),M&&C.file){const $={id:C.file.id,filename:C.file.filename||C.file.name,type:C.file.type||"document",size:C.file.size||0,url:C.file.url||""};M($)}}else if(C.event==="message_replace")console.log("%c[Stream] 收到消息替换事件: message_replace","color: #4CAF50; font-weight: bold;"),t==null||t(C.answer||"");else if(C.event==="tts_message")console.log("%c[Stream] 收到TTS事件: tts_message","color: #4CAF50; font-weight: bold;");else if(C.event==="tts_message_end")console.log("%c[Stream] 收到TTS结束事件: tts_message_end","color: #4CAF50; font-weight: bold;");else if(C.event==="workflow_started")console.log("%c[Stream] 收到工作流开始事件: workflow_started","color: #4CAF50; font-weight: bold;");else if(C.event==="node_started"){console.log("%c[Stream] 收到节点开始事件: node_started","color: #4CAF50; font-weight: bold;");const $=(h=C.data)==null?void 0:h.title,L=((k=C.data)==null?void 0:k.id)||`node-${f.length}`;if($){const W=B=>{const R=B.toLowerCase();return R==="开始"?"start":R.includes("http")||R.includes("请求")?"http":R.includes("条件")||R.includes("分支")?"condition":R.includes("时间")?"time":R.includes("搜索")?"search":R.includes("提取")||R.includes("参数")?"extract":R.includes("web")||R.includes("bocha")?"web":R.includes("文件")?"file":R.includes("模型")||R.includes("总结")?"model":R.includes("回复")?"reply":R.includes("错误")?"error":"default"},Z=((U=C.data)==null?void 0:U.type)||W($);if(console.log("%c[Stream Node Started]","color: #2196F3; font-weight: bold;",{title:$,type:Z,id:L}),b){const B=f.findIndex(R=>R.id===b);B!==-1&&(f[B].loading=!1,l&&l([...f]))}const V={title:$,node_type:Z,id:L,loading:!0};f.push(V),b=L,l&&l([...f])}}else if(C.event==="node_finished"){if(console.log("%c[Stream] 收到节点完成事件: node_finished","color: #4CAF50; font-weight: bold;"),b){const $=f.findIndex(L=>L.id===b);$!==-1&&(f[$].loading=!1,l&&l([...f])),b=null}}else C.event==="workflow_finished"?(console.log("%c[Stream] 收到工作流完成事件: workflow_finished","color: #4CAF50; font-weight: bold;"),f=f.map($=>({...$,loading:!1})),l&&l([...f]),f=[],b=null):C.event==="error"?(console.error("%c[Stream] 收到错误事件: error","color: #F44336; font-weight: bold;"),a==null||a(C.message||"流处理错误")):C.event==="ping"&&console.log("%c[Stream] 收到ping事件","color: #607D8B; font-style: italic;")}catch(C){console.error("%c[Stream] 解析流数据失败:","color: #F44336; font-weight: bold;",C)}}}catch(_){console.error("%c[Stream] 流处理过程中出错:","color: #F44336; font-weight: bold;",_);const F=_.message||"";if(_.name==="AbortError"||F.includes("aborted")||F.includes("abort")||F.includes("BodyStreamBuffer was aborted")||F.includes("message channel closed")||F.includes("listener indicated an asynchronous response")){console.log("%c[Stream] 请求被中断","color: #FF9800; font-weight: bold;"),s==null||s(!1,"请求处理过程已中断");return}throw _}finally{try{O.releaseLock(),console.log("[Stream] 读取器已释放")}catch(_){console.warn("[Stream] 释放读取锁时出错:",_)}}console.log("[Stream] 流处理完成"),s==null||s(!0)}catch(v){console.error("[Stream] 流式请求错误:",v),v.name==="AbortError"||v.message.includes("aborted")||v.message.includes("BodyStreamBuffer was aborted")?(console.log("[Stream] 请求中断错误"),s==null||s(!1,"请求已中断")):(console.error("[Stream] 请求失败错误"),a==null||a(v.message||"请求失败"),s==null||s(!1,v.message))}},qt=async(e,n={},t={})=>{var a,s,o,l,c,r,i,M,h,k,U,v,O,G;try{const m=t.conversation_id||"",T={...t,conversation_id:m};console.log("[Chat] 开始聊天请求",{conversationId:m,messageCount:e.length,hasSignal:!!t.signal});const A=jt(e,T);try{return console.log("[Chat] 开始处理流式响应"),await Qt(A,n),console.log("[Chat] 流式响应处理成功"),{success:!0}}catch(f){return console.error("[Chat] 流处理过程中出错:",f),f.name==="AbortError"||(a=f.message)!=null&&a.includes("aborted")||(s=f.message)!=null&&s.includes("message channel closed")||(o=f.message)!=null&&o.includes("BodyStreamBuffer was aborted")||(l=f.message)!=null&&l.includes("listener indicated an asynchronous response")?(console.log("[Chat] 流处理被中断"),(c=n.onComplete)==null||c.call(n,!1,"请求已中断"),{success:!1,aborted:!0,error:f}):(console.error("[Chat] 流处理失败:",f.message||"未知错误"),(r=n.onError)==null||r.call(n,f.message||"流处理失败"),(i=n.onComplete)==null||i.call(n,!1,f.message),{success:!1,error:f})}}catch(m){return console.error("[Chat] 聊天请求错误:",m),m.name==="AbortError"||(M=m.message)!=null&&M.includes("aborted")||(h=m.message)!=null&&h.includes("message channel closed")||(k=m.message)!=null&&k.includes("BodyStreamBuffer was aborted")||(U=m.message)!=null&&U.includes("listener indicated an asynchronous response")?(console.log("[Chat] 聊天请求被中断"),(v=n.onComplete)==null||v.call(n,!1,"请求已中断"),{success:!1,aborted:!0,error:m}):(console.error("[Chat] 聊天请求失败:",m.message||"未知错误"),(O=n.onError)==null||O.call(n,m.message||"请求失败"),(G=n.onComplete)==null||G.call(n,!1,m.message),{success:!1,error:m})}},zt=async()=>{try{const e=await fetch("/static/files/prompt-copy.json");if(e.ok){const n=await e.json();return JSON.stringify(n)}else return console.error(`加载系统提示词失败: ${e.status}`),{role:"您是一个助手",tools:{description:""},rules:[]}}catch(e){return console.error("加载系统提示词失败:",e),{role:"您是一个助手",tools:{description:""},rules:[]}}},pe=()=>{try{return!0}catch(e){return console.error("重置会话出错:",e),!1}},Jt={class:"chat-sender"},Ot={key:0,class:"uploaded-files"},Gt={class:"files-scroll-container"},Wt={class:"file-name"},Kt={class:"input-container"},Zt={class:"attach-button-wrapper"},Nt={key:1,class:"loading-container"},je=2*1024*1024,he=3,Vt=ae({__name:"ChatSender",props:{loading:{type:Boolean,default:!1}},emits:["send","stop"],setup(e,{emit:n}){const t=n,a=w(""),s=w(null),o=w(!1),l=w(0),c=w([]),r=["txt","md","mdx","pdf","html","xlsx","xls","docx","csv","htm","markdown"],i={txt:"document",md:"document",mdx:"document",markdown:"document",pdf:"document",html:"document",htm:"document",xlsx:"document",xls:"document",docx:"document",csv:"document"},M={document:"file-excel",default:"file"},h=b=>{const _=i[b.toLowerCase()]||"default";return M[_]||"file"},k=b=>{if(!b.trim()&&c.value.length===0)return;let _=b;const F=c.value.map(D=>({type:"document",transfer_method:"local_file",upload_file_id:D.id,filename:D.name,name:D.name,extension:D.extension,size:D.size}));t("send",{message:_,files:F}),c.value=[]},U=()=>{t("stop")},v=()=>{if(c.value.length>=he){X.warning(`最多只能上传${he}个附件`);return}s.value&&s.value.click()},O=b=>{c.value=c.value.filter((_,F)=>F!==b)},G=b=>{const F=["Bytes","KB","MB","GB"],D=Math.floor(Math.log(b)/Math.log(1024));return parseFloat((b/Math.pow(1024,D)).toFixed(2))+" "+F[D]},m=b=>{if(b.length<=10)return b;const _=b.slice(b.lastIndexOf(".")),F=b.slice(0,b.lastIndexOf("."));return F.length<=7?b:F.slice(0,7)+"..."+_},T=b=>{const _=b.slice((b.lastIndexOf(".")-1>>>0)+2).toLowerCase();return r.includes(_)},A=b=>c.value.some(_=>_.name===b),f=async b=>{const F=b.target.files;if(!F||F.length===0)return;const D=F[0];if(c.value.length>=he){X.warning(`最多只能上传${he}个附件`),s.value&&(s.value.value="");return}if(A(D.name)){X.warning(`文件"${D.name}"已存在`),s.value&&(s.value.value="");return}if(!T(D.name)){X.warning("暂不支持此类型的文件"),s.value&&(s.value.value="");return}if(D.size>je){X.warning(`文件大小不能超过${G(je)}`),s.value&&(s.value.value="");return}o.value=!0,l.value=0;try{const P=new FormData;P.append("file",D);const $=new URLSearchParams(window.location.search).get("userId");P.append("user",$||localStorage.getItem("dify_user_id")||"anonymous");const L=setInterval(()=>{l.value<90&&(l.value+=5)},100),W=await fetch(`${E.baseURL}/files/upload`,{method:"POST",headers:{Authorization:`Bearer ${E.apiKey}`},body:P});if(clearInterval(L),l.value=100,!W.ok)throw new Error(`上传失败: ${W.status} ${W.statusText}`);const Z=await W.json();c.value.push({id:Z.id,name:Z.name,size:Z.size,extension:Z.extension,mime_type:Z.mime_type}),X.success("上传成功")}catch(P){console.error("上传文件出错:",P),X.error(P.message||"上传文件失败")}finally{o.value=!1,s.value&&(s.value.value="")}};return(b,_)=>{const F=I("t-icon"),D=I("t-chat-input");return y(),j("div",Jt,[c.value.length>0?(y(),j("div",Ot,[S("div",Gt,[(y(!0),j(ee,null,se(c.value,(P,C)=>(y(),z(ge(yt),{key:C,theme:"default",variant:"light",shape:"round",size:"medium",class:"file-tag"},{default:x(()=>[p(F,{name:h(P.extension),class:"file-icon"},null,8,["name"]),S("span",Wt,Y(m(P.name)),1),p(ge($e),{theme:"default",variant:"text",size:"small",class:"close-btn",onClick:$=>O(C)},{default:x(()=>[p(F,{name:"close"})]),_:2},1032,["onClick"])]),_:2},1024))),128))])])):K("",!0),S("div",Kt,[S("div",Zt,[S("input",{type:"file",ref_key:"fileInput",ref:s,onChange:f,class:"file-input",accept:".txt,.md,.mdx,.pdf,.html,.xlsx,.xls,.docx,.csv,.htm,.markdown"},null,544),o.value?(y(),j("div",Nt,[p(ge(At),{theme:"circle",size:"40",percentage:l.value,color:{from:"#108ee9",to:"#87d068"}},null,8,["percentage"])])):(y(),z(ge($e),{key:0,theme:"default",variant:"text",class:"attachment-btn",onClick:v},{icon:x(()=>[p(F,{name:"attach",size:"22px"})]),_:1}))]),p(D,{modelValue:a.value,"onUpdate:modelValue":_[0]||(_[0]=P=>a.value=P),"stop-disabled":e.loading,"textarea-props":{placeholder:"请输入消息...",class:"custom-textarea"},onSend:k,onStop:U,autosize:""},null,8,["modelValue","stop-disabled"])])])}}}),Ht={class:"model-selector"},Xt={key:0,class:"model-name"},Yt=ae({__name:"HeaderNav",props:{title:{type:String,default:"新对话"},sidebarVisible:{type:Boolean,default:!1}},emits:["open-drawer","new-conversation","model-changed"],setup(e,{emit:n}){const t=n,a=w(E.defaultModel),s=ce(()=>E.models.find(c=>c.id===a.value)),o=ce(()=>E.models.map(c=>({content:c.name,value:c.id,prefixIcon:c.icon}))),l=c=>{const r=c.value;r!==a.value&&(a.value=r,Ee(r)&&t("model-changed",{modelId:r,model:s.value}))};return we(()=>{E.currentModel?a.value=E.currentModel:Ee(a.value)}),(c,r)=>{const i=I("t-icon"),M=I("t-button"),h=I("t-dropdown");return y(),j("div",{class:ie(["fixed-header",{"sidebar-open":e.sidebarVisible,"sidebar-closed":!e.sidebarVisible}])},[p(M,{variant:"text",class:ie(["menu-btn",{"menu-icon-visible":!e.sidebarVisible,"menu-icon-hidden":e.sidebarVisible}]),onClick:r[0]||(r[0]=k=>c.$emit("open-drawer"))},{default:x(()=>[p(i,{name:"menu"})]),_:1},8,["class"]),p(M,{variant:"text",class:ie(["menu-btn",{"menu-icon-visible":!e.sidebarVisible,"menu-icon-hidden":e.sidebarVisible}]),onClick:r[1]||(r[1]=k=>c.$emit("new-conversation"))},{default:x(()=>[p(i,{name:"chat-add"})]),_:1},8,["class"]),S("div",Ht,[p(h,{options:o.value,onClick:l,trigger:"click",maxColumnWidth:"300px"},{default:x(()=>[p(M,{variant:"text",class:"model-select-btn"},{default:x(()=>[s.value?(y(),j("span",Xt,Y(s.value.name),1)):K("",!0),p(i,{name:"chevron-down"})]),_:1})]),_:1},8,["options"])])],2)}}}),en={class:"conversation-group"},tn={class:"group-title"},nn={class:"conversation-text"},sn={class:"menu-item-content"},an={class:"menu-item-content"},on={class:"menu-item-content"},rn=ae({__name:"ConversationGroup",props:{title:{type:String,required:!0},conversations:{type:Array,required:!0},currentConversationId:{type:String,default:""}},emits:["select","pin-conversation","rename-conversation","delete-conversation"],setup(e,{emit:n}){const t=n,a=(o,l)=>{const c=o==null?void 0:o.value;if(c){if(c.startsWith("pin-")){t("pin-conversation",l);return}if(c.startsWith("rename-")){t("rename-conversation",l);return}if(c.startsWith("delete-")){t("delete-conversation",l);return}}},s=(o,l=20)=>o?o.name?o.name.length>l?o.name.substring(0,l)+"...":o.name:o.last_message&&o.last_message.trim()?o.last_message.length>l?o.last_message.substring(0,l)+"...":o.last_message:`对话 ${o.id.substring(0,8)}...`:"新对话";return(o,l)=>{const c=I("t-icon"),r=I("t-button"),i=I("t-dropdown-item"),M=I("t-dropdown-menu"),h=I("t-dropdown"),k=I("t-list-item");return y(),j("div",en,[S("div",tn,Y(e.title),1),(y(!0),j(ee,null,se(e.conversations,U=>(y(),z(k,{key:U.id,onClick:v=>o.$emit("select",U.id),class:ie(["conversation-item",{active:U.id===e.currentConversationId}])},{default:x(()=>[p(c,{name:"chat",class:"conversation-icon"}),S("span",nn,Y(s(U)),1),p(h,{onClick:v=>a(v,U.id),trigger:"hover","hide-after-click":!1},{dropdown:x(()=>[p(M,null,{default:x(()=>[p(i,{value:`pin-${U.id}`},{default:x(()=>[S("div",sn,[p(c,{name:"pin",class:"menu-icon"}),l[1]||(l[1]=S("span",null,"置顶对话",-1))])]),_:2},1032,["value"]),p(i,{value:`rename-${U.id}`},{default:x(()=>[S("div",an,[p(c,{name:"edit",class:"menu-icon"}),l[2]||(l[2]=S("span",null,"重命名",-1))])]),_:2},1032,["value"]),p(i,{value:`delete-${U.id}`,theme:"error"},{default:x(()=>[S("div",on,[p(c,{name:"delete",class:"menu-icon"}),l[3]||(l[3]=S("span",null,"删除",-1))])]),_:2},1032,["value"])]),_:2},1024)]),default:x(()=>[p(r,{variant:"text",shape:"circle",size:"small",class:"more-btn",onClick:l[0]||(l[0]=wt(()=>{},["stop"]))},{default:x(()=>[p(c,{name:"more"})]),_:1})]),_:2},1032,["onClick"])]),_:2},1032,["onClick","class"]))),128))])}}}),ye=me(rn,[["__scopeId","data-v-edb6edd3"]]),ln={class:"sidebar-skeleton-container"},cn=ae({__name:"SidebarSkeleton",setup(e){return(n,t)=>(y(),j("div",ln,[t[2]||(t[2]=S("div",{class:"sidebar-header-skeleton"},[S("div",{class:"icon-skeleton"}),S("div",{class:"new-chat-skeleton"})],-1)),(y(),j(ee,null,se(2,(a,s)=>S("div",{key:s,class:"conversation-skeleton",style:{"--anim-delay":"calc(0.1s * (index + 2))"}},t[0]||(t[0]=[S("div",{class:"icon-skeleton small"},null,-1),S("div",{class:"content-skeleton"},[S("div",{class:"title-skeleton"}),S("div",{class:"subtitle-skeleton"})],-1)]))),64)),t[3]||(t[3]=S("div",{class:"group-title-skeleton",style:{"--anim-delay":"0.7s"}},[S("div",{class:"title-line"})],-1)),(y(),j(ee,null,se(1,(a,s)=>S("div",{key:`second-${s}`,class:"conversation-skeleton",style:{"--anim-delay":"calc(0.7s + 0.1s * (index + 1))"}},t[1]||(t[1]=[S("div",{class:"icon-skeleton small"},null,-1),S("div",{class:"content-skeleton"},[S("div",{class:"title-skeleton"}),S("div",{class:"subtitle-skeleton"})],-1)]))),64))]))}}),un=me(cn,[["__scopeId","data-v-4ce04eb0"]]),oe={LIGHT:"light",DARK:"dark"};function Qe(e){e!==oe.LIGHT&&e!==oe.DARK&&(console.warn(`Invalid theme mode: ${e}, using default: ${oe.LIGHT}`),e=oe.LIGHT),document.documentElement.setAttribute("theme-mode",e),localStorage.setItem("theme-mode",e)}function qe(){return document.documentElement.getAttribute("theme-mode")||oe.LIGHT}function dn(){const e=localStorage.getItem("theme-mode");if(e)Qe(e);else{const n=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;Qe(n?oe.DARK:oe.LIGHT)}}const vn={class:"sidebar-container"},fn={class:"sidebar-header"},mn={class:"drawer-container"},gn={key:4,class:"loading-indicator"},pn=100,hn=ae({__name:"ConversationSidebar",props:{visible:{type:Boolean,default:!1},currentConversationId:{type:String,default:""},groupedConversations:{type:Object,default:()=>({today:[],yesterday:[],lastWeek:[],older:[]})},hasMoreConversations:{type:Boolean,default:!1},loadingMoreConversations:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1}},emits:["update:visible","select","new-conversation","load-more","rename-conversation","pin-conversation"],setup(e,{emit:n}){St();const t=e,a=w(null),s=w(!1);ce(()=>{const r=t.groupedConversations.today.length>0,i=t.groupedConversations.yesterday.length>0,M=t.groupedConversations.lastWeek.length>0,h=t.groupedConversations.older.length>0;return r||i||M||h||!t.hasMoreConversations});const o=()=>{if(!a.value||!t.hasMoreConversations||s.value||t.loadingMoreConversations)return;const r=a.value;r.scrollHeight-r.scrollTop-r.clientHeight<pn&&(s.value=!0,c("load-more"),setTimeout(()=>{s.value=!1},1e3))},l=w(qe());we(()=>{l.value=qe()});const c=n;return(r,i)=>{const M=I("t-icon"),h=I("t-button"),k=I("t-loading"),U=I("t-list");return y(),j(ee,null,[p(le,{name:"sidebar-slide"},{default:x(()=>[bt(S("div",vn,[S("div",fn,[p(h,{variant:"text",class:"close-icon",onClick:i[0]||(i[0]=v=>r.$emit("update:visible",!1))},{default:x(()=>[p(M,{name:"menu"})]),_:1}),S("div",{onClick:i[1]||(i[1]=v=>r.$emit("new-conversation")),class:ie(["conversation-item",{active:e.currentConversationId===""}])},[i[19]||(i[19]=S("span",{class:"conversation-text"},"新对话",-1)),p(M,{name:"chat-add",class:"conversation-icon"})],2)]),S("div",mn,[i[20]||(i[20]=S("div",{class:"new-conversation-container"},null,-1)),S("div",{class:"conversations-list",ref_key:"conversationsListRef",ref:a,onScroll:o},[e.isLoading?(y(),z(un,{key:0})):(y(),z(U,{key:1},{default:x(()=>[e.groupedConversations.today.length>0?(y(),z(ye,{key:0,title:"今日",conversations:e.groupedConversations.today,"current-conversation-id":e.currentConversationId,onSelect:i[2]||(i[2]=v=>r.$emit("select",{value:v})),onPinConversation:i[3]||(i[3]=v=>r.$emit("pin-conversation",{conversationId:v})),onRenameConversation:i[4]||(i[4]=v=>r.$emit("rename-conversation",{conversationId:v})),onDeleteConversation:i[5]||(i[5]=v=>r.$emit("select",{value:`delete-${v}`}))},null,8,["conversations","current-conversation-id"])):K("",!0),e.groupedConversations.yesterday.length>0?(y(),z(ye,{key:1,title:"昨日",conversations:e.groupedConversations.yesterday,"current-conversation-id":e.currentConversationId,onSelect:i[6]||(i[6]=v=>r.$emit("select",{value:v})),onPinConversation:i[7]||(i[7]=v=>r.$emit("pin-conversation",{conversationId:v})),onRenameConversation:i[8]||(i[8]=v=>r.$emit("rename-conversation",{conversationId:v})),onDeleteConversation:i[9]||(i[9]=v=>r.$emit("select",{value:`delete-${v}`}))},null,8,["conversations","current-conversation-id"])):K("",!0),e.groupedConversations.lastWeek.length>0?(y(),z(ye,{key:2,title:"过去7天",conversations:e.groupedConversations.lastWeek,"current-conversation-id":e.currentConversationId,onSelect:i[10]||(i[10]=v=>r.$emit("select",{value:v})),onPinConversation:i[11]||(i[11]=v=>r.$emit("pin-conversation",{conversationId:v})),onRenameConversation:i[12]||(i[12]=v=>r.$emit("rename-conversation",{conversationId:v})),onDeleteConversation:i[13]||(i[13]=v=>r.$emit("select",{value:`delete-${v}`}))},null,8,["conversations","current-conversation-id"])):K("",!0),e.groupedConversations.older.length>0?(y(),z(ye,{key:3,title:"更早",conversations:e.groupedConversations.older,"current-conversation-id":e.currentConversationId,onSelect:i[14]||(i[14]=v=>r.$emit("select",{value:v})),onPinConversation:i[15]||(i[15]=v=>r.$emit("pin-conversation",{conversationId:v})),onRenameConversation:i[16]||(i[16]=v=>r.$emit("rename-conversation",{conversationId:v})),onDeleteConversation:i[17]||(i[17]=v=>r.$emit("select",{value:`delete-${v}`}))},null,8,["conversations","current-conversation-id"])):K("",!0),e.loadingMoreConversations?(y(),j("div",gn,[p(k,{size:"small"})])):K("",!0)]),_:1}))],544)])],512),[[Ct,e.visible]])]),_:1}),p(le,{name:"fade"},{default:x(()=>[e.visible?(y(),j("div",{key:0,class:"sidebar-overlay",onClick:i[18]||(i[18]=v=>r.$emit("update:visible",!1))})):K("",!0)]),_:1})],64)}}}),yn=me(hn,[["__scopeId","data-v-6d1633d6"]]),An={__name:"ChatAction",props:{isGood:{type:Boolean,default:!1},isBad:{type:Boolean,default:!1},content:{type:String,default:""}},emits:["operation"],setup(e,{emit:n}){const t=e,a=n,s=w(t.isGood),o=w(t.isBad),l=(c,r)=>{c==="good"?(s.value=!s.value,o.value=!1,console.log("good")):c==="bad"?(o.value=!o.value,s.value=!1,console.log("bad")):c==="replay"?(console.log("replay"),a("operation",c,r)):c==="copy"&&console.log("copy")};return(c,r)=>{const i=I("t-chat-action");return y(),z(i,{class:"chat-action","is-good":s.value,"is-bad":o.value,content:e.content,"operation-btn":["good","bad","replay","copy"],onOperation:l},null,8,["is-good","is-bad","content"])}}},wn={key:0,class:"step-loading"},bn={class:"loading-dots"},Cn={key:1},Sn={key:1,class:"reasoning-header"},kn={key:3,class:"message-files"},_n={class:"files-scroll-container"},Tn={class:"file-name"},xn={class:"loading-space"},Rn={__name:"ChatItem",props:{avatar:{type:String,default:""},name:{type:String,default:""},role:{type:String,default:"user"},datetime:{type:String,default:""},content:{type:String,default:""},reasoning:{type:String,default:""},isFirstMessage:{type:Boolean,default:!1},loading:{type:Boolean,default:!1},firstTokenReceived:{type:Boolean,default:!1},isStreamLoad:{type:Boolean,default:!1},isGood:{type:Boolean,default:!1},isBad:{type:Boolean,default:!1},files:{type:Array,default:()=>[]},workflowSteps:{type:Array,default:()=>[]}},emits:["reasoning-expand-change","operation"],setup(e,{emit:n}){const t=e,a=n,s=(A,f)=>{a("operation",A,f)},o=w("default"),l=w(1);let c=null;we(()=>{c=setInterval(()=>{l.value=l.value%6+1},100)}),Je(()=>{c&&clearInterval(c)});const r=ce(()=>t.workflowSteps&&t.workflowSteps.length>0&&!t.workflowSteps.some(A=>A.loading)),i={document:"file-excel",image:"photo",audio:"play-circle",video:"play-circle-stroke",custom:"file"},M=A=>i[A]||"file",h={default:"check-circle-filled",start:"play-circle-filled",http:"link",condition:"swap",time:"time",search:"search",extract:"filter",web:"internet",file:"file",model:"root-list",reply:"chat",error:"error-circle"},k={default:"primary",start:"primary",error:"error",condition:"warning",model:"success",reply:"success"},U=A=>h[A]||h.default,v=A=>k[A]||"primary",O=(A,f)=>{const b=`var(--td-${v(A)}-color)`,_=U(A);return()=>p(I("t-icon"),{name:_,size:"medium",color:b},null)},G=()=>"......".substring(0,l.value),m=A=>{if(!A)return"";if(A.length<=10)return A;const f=A.lastIndexOf(".");if(f===-1)return A.slice(0,7)+"...";const b=A.slice(f),_=A.slice(0,f);return _.length<=7?A:_.slice(0,7)+"..."+b},T=A=>{const f=A[A.length-1];return A.some(_=>_.loading)?p("div",{class:"workflow-header"},[p(I("t-icon"),{name:U(f.node_type),color:`var(--td-${v(f.node_type)}-color)`},null),p("span",null,[f.title+G()])]):p("div",{class:"workflow-header"},[p(I("t-icon"),{name:U(f.node_type),color:`var(--td-${v(f.node_type)}-color)`},null),p("span",null,[Oe("执行过程")])])};return(A,f)=>{const b=I("t-timeline-item"),_=I("t-timeline"),F=I("t-collapse-panel"),D=I("t-collapse"),P=I("t-chat-loading"),C=I("t-icon"),$=I("t-chat-content"),L=I("t-chat-reasoning"),W=I("t-tag"),Z=I("t-space"),V=I("t-chat-item");return y(),z(V,{avatar:e.avatar,name:e.name,role:e.role,datetime:e.datetime,content:e.content},kt({content:x(()=>[e.role==="assistant"&&e.workflowSteps&&e.workflowSteps.length>0?(y(),z(D,{key:0,"expand-icon":null,borderless:!0,"default-expand-all":r.value,class:"transparent-collapse"},{default:x(()=>[p(F,{value:"0",header:T(e.workflowSteps)},{default:x(()=>[p(_,{mode:"same",theme:o.value,class:"workflow-timeline"},{default:x(()=>[(y(!0),j(ee,null,se(e.workflowSteps,(B,R)=>(y(),z(b,{key:R,content:B.title,dot:O(B.node_type,B.loading),"dot-color":v(B.node_type)},{default:x(()=>[B.loading?(y(),j("div",wn,[S("span",null,Y(B.title),1),S("span",bn,Y(G()),1)])):B.content?(y(),j("div",Cn,Y(B.content),1)):K("",!0)]),_:2},1032,["content","dot","dot-color"]))),128))]),_:1},8,["theme"])]),_:1},8,["header"])]),_:1},8,["default-expand-all"])):K("",!0),e.reasoning&&e.reasoning.trim()&&e.role==="assistant"&&e.reasoning!=="思考中..."?(y(),z(L,{key:1,"expand-icon-placement":"right",onExpandChange:f[0]||(f[0]=B=>A.$emit("reasoning-expand-change",B))},{header:x(()=>[e.isFirstMessage&&e.loading?(y(),z(P,{key:0,text:"思考中...",indicator:""})):(y(),j("div",Sn,[p(C,{name:"dart-board"}),f[1]||(f[1]=S("span",null,"思考过程",-1))]))]),default:x(()=>[p($,{content:e.reasoning||""},null,8,["content"])]),_:1})):K("",!0),e.content&&e.content.trim().length>0?(y(),z($,{key:2,content:e.content,class:"zero-margins"},null,8,["content"])):K("",!0),e.files&&e.files.length>0?(y(),j("div",kn,[S("div",_n,[(y(!0),j(ee,null,se(e.files,(B,R)=>(y(),z(W,{key:R,theme:"default",variant:"light",shape:"round",size:"medium",class:"file-tag"},{default:x(()=>[p(C,{name:M(B.type),class:"file-icon",size:"240"},null,8,["name"]),S("span",Tn,Y(m(B.filename)),1)]),_:2},1024))),128))])])):K("",!0)]),actions:x(()=>[!e.isStreamLoad&&e.role==="assistant"?(y(),z(An,{key:0,class:"chat-actions-container","is-good":e.isGood,"is-bad":e.isBad,content:e.content||"",onOperation:s},null,8,["is-good","is-bad","content"])):K("",!0)]),_:2},[e.isFirstMessage&&e.loading&&!e.firstTokenReceived?{name:"content",fn:x(()=>[S("div",xn,[p(Z,null,{default:x(()=>[p(P,{animation:"moving",text:"思考中..."})]),_:1})])]),key:"0"}:void 0]),1032,["avatar","name","role","datetime","content"])}}},In="data:image/jpeg;base64,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",Mn={class:"welcome-panel animate-fade-in"},Fn=ae({__name:"WelcomePanel",props:{suggestedQuestions:{type:Array,default:()=>["解释一下量子计算的基本原理","帮我生成一个简单的Vue组件","总结一下最新的AI技术发展","如何优化前端性能？","推荐几本机器学习的入门书籍"]},logoSrc:{type:String,default:"/static/files/favicon.jpg"}},emits:["question-click"],setup(e,{emit:n}){return(t,a)=>(y(),j("div",Mn,a[0]||(a[0]=[Ge('<div class="welcome-header" data-v-bbee9f45><div class="logo-container" data-v-bbee9f45><img src="'+In+'" alt="Logo" class="welcome-logo" data-v-bbee9f45></div><h1 class="welcome-title" data-v-bbee9f45>作文评分 AI 智能体</h1><p class="welcome-subtitle" data-v-bbee9f45>输入作文题目和内容，我会为你打分、指出亮点和不足，还会给出实用建议，帮你写得更好！</p></div>',1)])))}}),Ln=me(Fn,[["__scopeId","data-v-bbee9f45"]]),Bn={class:"chat-skeleton-container"},Un=ae({__name:"ChatSkeleton",setup(e){return(n,t)=>(y(),j("div",Bn,t[0]||(t[0]=[Ge('<div class="message-skeleton user-message" style="--anim-delay:0.1s;" data-v-9ee0cab7><div class="avatar-skeleton" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line" data-v-9ee0cab7></div><div class="line short" data-v-9ee0cab7></div></div></div></div><div class="message-skeleton assistant-message" style="--anim-delay:0.2s;" data-v-9ee0cab7><div class="avatar-skeleton assistant" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line" data-v-9ee0cab7></div><div class="line" data-v-9ee0cab7></div><div class="line medium" data-v-9ee0cab7></div><div class="line long" data-v-9ee0cab7></div><div class="line medium" data-v-9ee0cab7></div></div></div></div><div class="message-skeleton user-message" style="--anim-delay:0.3s;" data-v-9ee0cab7><div class="avatar-skeleton" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line medium" data-v-9ee0cab7></div><div class="line short" data-v-9ee0cab7></div></div></div></div><div class="message-skeleton assistant-message" style="--anim-delay:0.4s;" data-v-9ee0cab7><div class="avatar-skeleton assistant" data-v-9ee0cab7></div><div class="content-wrapper" data-v-9ee0cab7><div class="header-skeleton" data-v-9ee0cab7><div class="name-skeleton" data-v-9ee0cab7></div><div class="time-skeleton" data-v-9ee0cab7></div></div><div class="content-skeleton" data-v-9ee0cab7><div class="line" data-v-9ee0cab7></div><div class="line long" data-v-9ee0cab7></div><div class="line" data-v-9ee0cab7></div><div class="line short" data-v-9ee0cab7></div></div></div></div>',4)])))}}),Dn=me(Un,[["__scopeId","data-v-9ee0cab7"]]),$n=()=>{const e=new AbortController,n=e.signal;return{controller:e,signal:n,abortRequest:()=>{if(e.signal.aborted)console.log("请求已经被中断，不再重复执行");else try{console.log("执行请求中断操作"),e.abort(),console.log("请求中断完成")}catch(a){console.error("中断请求时出错:",a)}}}},En=(e,n)=>{const{loading:t,isStreamLoad:a}=n;t&&typeof t.value<"u"&&(t.value=!1),a&&typeof a.value<"u"&&(a.value=!1),e&&e.role==="assistant"&&(!e.content||e.content===""?e.content="回复已中断":e.content.includes("[已中断]")||(e.content+=" [已中断]"),e.reasoning==="思考中..."?e.reasoning="思考过程已中断":e.reasoning&&!e.reasoning.includes("已中断")&&(e.reasoning+=" [已中断]"))},Pn=async(e,n)=>{if(!e||!n)return console.error("[Stream Stop] 停止响应失败: taskId或userId不能为空",{taskId:e,userId:n}),!1;console.log("[Stream Stop] 尝试停止流式响应",{taskId:e,userId:n});try{const t=E.baseURL,a=E.apiKey;console.log("[Stream Stop] 发送停止请求到:",`${t}/chat-messages/${e}/stop`);const s=await fetch(`${t}/chat-messages/${e}/stop`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({user:n})}),o=await s.json();return s.ok?(console.log("[Stream Stop] 流式响应已成功停止",{status:s.status,result:o}),!0):(console.error("[Stream Stop] 停止响应请求失败:",{status:s.status,result:o}),!1)}catch(t){return console.error("[Stream Stop] 停止响应请求错误:",t),!1}};function jn(){return{handleReasoningUpdate:(s,o,l)=>{l.value||(l.value=!0);try{!s.reasoning||s.reasoning==="思考中..."?s.reasoning=o||"":s.reasoning+=o||""}catch(c){console.error("处理思考内容出错:",c)}},handleMessageUpdate:(s,o,l,c,r,i)=>{l.value||(l.value=!0);try{s.content?s.content+=o||"":s.content=o||"",o&&!c.value&&setTimeout(()=>{i.value&&r(i.value,!0)},10)}catch(M){console.error("处理消息内容出错:",M)}},handleFileEvent:(s,o)=>{try{s.files||(s.files=[]),s.files.push(o)}catch(l){console.error("处理文件事件出错:",l)}},handleWorkflowSteps:(s,o,l,c)=>{if(c.value=!0,o.value.length>0){const r=o.value[0];r.role==="assistant"&&l.value&&(r.workflowSteps=s,console.log("收到工作流步骤:",s.map(i=>`${i.title}(${i.node_type})${i.loading?"[加载中]":""}`)))}}}}const ze=(e,n=20)=>e?e.name?e.name.length>n?e.name.substring(0,n)+"...":e.name:e.last_message&&e.last_message.trim()?e.last_message.length>n?e.last_message.substring(0,n)+"...":e.last_message:`对话 ${e.id.substring(0,8)}...`:"新对话",Qn=e=>{const n=new Date;n.setHours(0,0,0,0);const t=new Date(n);t.setDate(t.getDate()-1);const a=new Date(n);a.setDate(a.getDate()-7);const s={today:[],yesterday:[],lastWeek:[],older:[]};return e.forEach(o=>{let l;o.updated_at?l=new Date(o.updated_at*1e3):l=new Date;const c=new Date(l);c.setHours(0,0,0,0),c.getTime()===n.getTime()?s.today.push(o):c.getTime()===t.getTime()?s.yesterday.push(o):c.getTime()>=a.getTime()?s.lastWeek.push(o):s.older.push(o)}),s},xe=(e,n)=>{let t=null;return function(...a){t&&clearTimeout(t),t=setTimeout(()=>{e.apply(null,a),t=null},n)}},Ae=({currentConversationId:e,chatList:n,suggestedQuestions:t,suggestedQuestionsConversationId:a,isNewConversation:s,resetConversationFunc:o})=>{o(),e.value="",n.value=[],t.value=[],a.value="",s&&(s.value=!0)},qn={class:"app-container"},zn={class:"chat-wrapper"},Jn={key:0,class:"suggested-questions-container"},On={class:"suggested-questions"},Gn=50,Wn=ae({__name:"index",setup(e){const n=w(null),t=w(!1),a=w(!1),s=w(!1),o=w(!1),l=w(null),c=w(!1),r=w([]),i=w(""),M=w(!1),h=w([]),k=w(""),U=w(1),v=w(20),O=w(!0),G=w(!1),m=w(!1),T=w(!0),A=w(!1),f=w(!0),b=w(!1),_=w(""),F=w(""),D=w(!1),P=w(""),C=w(null),$=w(""),L=w([]),W=w(""),Z=w(null),V=w(null),B=w(!1),R=w(!0),Ke=w(["介绍一下金钟集团","金钟集团有哪些产品","金钟集团的优势"]),Re=new URLSearchParams(window.location.search),Ie=Re.get("userId"),Ze=Re.get("userName");console.log("从URL获取的参数:",{userId:Ie,userName:Ze}),we(()=>{dn(),document.documentElement.setAttribute("theme-mode","light"),Me()});const Ne=ce(()=>{const d=h.value.find(u=>u.id===k.value);return ze(d,15)}),Ve=ce(()=>Qn(h.value)),Me=async()=>{try{i.value=await zt()}catch(d){console.error("系统提示词加载失败:",d)}m.value=!0;try{const d=await fe({limit:20,sort_by:"-updated_at"});if(d&&Array.isArray(d)){h.value=d,T.value=d.length>=20;const u=await $t();u?(k.value=u,R.value=!1,await Ce(u)):(k.value="",r.value=[],R.value=!0,B.value=!1),d.length===0&&(k.value="",r.value=[],R.value=!0,B.value=!1)}else console.error("服务器返回的会话列表数据格式不正确:",d),k.value="",r.value=[],R.value=!0,B.value=!1}catch(d){console.error("获取服务器会话列表失败:",d),k.value="",r.value=[],R.value=!0,B.value=!1}finally{m.value=!1}},Ce=async(d,u=!0,g=null)=>{if(!d)return console.error("会话ID为空，无法加载历史消息"),!1;try{G.value=!u,u&&(B.value=!0),u&&(L.value=[]),u&&(U.value=1,O.value=!0,r.value=[]);const J={page:U.value,pageSize:v.value,signal:g},N=await We(d,J);if(g!=null&&g.aborted||d!==k.value)return console.log("加载请求已中断或会话已切换，不更新UI"),!1;if(N.length>0){if(u?r.value=N:r.value=[...N,...r.value],O.value=N.length>=v.value,u&&N.length>0){const te=N.filter(Q=>Q.role==="assistant"&&Q.id);if(te.length>0){const H=te[te.length-1].id.replace("_assistant","");Ue(H)}}}else u&&(r.value=[]),O.value=!1;return r.value&&Array.isArray(r.value)&&r.value.length>0,!0}catch(J){return console.error("加载对话历史消息失败:",J),O.value=!1,u&&(r.value=[]),!1}finally{G.value=!1,B.value=!1}},He=xe(async(d,u)=>{try{d===k.value&&await Ce(d,!0,u.signal)}catch(g){g.name!=="AbortError"&&console.error("加载对话内容失败:",g),B.value=!1}finally{V.value===u&&(V.value=null)}},300),Xe=async d=>{const u=d.value;if(typeof u=="string"&&u.startsWith("delete-")){const g=u.substring(7);P.value=g,D.value=!0;return}if(u==="new"){Ae({currentConversationId:k,chatList:r,suggestedQuestions:L,suggestedQuestionsConversationId:W,isNewConversation:R,resetConversationFunc:pe});return}if(u!==k.value){if(L.value=[],W.value="",k.value=u,B.value=!0,r.value=[],R.value=!1,Z.value&&clearTimeout(Z.value),V.value)try{V.value.abort(),console.log("已取消之前的对话加载请求")}catch(J){console.error("取消之前的请求失败:",J)}const g=new AbortController;V.value=g,He(u,g)}},Ye=async()=>{if(!(!O.value||!k.value||G.value))try{G.value=!0,U.value+=1,await Ce(k.value,!1)}finally{G.value=!1}},et=d=>{var g;(((g=d.detail)==null?void 0:g.scrollTop)||0)<=Gn&&O.value&&k.value&&!G.value&&Ye()},tt=(d,{index:u})=>{},nt=async function(){await Et(),Ae({currentConversationId:k,chatList:r,suggestedQuestions:L,suggestedQuestionsConversationId:W,isNewConversation:R,resetConversationFunc:pe})},st=async function(){try{if(!t.value&&!a.value){console.log("请求已经停止，不再执行中断操作");return}t.value=!1,a.value=!1,c.value=!0;const d=r.value[0];En(d,{loading:t,isStreamLoad:a});const u=n.value;n.value=null;const g=C.value;if(C.value=null,g)try{await Pn(g,Ie)}catch(J){console.error("API停止请求失败:",J)}if(u)try{u()}catch(J){console.error("中断请求时出错:",J)}}catch(d){console.error("停止请求时发生错误:",d),t.value=!1,a.value=!1,n.value=null,C.value=null}},at=function(d,u){const g=u.index;if(d==="good")s.value=!s.value,o.value=!1;else if(d==="bad")o.value=!o.value,s.value=!1;else if(d==="replay"){const J=r.value[g+1].content;Se(J)}},Se=function(d){if(a.value)return;let u="",g=[];if(typeof d=="string"?u=d:typeof d=="object"&&(u=d.message||"",g=d.files||[]),!u&&g.length===0)return;R.value=!1;const J=Lt(u,g);r.value.unshift(J);const N=Bt(!0);r.value.unshift(N),ot(u,g)},ot=async(d,u=[])=>{var De;t.value=!0,a.value=!0,c.value=!1,C.value=null,$.value=null;const g=r.value[0],{handleReasoningUpdate:J,handleMessageUpdate:N,handleFileEvent:te,handleWorkflowSteps:Q}=jn(),H=((De=r.value[1])==null?void 0:De.role)==="user"?r.value[1].content:d,re=Ft(r.value,H,i.value),{signal:ke,abortRequest:ht}=$n();n.value=ht;try{const de={signal:ke,conversation_id:k.value||"",files:u.length>0?u:void 0};await qt(re,{onReasoning:q=>{!t.value||!a.value||J(g,q,c)},onMessage:q=>{!t.value||!a.value||N(g,q,c,M,Pe,l)},onFileEvent:q=>{!t.value||!a.value||te(g,q)},onError:q=>{console.error("API请求出错:",q),X.error(q||"请求出错"),t.value=!1,a.value=!1,g.loading=!1,g.isStreamLoad=!1,g.content=`请求失败: ${q}`},onComplete:(q,_e)=>{console.log("请求完成, 成功:",q,_e),t.value=!1,a.value=!1,g&&(g.loading=!1,g.isStreamLoad=!1),q?k.value&&Ut(k.value,{messages:r.value,onComplete:ve=>{if(!ve){console.log("自动重命名完成，但未返回标题");return}console.log("自动重命名完成，新标题:",ve),h.value=h.value.map(Te=>Te.id===k.value?{...Te,name:ve}:Te)}}).catch(ve=>{console.error("自动重命名过程出错:",ve)}):(console.warn("请求未成功完成:",_e),g&&(g.content||(g.content=`请求未完成: ${_e||"未知原因"}`))),xt(()=>{l.value&&Pe(l.value,!0)})},onConversationIdChange:q=>{console.log("会话ID更新:",q),q&&q!==k.value&&(k.value=q,mt())},onMessageIdChange:q=>{$.value=q,q&&g&&g.role==="assistant"&&ft(q)},onTaskIdChange:q=>{C.value=q},onWorkflowSteps:q=>{Q(q,r,t,c)}},de)}catch(de){console.error("聊天请求失败:",de),t.value=!1,a.value=!1,g&&(g.loading=!1,g.isStreamLoad=!1,g.content=`聊天请求失败: ${de.message||"未知错误"}`),X.error("聊天请求失败: "+(de.message||"未知错误"))}},rt=async()=>{if(!(!T.value||A.value))try{A.value=!0;const d=h.value.length>0?h.value[h.value.length-1].id:null;if(!d){T.value=!1;return}const u=await fe({last_id:d,limit:20,sort_by:"-updated_at"});u&&Array.isArray(u)&&u.length>0?(h.value=[...h.value,...u],T.value=u.length>=20):T.value=!1}catch(d){console.error("加载更多会话失败:",d)}finally{A.value=!1}},Fe=()=>{Ae({currentConversationId:k,chatList:r,suggestedQuestions:L,suggestedQuestionsConversationId:W,isNewConversation:R,resetConversationFunc:pe})},lt=async({conversationId:d,name:u})=>{try{const g=await ne(d,{name:u});h.value=h.value.map(J=>J.id===d?{...J,name:g.name||u}:J)}catch(g){console.error("重命名对话失败:",g)}},it=({conversationId:d})=>{const u=h.value.find(g=>g.id===d);u&&(h.value=h.value.filter(g=>g.id!==d),h.value.unshift(u))},ct=({conversationId:d})=>{F.value=d;const u=h.value.find(g=>g.id===d);u&&(_.value=u.name||ze(u,100)),b.value=!0},Le=()=>{F.value&&_.value.trim()&&lt({conversationId:F.value,name:_.value.trim()}),b.value=!1,_.value="",F.value=""},ut=()=>{b.value=!1,_.value="",F.value=""},dt=async()=>{if(!P.value){D.value=!1;return}try{const d=await Dt(P.value);h.value=h.value.filter(u=>u.id!==P.value),k.value===P.value&&Ae({currentConversationId:k,chatList:r,suggestedQuestions:L,suggestedQuestionsConversationId:W,isNewConversation:R,resetConversationFunc:pe})}catch(d){console.error("删除对话失败:",d)}finally{D.value=!1,P.value=""}},vt=()=>{D.value=!1,P.value=""},Be=d=>{Se(d),L.value=[],W.value=""},Ue=async d=>{if(d)try{const u=await Pt(d);u&&Array.isArray(u)&&u.length>0?(L.value=u,W.value=k.value):L.value=[]}catch(u){console.error("获取建议问题失败:",u),L.value=[]}},ft=xe(d=>{Ue(d)},300),mt=xe(async()=>{try{const d=await fe({limit:20,sort_by:"-updated_at"});d&&Array.isArray(d)&&(h.value=d,T.value=d.length>=20)}catch(d){console.error("刷新会话列表失败:",d)}},500),gt=()=>{f.value=!f.value};Je(()=>{Z.value&&clearTimeout(Z.value),V.value&&V.value.abort()});const pt=d=>{console.log("模型已切换，立即显示加载状态并准备加载新数据:",d),B.value=!0,m.value=!0,r.value=[],L.value=[],W.value="",Me()};return(d,u)=>{const g=I("t-tag"),J=I("t-chat"),N=I("t-input"),te=I("t-dialog");return y(),j("div",qn,[p(yn,{visible:f.value,"onUpdate:visible":u[0]||(u[0]=Q=>f.value=Q),"current-conversation-id":k.value,"grouped-conversations":Ve.value,"has-more-conversations":T.value,"loading-more-conversations":A.value,"is-loading":m.value,onSelect:Xe,onNewConversation:Fe,onLoadMore:rt,onRenameConversation:ct,onPinConversation:it},null,8,["visible","current-conversation-id","grouped-conversations","has-more-conversations","loading-more-conversations","is-loading"]),S("div",{class:ie(["main-content",{"sidebar-open":f.value,"sidebar-closed":!f.value}])},[p(Yt,{title:Ne.value,"sidebar-visible":f.value,onOpenDrawer:gt,onNewConversation:Fe,onModelChanged:pt},null,8,["title","sidebar-visible"]),S("div",zn,[p(le,{name:"fade"},{default:x(()=>[p(J,{class:"chat-container",ref_key:"chatRef",ref:l,layout:"both","clear-history":!1,onClear:nt,onScroll:et},{footer:x(()=>[p(le,{name:"suggestions-slide"},{default:x(()=>[L.value.length>0?(y(),j("div",Jn,[S("div",On,[(y(!0),j(ee,null,se(L.value,(Q,H)=>(y(),z(g,{key:H,theme:"primary",variant:"light",class:"question-tag",size:"medium",onClick:re=>Be(Q)},{default:x(()=>[Oe(Y(Q),1)]),_:2},1032,["onClick"]))),128))])])):K("",!0)]),_:1}),p(Vt,{loading:t.value,onSend:Se,onStop:st},null,8,["loading"])]),default:x(()=>[B.value?(y(),z(le,{key:0,name:"skeleton-fade",appear:""},{default:x(()=>[p(Dn)]),_:1})):r.value.length>0?(y(),z(Tt,{key:1,name:"chat-items",appear:""},{default:x(()=>[(y(!0),j(ee,null,se(r.value,(Q,H)=>(y(),z(Rn,{key:H,avatar:Q.avatar,name:Q.name,role:Q.role,datetime:Q.datetime,content:Q.content,reasoning:Q.reasoning,"is-first-message":H===0,loading:t.value,"first-token-received":c.value,"is-stream-load":a.value,"is-good":s.value,"is-bad":o.value,files:Q.files,"workflow-steps":Q.workflowSteps,style:_t({"--item-index":r.value.length-H}),onReasoningExpandChange:re=>tt(re,{index:H}),onOperation:(re,ke)=>at(re,{index:H,e:ke})},null,8,["avatar","name","role","datetime","content","reasoning","is-first-message","loading","first-token-received","is-stream-load","is-good","is-bad","files","workflow-steps","style","onReasoningExpandChange","onOperation"]))),128))]),_:1})):R.value?(y(),z(le,{key:2,name:"welcome-fade",appear:""},{default:x(()=>[p(Ln,{"suggested-questions":Ke.value,logoSrc:"/static/images/logo.png",onQuestionClick:Be},null,8,["suggested-questions"])]),_:1})):K("",!0)]),_:1},512)]),_:1})])],2),p(te,{width:"35%",visible:b.value,"onUpdate:visible":u[2]||(u[2]=Q=>b.value=Q),header:"重命名对话","confirm-btn":{content:"确定",theme:"primary"},"cancel-btn":{content:"取消",theme:"default"},onConfirm:Le,onClose:ut},{default:x(()=>[p(N,{modelValue:_.value,"onUpdate:modelValue":u[1]||(u[1]=Q=>_.value=Q),type:"text",maxlength:100,placeholder:"请输入新名称",clearable:"",autofocus:"",onEnter:Le},null,8,["modelValue"])]),_:1},8,["visible"]),p(te,{width:"35%",visible:D.value,"onUpdate:visible":u[3]||(u[3]=Q=>D.value=Q),header:"删除对话","confirm-btn":{content:"确定",theme:"danger"},"cancel-btn":{content:"取消",theme:"default"},onConfirm:dt,onClose:vt},{default:x(()=>u[4]||(u[4]=[S("p",{class:"dialog-content"},"确定要删除该对话吗？此操作不可恢复。",-1)])),_:1},8,["visible"])])}}}),Nn=Object.freeze(Object.defineProperty({__proto__:null,default:Wn},Symbol.toStringTag,{value:"Module"}));export{E as A,be as c,Nn as i};
//# sourceMappingURL=index.CVlgzEMh.js.map
